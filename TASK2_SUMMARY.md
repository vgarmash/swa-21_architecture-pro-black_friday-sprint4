# –ó–∞–¥–∞–Ω–∏–µ 2: –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ - –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞

> üìã –ß–µ–∫-–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç  
> üè† [‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ README](README.md)

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω `compose.yaml`

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–º—è –ø—Ä–æ–µ–∫—Ç–∞: `name: mongo-sharding`
- ‚úÖ –°–æ–∑–¥–∞–Ω–æ 3 Config Servers (configSrv1, configSrv2, configSrv3)
- ‚úÖ –°–æ–∑–¥–∞–Ω–æ 2 Shards (shard1, shard2)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω Mongos Router
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ pymongo-api –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å mongos
- ‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–≤—è–∑–∞–Ω—ã —á–µ—Ä–µ–∑ depends_on

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –°—Ö–µ–º–µ 1** –∏–∑ [PLANNING.md](PLANNING.md)

### 2. –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

**–§–∞–π–ª:** `scripts/init-sharding.sh`

–°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
- ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Config Server Replica Set
- ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Shard 1 Replica Set
- ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Shard 2 Replica Set
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —à–∞—Ä–¥–æ–≤ –≤ –∫–ª–∞—Å—Ç–µ—Ä
- ‚úÖ –í–∫–ª—é—á–µ–Ω–∏–µ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ë–î `somedb`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∏ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `helloDoc`
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫—É 1000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:**
```bash
docker compose exec -T <service-name> mongosh --port <mongo port> --quiet <<EOF
<mongosh commands here>
EOF
```

### 3. –£–ª—É—á—à–µ–Ω API –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —à–∞—Ä–¥–∞—Ö

**–§–∞–π–ª:** `api_app/app.py`

–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ JSON –æ—Ç–≤–µ—Ç:
- ‚úÖ `mongo_topology_type` - —Ç–∏–ø —Ç–æ–ø–æ–ª–æ–≥–∏–∏ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "Sharded")
- ‚úÖ `mongo_is_mongos` - —Ñ–ª–∞–≥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ mongos
- ‚úÖ `shards` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —à–∞—Ä–¥–æ–≤ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
- ‚úÖ `shard_distribution` - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ —à–∞—Ä–¥–∞–º
  - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–∞–∂–¥–æ–º —à–∞—Ä–¥–µ
  - –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –≤ –∫–∞–∂–¥–æ–º —à–∞—Ä–¥–µ

### 4. –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### [SHARDING_SETUP.md](SHARDING_SETUP.md)
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
- ‚úÖ –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (8 —à–∞–≥–æ–≤ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
- ‚úÖ –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫
- ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

#### [TESTING.md](TESTING.md)
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (5 –º–∏–Ω—É—Ç)
- ‚úÖ 10 –≤–∏–¥–æ–≤ –ø—Ä–æ–≤–µ—Ä–æ–∫
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### [QUICKSTART.md](QUICKSTART.md)
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
- ‚úÖ –¢—Ä–∏ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Å—Ç–∞—Ä—Ç–∞
- ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º —Ä–µ–≤—å—é–µ—Ä–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 1: –ü—Ä–æ–µ–∫—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
```bash
docker compose up -d
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–ø—É—Å–∫–∞—é—Ç—Å—è 7 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
```bash
./scripts/init-sharding.sh
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ —à–∞–≥–∏

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 3: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```bash
curl http://localhost:8080 | jq '.collections.helloDoc.documents_count'
```
**–û–∂–∏–¥–∞–µ—Ç—Å—è:** `1000` –∏–ª–∏ –±–æ–ª—å—à–µ  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 4: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–∞–∂–¥–æ–º —à–∞—Ä–¥–µ
```bash
curl http://localhost:8080 | jq '.shard_distribution.helloDoc'
```
**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```json
{
  "shard1ReplSet": { "count": 500, "size": 45000 },
  "shard2ReplSet": { "count": 500, "size": 45000 }
}
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

### –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# 1. –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞
docker compose up -d
# ‚úÖ –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ —Å—Ç–∞—Ç—É—Å–µ "running"

# 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
./scripts/init-sharding.sh
# ‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ topology
curl -s http://localhost:8080 | jq '.mongo_topology_type'
# ‚úÖ –í—ã–≤–æ–¥: "Sharded"

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ mongos
curl -s http://localhost:8080 | jq '.mongo_is_mongos'
# ‚úÖ –í—ã–≤–æ–¥: true

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
curl -s http://localhost:8080 | jq '.collections.helloDoc.documents_count'
# ‚úÖ –í—ã–≤–æ–¥: 1000 –∏–ª–∏ –±–æ–ª—å—à–µ

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —à–∞—Ä–¥–æ–≤
curl -s http://localhost:8080 | jq '.shards | keys'
# ‚úÖ –í—ã–≤–æ–¥: ["shard1ReplSet", "shard2ReplSet"]

# 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
curl -s http://localhost:8080 | jq '.shard_distribution.helloDoc | keys'
# ‚úÖ –í—ã–≤–æ–¥: ["shard1ReplSet", "shard2ReplSet"]

# 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ shard1
curl -s http://localhost:8080 | jq '.shard_distribution.helloDoc.shard1ReplSet.count'
# ‚úÖ –í—ã–≤–æ–¥: —á–∏—Å–ª–æ (–ø—Ä–∏–º–µ—Ä–Ω–æ 500)

# 9. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ shard2
curl -s http://localhost:8080 | jq '.shard_distribution.helloDoc.shard2ReplSet.count'
# ‚úÖ –í—ã–≤–æ–¥: —á–∏—Å–ª–æ (–ø—Ä–∏–º–µ—Ä–Ω–æ 500)

# 10. –°—É–º–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —à–∞—Ä–¥–∞—Ö
docker compose exec -T shard1 mongosh --port 27018 --quiet <<EOF
use somedb
db.helloDoc.countDocuments()
EOF
docker compose exec -T shard2 mongosh --port 27018 --quiet <<EOF
use somedb
db.helloDoc.countDocuments()
EOF
# ‚úÖ –°—É–º–º–∞ ‚âà 1000
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞

```
mongodb-sharding-optimization/
‚îú‚îÄ‚îÄ compose.yaml                 # ‚úÖ –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –¥–ª—è —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ api_app/app.py              # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —à–∞—Ä–¥–æ–≤
‚îú‚îÄ‚îÄ scripts/init-sharding.sh    # ‚úÖ –ù–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
‚îî‚îÄ‚îÄ SHARDING_SETUP.md           # ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
```

## –ü–æ—Ä—Ç—ã

| –°–µ—Ä–≤–∏—Å | –ü–æ—Ä—Ç | –î–æ—Å—Ç—É–ø |
|--------|------|--------|
| pymongo-api | 8080 | –í–Ω–µ—à–Ω–∏–π |
| mongos | 27017 | –í–Ω–µ—à–Ω–∏–π |
| config servers | 27019 | –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π |
| shards | 27018 | –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π |

## –ë–î –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏

- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** `somedb`
- **–ö–æ–ª–ª–µ–∫—Ü–∏—è:** `helloDoc`
- **Shard Key:** `{ _id: "hashed" }` –¥–ª—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:** ‚â• 1000
- **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–µ–∂–¥—É shard1 –∏ shard2

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ó–∞–¥–∞–Ω–∏—è 2, –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫:
- üìñ [–ó–∞–¥–∞–Ω–∏–µ 3: –†–µ–ø–ª–∏–∫–∞—Ü–∏—è](REPLICATION_SETUP.md)
- üìä [–°—Ö–µ–º–∞ 2: –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ + –†–µ–ø–ª–∏–∫–∞—Ü–∏—è](diagrams/ARCHITECTURE.md)

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- üè† [–ì–ª–∞–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](README.md)
- ‚öôÔ∏è [–ü–æ–¥—Ä–æ–±–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è](SHARDING_SETUP.md)
- üß™ [–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ](TESTING.md)
- ‚ö° [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](QUICKSTART.md)
- üìñ [–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](PLANNING.md)

