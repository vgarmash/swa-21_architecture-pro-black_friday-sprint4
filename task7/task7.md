# Задание 7. Проектирование схем коллекций для шардирования данных

## Анализ требований

Интернет-магазин "Мобильный мир" работает с тремя основными коллекциями:
- **products** - каталог товаров с остатками по геозонам
- **orders** - заказы клиентов с привязкой к геозонам
- **carts** - корзины пользователей и гостей

Ключевые факторы для выбора стратегии шардирования:
1. Наличие геозон в данных (orders и products содержат информацию о геозонах)
2. Высокая частота операций записи (создание заказов, обновление остатков)
3. Необходимость быстрого доступа к данным конкретного пользователя

## 1. Коллекция `products`

### Схема коллекции

```javascript
{
  _id: ObjectId("..."),
  product_id: "PROD-12345",           // Уникальный идентификатор товара
  name: "Смартфон X",                 // Наименование
  category: "Электроника",            // Категория товара
  price: 45990.00,                    // Цена
  stock_by_zone: {                    // Остатки по геозонам
    "moscow": 120,
    "ekaterinburg": 50,
    "kaliningrad": 30,
    "novosibirsk": 75
  },
  attributes: {                       // Дополнительные атрибуты
    color: "Черный",
    size: "6.5 дюймов",
    memory: "128GB"
  },
  created_at: ISODate("2024-01-15T10:00:00Z"),
  updated_at: ISODate("2024-11-20T14:30:00Z")
}
```

### Выбор шард-ключа: `{ category: 1, _id: 1 }`

**Обоснование:**

1. **Оптимизация основной операции - поиск по категориям**
   - Согласно требованиям: "Поиск товаров по категориям и фильтрация по диапазону цен"
   - Запросы направляются на конкретный шард
   - Эффективные range-запросы в рамках категории

2. **Равномерное распределение данных**
   - Категории товаров обеспечивают естественное разделение данных
   - Добавление `_id` гарантирует уникальность и высокую кардинальность
   - Предотвращает "горячие" шарды

3. **Поддержка частых обновлений остатков**
   - MongoDB поддерживает атомарные операции обновления вложенных полей
   - Использование операторов `$inc` для изменения остатков конкретной геозоны
   - Обновление `stock_by_zone.moscow` не блокирует обновление `stock_by_zone.ekaterinburg`

### Индексы

```javascript
// Шард-ключ (создается автоматически)
db.products.createIndex({ category: 1, _id: 1 })

// Для поиска по категории и цене
db.products.createIndex({ category: 1, price: 1 })

// Для быстрого доступа по product_id
db.products.createIndex({ product_id: 1 }, { unique: true })
```

### Примеры операций с остатками

**Проверка наличия товара в геозоне:**

```javascript
db.products.findOne({
  product_id: "PROD-12345",
  "stock_by_zone.moscow": { $gt: 0 }
})
```

**Атомарное обновление остатка в конкретной геозоне:**

```javascript
// Списание товара при покупке в Москве
db.products.updateOne(
  {
    product_id: "PROD-12345",
    "stock_by_zone.moscow": { $gte: 1 }  // Проверка наличия
  },
  {
    $inc: { "stock_by_zone.moscow": -1 },
    $set: { updated_at: new Date() }
  }
)
```

**Пополнение остатков:**

```javascript
db.products.updateOne(
  { product_id: "PROD-12345" },
  {
    $inc: { "stock_by_zone.ekaterinburg": 50 },
    $set: { updated_at: new Date() }
  }
)
```



## 2. Коллекция `orders`

### Схема коллекции

```javascript
{
  _id: ObjectId("..."),
  order_id: "ORD-2024-123456",        // Уникальный идентификатор заказа
  user_id: "USER-98765",              // Идентификатор клиента
  geozone: "moscow",                  // Геозона заказа
  created_at: ISODate("2024-11-27T12:30:00Z"),
  items: [                            // Список товаров
    {
      product_id: "PROD-12345",
      name: "Смартфон X",
      category: "Электроника",
      quantity: 1,
      price: 45990.00
    },
    {
      product_id: "PROD-67890",
      name: "Книга 'MongoDB для профессионалов'",
      category: "Книги",
      quantity: 2,
      price: 1200.00
    }
  ],
  status: "processing",               // new, processing, shipped, delivered, cancelled
  total_amount: 48390.00,             // Общая сумма заказа
  shipping_address: {
    city: "Москва",
    street: "Тверская ул., д. 10",
    postal_code: "125009"
  },
  updated_at: ISODate("2024-11-27T12:35:00Z")
}
```

### Выбор шард-ключа: `{ user_id: 1, created_at: 1 }`

**Обоснование:**

1. **Оптимизация основной операции - поиск истории заказов пользователя**
   - Согласно требованиям, одна из основных операций: "Поиск истории заказов конкретного пользователя"
   - Запросы типа `{ user_id: "USER-98765" }` с сортировкой по дате будут направлены на один шард
   - Все заказы одного пользователя хранятся последовательно, что оптимизирует range-запросы

2. **Высокая кардинальность**
   - Комбинация `user_id` и `created_at` обеспечивает очень высокую кардинальность
   - Каждый заказ имеет уникальную временную метку
   - Равномерное распределение данных по шардам

3. **Поддержка операций создания заказов**
   - Быстрое создание заказов: новые заказы автоматически распределяются по шардам
   - Монотонно возрастающий `created_at` обеспечивает последовательную запись

4. **Эффективное отображение статуса заказа**
   - При наличии `user_id` и примерной даты заказа, запрос направляется на конкретный шард
   - Индекс по `order_id` обеспечивает быстрый доступ к конкретному заказу

**Альтернативные варианты:**

- **`{ user_id: "hashed" }`** - обеспечит равномерное распределение, но потеряется эффективность range-запросов по истории заказов пользователя
- **`{ geozone: 1, user_id: 1 }`** - может быть полезен, если есть требования к географической локальности данных, но в задании такие требования не указаны
- **`{ _id: "hashed" }`** - равномерное распределение, но потребует broadcast-запросов для поиска заказов пользователя

### Индексы

```javascript
// Шард-ключ (создается автоматически)
db.orders.createIndex({ user_id: 1, created_at: 1 })

// Для быстрого доступа по order_id
db.orders.createIndex({ order_id: 1 }, { unique: true })

// Для фильтрации по статусу заказов пользователя
db.orders.createIndex({ user_id: 1, status: 1, created_at: -1 })

// Для аналитики по геозонам (если потребуется)
db.orders.createIndex({ geozone: 1, created_at: -1 })
```



## 3. Коллекция `carts`

### Схема коллекции

```javascript
{
  _id: ObjectId("..."),
  user_id: "USER-98765",              // Идентификатор пользователя (null для гостей)
  session_id: "SESS-abc123def456",    // Идентификатор сессии (для гостей)
  items: [                            // Список товаров в корзине
    {
      product_id: "PROD-12345",
      quantity: 1,
      added_at: ISODate("2024-11-27T10:15:00Z")
    },
    {
      product_id: "PROD-67890",
      quantity: 2,
      added_at: ISODate("2024-11-27T10:20:00Z")
    }
  ],
  status: "active",                   // active, ordered, abandoned
  created_at: ISODate("2024-11-27T10:15:00Z"),
  updated_at: ISODate("2024-11-27T10:20:00Z"),
  expires_at: ISODate("2024-12-04T10:15:00Z")  // TTL для автоматической очистки (7 дней)
}
```

### Выбор шард-ключа: `{ user_id: 1, session_id: 1 }`

**Обоснование:**

1. **Поддержка гостевых и пользовательских корзин**
   - Для зарегистрированных пользователей: `user_id` заполнен, `session_id` может быть null
   - Для гостей: `user_id` = null, `session_id` заполнен
   - Комбинация обеспечивает уникальность и эффективный поиск

2. **Оптимизация основных операций**
   - Получение активной корзины: `{ user_id: "USER-98765", status: "active" }` или `{ session_id: "SESS-...", status: "active" }`
   - Добавление/удаление товаров направляется на один шард
   - Слияние корзин при логине эффективно

3. **Равномерное распределение**
   - Высокая кардинальность благодаря уникальным user_id и session_id
   - Предотвращает "горячие" шарды

4. **Масштабируемость**
   - Поддержка большого количества одновременных сессий
   - Эффективная работа с TTL-индексом для автоматической очистки

**Почему не `{ _id: "hashed" }`:**
- Потребует broadcast-запросов для поиска корзины по user_id или session_id
- Неэффективен для основных операций

**Почему не `{ status: 1, user_id: 1 }`:**
- Status имеет низкую кардинальность (3 значения)
- Создаст неравномерное распределение данных

### Индексы

```javascript
// Шард-ключ (создается автоматически)
db.carts.createIndex({ user_id: 1, session_id: 1 })

// Для поиска активной корзины пользователя
db.carts.createIndex({ user_id: 1, status: 1 })

// Для поиска активной корзины гостя
db.carts.createIndex({ session_id: 1, status: 1 })

// TTL индекс для автоматической очистки старых корзин
db.carts.createIndex({ expires_at: 1 }, { expireAfterSeconds: 0 })

// Для поиска заброшенных корзин
db.carts.createIndex({ status: 1, updated_at: 1 })
```



## Сравнительная таблица стратегий шардирования

| Коллекция | Шард-ключ | Стратегия | Преимущества | Недостатки |
|-----------|-----------|-----------|--------------|------------|
| **products** | `{ category: 1, _id: 1 }` | Range-based | - Эффективные range-запросы по категориям<br>- Естественная группировка товаров<br>- Хорошая кардинальность | - Возможна неравномерность при популярных категориях |
| **orders** | `{ user_id: 1, created_at: 1 }` | Range-based | - Оптимизация основной операции (история заказов пользователя)<br>- Очень высокая кардинальность<br>- Последовательное хранение заказов пользователя | - Монотонно возрастающий ключ может создавать "горячий" шард при массовых заказах |
| **carts** | `{ user_id: 1, session_id: 1 }` | Range-based | - Поддержка гостей и пользователей<br>- Высокая кардинальность<br>- Эффективное слияние корзин | - Broadcast при поиске только по статусу |



## Заключение

Предложенная архитектура шардирования обеспечивает:

1. **Равномерное распределение данных** по шардам с учетом специфики каждой коллекции

2. **Оптимизацию основных операций** за счет правильного выбора шард-ключей:
   - Поиск товаров по категориям для `products`
   - Поиск истории заказов пользователя для `orders`
   - Быстрый доступ к корзинам для `carts`

3. **Высокую кардинальность** шард-ключей, предотвращающую "горячие" шарды

4. **Масштабируемость** при росте каталога, количества пользователей и заказов

5. **Поддержку всех основных операций** из требований задания
