# Архитектурный документ

## Cхемы коллецкий

### Orders

```json
{
  "_id": ObjectId,
  "customer_id": ObjectId,,
  "created_at": ISODate,
  "items": [
    {
      "product_id": ObjectId,
      "price": <decimal>,
      "quantity": <int>
    }
  ],
  "status": "<string>",
  "total": <decimal>,
  "geozone": "<string>"
}
```

Рекомендуемый шард-ключ: `customer_id (hashed)`.

```shell
sh.shardCollection("mobile_world.orders", { "customer_id": "hashed" });
```

Основная операция поиска — история заказов конкретного пользователя. Если реализовать шардирование по `customer_id`, то запросы `db.orders.find({customer_id: X})` будут попадать на один шард, что значительно улучшит производительность.

`customer_id` имеет высокую кардинальность, поэтому хэширование распределяет заказы равномерно по шардам.
Создание заказов равномерно распределено по `customer_id` — вставки равномерны.

### Products

```json
{
  "_id": ObjectId,
  "name": "<string>",
  "category": "<string>",
  "price": <decimal>,
  "stocks": [
    {
      "geozone": "<string>",
      "quantity": <int>
    }
  ],
  "attributes": {
    "color": "<string>",
    "size": "<string>",
  }
}
```

Рекомендуемый шард-ключ: `_id (hashed)`.

```shell
sh.shardCollection("mobile_world.products", { "_id": "hashed" });
```

Хэширование `_id` равномерно распределит документы по шардам и снизит риск концентрации горячих данных на одном шарде.

Поиск товара по `_id` будет целевым. Запросы по `category` и `price` не содержат шард-ключа — они будут обработаны нескольким шардами, но их можно ускорить локальными индексами по этим полям на каждом шарде.

### Carts

```json
{
  "_id": ObjectId,
  "user_id": ObjectId,
  "session_id": "<string>",
  "items": [
    {
      "product_id": ObjectId,
      "quantity": <int>
    }
  ],
  "status": "active" | "ordered" | "abandoned",
  "created_at": ISODate,
  "updated_at": ISODate,
  "expires_at": ISODate
}
```

Рекомендуемый шард-ключ: `session_id (hashed)`.

```sh
sh.shardCollection("mobile_world.carts", { "session_id": "hashed" });
```

Доступы к корзинам бывают по `session_id` (в случае гостевого) или `user_id` (залогиненный). Нельзя одновременно иметь шард-ключ, который будет всегда присутствовать в запросах (либо `session_id`, либо `user_id`), поэтому любая попытка выбрать один из них сделает запросы по другому полю менее оптимальнымм. Ввиду большего количества операций связанных с полем `session_id`, а также особенности процесса слияния корзин, можно сделать ввывод, что гостевых документов больше чем документов от залогиненных пользователей.


## Устранение и предотвращение горячих шардов

### Метрики мониторинга
- Docs per shard (`db.collection.getShardDistribution()`).
- Chunk imbalance (`sh.status()`, balancer logs).
- Replication lag.
- Query targeting (профайлер MongoDB).
- Category hit ratio.

### Механизмы устранения
- **Balancer** — автоматическая миграция чанков.
- **Zone sharding** — распределение категорий по нескольким шардам.
- **Split chunks** — ручное деление больших чанков:

    ```js
    sh.splitAt("mobile_world.products", { category: "Electronics", _id: MinKey })
    ```

## Чтение с реплик и консистентность

| Коллекция    | Операция                                                                                      |                             Replica Pref. |                Допустимая задержка | Описание                                                                                                     |
| ------------ | --------------------------------------------------------------------------------------------- | ----------------------------------------: | ---------------------------------: | ------------------------------------------------------------------------------------------------------------ |
| **products** | Просмотр каталога / список товаров (категории, фильтры)                                       |                      `secondaryPreferred` |                             5–30 s | Read-heavy, допускает небольшое устаревание; снижает нагрузку на primary.                                    |
| **products** | Загрузка описания товара (характеристики, фото)                                               |                      `secondaryPreferred` |                             5–30 s | Статичные данные/медиа — можно обслуживать со вторичных для масштабирования.                                 |
| **products** | Проверка остатка в ходе checkout / резервирование количества                                  |                  `primary` (primary-only) |                              0–1 s | Критичная операция: риск oversell; требует актуального значения и атомарности.                               |
| **products** | Окончательное подтверждение цены при оплате                                                   |                  `primary` (primary-only) |                              0–1 s | Цена может меняться — финальная валидация должна быть на primary.                                            |
| **orders**   | Просмотр исторических заказов (старые/архивные)                                               |                               `secondary` |                            10–30 s | Архивные/исторические данные допускают устаревание; подходят для чтения со вторичных.                        |
| **orders**   | История сразу после создания (read-after-write) — пользователь ожидает видеть новый заказ     | `primary` (или causal session + majority) |                              0–1 s | Read-after-write требование: пользователь должен сразу видеть свой заказ; primary гарантирует актуальность.  |
| **orders**   | Отображение статуса заказа (в процессе обработки) — критичные обновления                      |             `primary` (primary-preferred) |                        0–1 — 1–5 s | Актуальный статус важен для UX/логистики; допускается небольшой lag при causal/majority, но в целом primary. |
| **orders**   | Фоновые отчёты / аналитика по заказам                                                         |                               `secondary` | до 30 s (и больше, если допустимо) | Бэченд-аналитика и отчёты терпят устаревание — secondary разгружает primary.                                 |
| **carts**    | Получение/обновление активной корзины (user/session) — add/remove, просмотр в реальном потоке |                  `primary` (primary-only) |                              0–1 s | Очень изменяемый объект; нужен read-after-write и отсутствие race conditions.                                |
| **carts**    | Слияние гостевой корзины в пользовательскую (merge)                                           |                  `primary` (primary-only) |                              0–1 s | Merge — конкурирующая операция; чтение/запись только на primary для корректности.                            |
| **carts**    | Фоновые сканы abandoned carts / аналитика                                                     |                               `secondary` |                            до 30 s | Аналитика и фоновые очистки могут выполняться со вторичных узлов.                                            |
