@startuml
!pragma layout smetana
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
!include p3-c4-styles.puml 

' Schema 1: MongoDB Sharding Architecture
' Horizontal scaling with 2 shards

' LAYOUT_WITH_LEGEND()

title MongoDB Sharding - Schema 1

Person(user, "User", "End user")

Container(api, "pymongo-api", "FastAPI", "Application service")

' MongoDB Router
ContainerDb(mongos, "mongos", "MongoDB Router", "Query router")

' Config Servers (Replica Set)
Container_Boundary(config_rs, "Config Server RS") {
  ContainerDb(cfg1, "configSrv-1", "Config Primary", "Metadata storage")
  ContainerDb(cfg2, "configSrv-2", "Config Secondary", "Metadata replica")
  ContainerDb(cfg3, "configSrv-3", "Config Secondary", "Metadata replica")
}

' Shard 1
Container_Boundary(shard1_boundary, "Shard 1") {
  SystemDb(shard1, "shard1-1", "MongoDB Shard", "Data partition 1")
}

' Shard 2
Container_Boundary(shard2_boundary, "Shard 2") {
  SystemDb(shard2, "shard2-1", "MongoDB Shard", "Data partition 2")
}

' Relationships
Rel(user, api, "HTTP requests", "REST API")
Rel(api, mongos, "Queries", "MongoDB protocol")
Rel(mongos, config_rs, "Reads metadata (Replica Set)", "TCP 27019")
Rel(mongos, shard1_boundary, "Routes partitioned queries", "TCP 27018")
Rel(mongos, shard2_boundary, "Routes partitioned queries", "TCP 27018")

' Config RS replication
Rel(cfg1, cfg2, "Replicates", "Internal")
Rel(cfg1, cfg3, "Replicates", "Internal")

' SHOW_LEGEND()

@enduml
