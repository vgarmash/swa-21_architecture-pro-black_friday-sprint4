# Проектирование схем коллекций для шардирования данных

## Схемы коллекций

### orders (Заказы)

```json
{
  "id": {
    "type": "uuid",
    "description": "Уникальный идентификатор заказа"
  },
  "user_id": {
    "type": "uuid",
    "description": "Идентификатор клиента"
  },
  "created_at": {
    "type": "date-time",
    "description": "Дата-время оформления заказа"
  },
  "status": {
    "type": "string",
    "description": "Статус заказа",
    "values": ["created", "confirmed", "cancelled", "delivering", "completed"]
  },
  "geozone": {
    "type": "string",
    "description": "Геозона заказа",
    "values": ["moscow", "stpetersburg", "yekaterinburg", "..."]
  },
  "total": {
    "type": "number",
    "description": "Сумма заказа"
  },
  "items": {
    "type": "array",
    "description": "Список заказанных товаров",
    "data": {
      "product_id": {
        "type": "uuid",
        "description": "Уникальный идентификатор товара"
      },
      "quantity": {
        "type": "number",
        "description": "Количество товара в заказе"
      }
    }
  }
}
```

#### Основные операции поиска:

* Поиск заказов конкретного пользователя

### products (Товары)

```json
{
  "id": {
    "type": "uuid",
    "description": "Уникальный идентификатор товара"
  },
  "name": {
    "type": "string",
    "description": "Наименование товара"
  },
  "category": {
    "type": "string",
    "description": "Категория товара",
    "values": ["phone", "tablet", "laptop", "..."]
  },
  "price": {
    "type": "number",
    "description": "Цена товара"
  },
  "stocks": {
    "type": "array",
    "description": "Остаток товара в каждой геозоне",
    "data": {
      "geozone": {
        "type": "string",
        "description": "Геозона",
        "values": ["moscow", "stpetersburg", "yekaterinburg", "..."]
      },
      "quantity": {
        "type": "number",
        "description": "Остаток товара в геозоне"
      }
    }
  },
  "attributes": {
    "type": "array",
    "description": "Дополнительные атрибуты",
    "data": {
      "attribute_name": {
        "type": "string",
        "description": "Наименование атрибута",
        "values": ["color", "size", "..."]
      },
      "attribute_value": {
        "type": "string",
        "description": "Значение атрибута"
      }
    }
  }
}
```

#### Основные операции поиска:

* Поиск товаров по категориям
* Фильтрация по диапазону цен

### carts (Корзины)

```json
{
  "id": {
    "type": "uuid",
    "description": "Уникальный идентификатор корзины"
  },
  "user_id": {
    "type": "uuid",
    "description": "Идентификатор пользователя"
  },
  "session_id": {
    "type": "uuid",
    "description": "Идентификатор сессии (для незарегистрированных пользователей)"
  },
  "status": {
    "type": "string",
    "description": "Статус корзины",
    "values": ["active", "ordered", "abandoned"]
  },
  "created_at": {
    "type": "date-time",
    "description": "Дата-время создания"
  },
  "updated_at": {
    "type": "date-time",
    "description": "Дата-время последнего обновления"
  },
  "expires_at": {
    "type": "date-time",
    "description": "Дата-время очистки корзины (TTL)"
  },
  "items": {
    "type": "array",
    "description": "Список заказанных товаров",
    "data": {
      "product_id": {
        "type": "uuid",
        "description": "Уникальный идентификатор товара"
      },
      "quantity": {
        "type": "number",
        "description": "Количество товара в заказе"
      }
    }
  }
}
```

#### Основные операции поиска:

* Получение текущей корзины для пользователя `user_id` или сессии незарегистрированного пользователя `session_id`

## Выбор ключей и стратегий шардирования

| **Коллекция** | **Стратегия шардирования**                                  | **Обоснование**                                                                                                                                                                                     |
|:-------------:|:------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|    orders     | *Хэширование* поля `user_id`                                 | Требуется равномерное распределение между пользователями, так что добавляем хэширование по ключу                                                                                                    |
|   products    | *Хэширование* поля `category`, и *диапазон* по полю `price` | Поскольку часто выполняются запросы по категориям, то требуется хэшировать по этому полю, а также дополнительно разбить шарды по диапазонам цен, поскольку это также частый фильтр внутри категории |
|     carts     | *Хэширование* комбинации полей `user_id` и `session_id`     | Требуется равномерное распределение между пользователями - как зарегистрированными, так и незарегистрированными - поэтому хэширование требуется для комбинации двух полей                           |

**Дополнительно:**

* Для коллекции товаров, возможно, что если пользователи чаще выбирают не фиксированные, а произвольные диапазоны цен, шардирование по диапазону цены избыточно - требуются вводные по тому, как работает фильтр цены.
* Гипотетически, если пользователи более-менее равномерно распределены по стране, возможно сменить стратегию шардирования всех коллекций на геошардирование. Однако, без дополнительных вводных, предполагаем, что есть сильный перевес по заказам техники в сторону Москвы и Санкт-Петербурга, что делает геошардирование неоптимальным.
