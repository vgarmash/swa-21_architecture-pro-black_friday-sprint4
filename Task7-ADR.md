### <a name="_b7urdng99y53"></a>**Название задачи: Task 7. Проектирование коллекций для MongoBD**  

### <a name="_3bfxc9a45514"></a>**Требования**  
Коллекция orders включает заказы клиентов и содержит атрибуты:
- Уникальный идентификатор заказа;
- Идентификатор клиента;
- Дату и время оформления заказа;
- Список заказанных товаров и их цену;
- Статус заказа;
- Общую сумму заказа;
- Геозону заказа.

Основные операции:
- Быстрое создание заказов с одновременным списанием остатков.
- Поиск истории заказов конкретного пользователя.
- Отображение статуса заказа.

Коллекция products хранит сведения о товарах и включает такие атрибуты:
- Уникальный идентификатор товара;
- Наименование;
- Категорию товара;
- Цену;
- Остаток товара в каждой геозоне;
- Дополнительные атрибуты (цвет, размер).

Основные операции:
- Частые обновления остатков при покупках.
- Поиск товаров по категориям и фильтрация по диапазону цен.
- Описание товара на странице продукта.

Коллекция carts хранит данные о текущих корзинах (как гостевых, так и пользовательских) и включает атрибуты:
- Уникальный идентификатор корзины (_id);
- Идентификатор пользователя (user_id) и session_id для гостей;
- Список товаров (items): массив документов { product_id, quantity };
- Статус корзины (status): "active" | "ordered" | "abandoned";
- Дату и время создания (created_at);
- Дату и время последнего обновления (updated_at);
- Время удаления (TTL) (expires_at) — для автоматической очистки старых корзин.
Основные операции:
- Создание корзины, когда заходит гость или новый пользователь.
- Получение текущей корзины по фильтру { session_id, status:"active" } или { user_id, status:"active" }.
- Добавление или замена товара в корзине.
- Удаление товара из корзины.
- Слияние гостевой корзины в пользовательскую, если пользователь залогинится:
    - прочитать гостевую { session_id, status:"active" };
    - добавить её items в корзину { user_id, status:"active" };
    - отметить гостевую как abandoned.
    - Отметка корзины как заказанной.
---

### <a name="_qmphm5d6rvi3"></a>**Решение**  
#### Products
Коллекция products хранит сведения о товарах и включает такие атрибуты:
- Уникальный идентификатор товара;
- Наименование;
- Категорию товара;
- Цену;
- Остаток товара в каждой геозоне;
- Дополнительные атрибуты (цвет, размер).

Структура:
```
{
    "_id": ObjectId("1"),
    "name": "Смартфон X",
    "categories": {
        "main_category_id": "smartphones",
    } ,
    "prices": {
        "base_price": 50000,
        "sale_price": 45000,
        "discount_size_pct": 5,

    },
    "attributes": {
        "color": "black",
        "storage_mb": 100000
    },
    "inventory": {
        "available": {
            "msk": 40,
            "spb": 56,
            "ekb": 30
        }
    }
}
```
Запросы:
1. Обновление остатков. Пример: покупка 2 смартфонов Х в Москве
```
db.products.updateOne(
  {
    "_id": ObjectId("1"),
    "inventory.available.msk": { $gte: 2 }
  },
  {
    $inc: {
      "inventory.available.msk": -2
    }
  }
);
```
2. Поиск товаров по категориям и фильтрация по диапазону цен. Пример: поиск всех смартфонов от 20 до 60 т.р в наличии в Москве 
```
db.products.find({
  "categories.main_category_id": "smartphones",
  "prices.sale_price": { 
    $gte: 40000, 
    $lte: 60000 
  },
  "inventory.available.msk": { $gt: 0 }
})
```

3. Получить описание товара на странице продукта - рекомендуется разделить на 2 запроса:
- Получить основную информацию по товару
```
db.products.findOne(
  { "_id": ObjectId("1") },
  {
    "name": 1,
    "prices": 1,
    "categories.main_category_id": 1,
    "attributes": 1,
  }
);
```
- Получить остатки по товару
```
db.products.findOne(
  { "_id": ObjectId("1") },
  {
    "inventory.available": 1,
  }
);
```
Индексы:
- Для поиска по категории и ценам: categories.main_category_id + prices.sale_price
- Для текстового поиска name
- Для поиска с учетом наличия: categories.main_category_id + prices.sale_price + inventory.available.msk (spb, ekb)
    - Частое обновление остатков будет приводить к частой перестройке индекса, что может повлиять на производительность и задержку

Shard keys:
| Ключ             | Тип шардирования | Распределение данных | Поиск          | Комментарий                                                                                        |
|------------------|------------------|----------------------|----------------|----------------------------------------------------------------------------------------------------|
| product_id       | hashed           | Равномерное          | Не оптимальный | Для поиска нужно будет проверять все шарды                                                         |
| main_category_id | hashed           | Не равномерное       | Быстрый        | Может создать "горячие узлы", но юзкейс "Получить товары категории" отработает отлично             |
| sale_price       | Диапазанное      | Среднее              | Быстрый        | При изменении цен нагрузка за счет мигарции данных. При персонализации скидок это создаст проблему |

- По юзкейсам рекомендовано шардирование по main_category_id, несмотря на вероятность появления перенагруженных нод

--------
#### Carts
Коллекция carts хранит данные о текущих корзинах (как гостевых, так и пользовательских) и включает атрибуты:
- Уникальный идентификатор корзины (_id);
- Идентификатор пользователя (user_id) и session_id для гостей;
- Список товаров (items): массив документов { product_id, quantity };
- Статус корзины (status): "active" | "ordered" | "abandoned";
- Дату и время создания (created_at);
- Дату и время последнего обновления (updated_at);
- Время удаления (TTL) (expires_at) — для автоматической очистки старых корзин.

Структура:
```
{
    "_id": ObjectId("1"),
    "user_id": ObjectId("2"),
    "sessiod_id": ObjectId("2"),
    "items": [{
        "product_id": ObjectId("1"),
        "quantity": 10
        }],
    "status": "ordered", 
    "created_at": datetime,
    "updated_at": datetime,
    "expires_at": datetime
}
```
Запросы:
1. Создание корзины, когда заходит гость
```
db.carts.insertOne({
  _id: ObjectId("1"),
  sessiod_id: ObjectId("2"),
  items: [{ product_id: ObjectId("1"), quantity: 10 }],
  status: "active",
  created_at: new Date(),
  updated_at: new Date(),
  expires_at: new Date()
});
```
2. Получение текущей корзины по фильтру { session_id, status:"active" } или { user_id, status:"active" }.
```
db.carts.find({ user_id: ObjectId("2"), status: "active" });
db.carts.find({ session_id: ObjectId("2"), status: "active" });
```
3. Добавление или замена товара в корзине.
Обновление количества: 
```
db.carts.updateOne(
  { _id: ObjectId("1"), "items.product_id": ObjectId("1") },
  { $inc: { "items.$.quantity": 5 }, $set: { updated_at: new Date() } }
);
```
Добавление нового товара:
```
db.carts.updateOne(
  { _id: ObjectId("1"), "items.product_id": ObjectId("1") },
  { $set: { "items.$.quantity": 15, updated_at: new Date() } }
);
```
5. Слияние гостевой корзины в пользовательскую, если пользователь залогинится:
    - прочитать гостевую { session_id, status:"active" };
    - добавить её items в корзину { user_id, status:"active" };
    - отметить гостевую как abandoned.
    - Отметка корзины как заказанной.

Индексы:
- user_id + status для быстрого поиска
- session_id + status для быстрого поиска

Shard-keys:
| Ключ       | Тип шардирования | Распределение данных  | Поиск                                                 | Комментарий                                                                                         |
|------------|------------------|-----------------------|-------------------------------------------------------|-----------------------------------------------------------------------------------------------------|
| user_id    | hashed           | Средней равномерности | Оптимальный                                           | все гостевые корзины попадут в один шард (пустое значение user_id), что вызовет разбалансировку     |
| id         | hashed           | Равномерное           | Низкой оптимальности                                  | Получение корзины по пользователю проверит все шарды                                                |
| session_id | hashed           | Равномерное           | Низкой оптимальности для авторизованных пользователей | Быстрый доступ для гостевых сессий лучше обеспечить кэшированием на клиенте, чем шардированием в БД |

- рекомендовано сделать отдельное поле shard_key = user_id (если указано), либо session_id если не указано с хэшированным шардированием
--------
#### Orders
Коллекция orders включает заказы клиентов и содержит атрибуты:
- Уникальный идентификатор заказа;
- Идентификатор клиента;
- Дату и время оформления заказа;
- Список заказанных товаров и их цену;
- Статус заказа;
- Общую сумму заказа;
- Геозону заказа.

Основные операции:
- Быстрое создание заказов с одновременным списанием остатков.
- Поиск истории заказов конкретного пользователя.
- Отображение статуса заказа.

Структура orders:
```
{
    "_id": ObjectId("1"),
    "user_id": ObjectId("1"),
    "created_at": datetime,
    "items": [
        {
            "product_id": ObjectId("1"),
            "price": 10000,
            "product_data": {
                "name": "Смартфон Х" //и другие параметры, важные для фиксации
            } 
        },
    "status": "new",
    "total_price": 10000,
    "geo_mark": "msk" 
    ]
}
```
Запросы:
1. Быстрое создание заказов с одновременным списанием остатков
Если транзакции недоступны, то сначала списание остатков
```
db.products.updateOne(
    {
        _id: ObjectId("1"),
        [`inventory.available.msk`]: { $gte: 1 }
    },
    {
        $inc: { [`inventory.available.msk`]: -1 }
    }
);
```
Потом создание заказа
```
db.orders.insertOne({
    user_id: ObjectId("1"),
    created_at: new Date(),
    items: [
        {
            product_id: ObjectId("1"),
            price: 10000,
            product_data: {
                name: "Смартфон Х"
            },
            quantity: 1
        }
    ],
    status: "new",
    total_price: 10000,
    geo_mark: "msk"
});
```
Если поддерижваются транзакции, то оба запроса проводятся в рамках одной транзакции.
2. Поиск истории заказов конкретного пользователя.
```
db.orders.find({ user_id: ObjectId("2")});
```
3. Отображение статуса заказа.
```
```
Индексы:
- user_id + status

Shard-keys:
| Ключ     | Тип шардирования | Распределение данных | Поиск (для пользователя) | Комментарий                                                                                                                                                                                                                                                                               |
|----------|------------------|----------------------|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| user_id  | hashed           | Равномерное          | Оптимальный              | Поиск заказов пользователя будет выполняться на одном шарде (удобно для получения истории). Запрос на получение данных по заказу будет менее оптимален, если в запрос не будет включен user_id как параметр                                                                               |
| geo_mark | Гео              | Неравномерное        | Низкой оптимальности     | Для высокой операционной нагрузки (например, онлайн аналитика по геозонам) можно шардировать по geo_mark  с помощью геошардинга, но это может вызвать неравномерное распределение данных, в более активных регионах запросы для пользователей будут работать дольше (из-за объема данных) |
| order_id | Hashed           | Равномерное          | Высокой оптимальности    | Запрос для получения данных заказа (например его статуса) будет выполняться оптимально                                                                                                                                                                                                    |

- Рекомендуется в качестве ключа шардирования использовать order_id, т.к. получение статуса заказа пользователь выполняет чаще, чем просмотр истории и нагрузка на такие запросы будет выше

### <a name="_bjrr7veeh80c"></a>**Альтернативы**  
- Для более оптимальной работы с остатками рекомендуется выделить отдельную коллекцию inventory и получать данные о товаре с помощью двух запросов

