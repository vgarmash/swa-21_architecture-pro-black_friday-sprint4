### <a name="_b7urdng99y53"></a>**Название задачи:**
ADR-010-1: Миграция на Cassandra для критически важных данных интернет-магазина "Мобильный мир"
### <a name="_hjk0fkfyohdk"></a>**Автор:**
Архитектурная команда "Мобильный мир"
### <a name="_uanumrh8zrui"></a>**Дата:**
28.09.2025
### **Контекст и описание проблемы**
Во время «чёрной пятницы» система MongoDB с шардированием на основе диапазонов (Range-Based Sharding) показала критические недостатки при масштабировании под нагрузкой 50,000 запросов/сек:
    * Полное перераспределение данных при добавлении новых шардов вызывало деградацию производительности в самый критический момент
    * Высокая задержка (latency) из-за затрат ресурсов на миграцию чанков между узлами 
    * Невозможность быстрого масштабирования в реальном времени под растущей нагрузкой

### <a name="_qmphm5d6rvi3"></a>**Решение**

#### [Диаграмма компонентов C4](https://github.com/kotenev/architecture-pro-black_friday/blob/mobileworld/Task10-1/ADR-010-1/black_friday_C4_Component_Diagram_Cassandra.puml)

#### Классификация данных по критичности

| Тип данных           | Критичность | Требования                                                                                                        | Рекомендация по БД |
|----------------------|-------------|-------------------------------------------------------------------------------------------------------------------|--------------------|
| Корзины (carts)      | Высокая     | * Высокая скорость записи/чтения<br>* Временные данные (TTL)<br>* Допустима eventual consistency                  | Cassandra          |
| Сессии пользователей | Высокая     | * Очень высокая скорость записи<br>* TTL для автоочистки<br>* Геораспределённость                                 | Cassandra          |
| Товары (products)    | Средняя     | * Частое чтение, редкая запись<br>* Необходима strong consistency для остатков<br>* Сложные запросы по категориям | MongoDB            |
| Заказы (orders)      | Критическая | * ACID-транзакции<br>* Strong consistency<br>* Связи между сущностями                                             | MongoDB            |
| История заказов      | Низкая      | * Редкое чтение<br> Архивные данные<br>* Time-series характер                                                     | Cassandra          |
| Остатки товаров      | Критическая | * Атомарные операции<br>* Strong consistency<br>* Предотвращение overselling                                      | MongoDB            |

#### Обоснование выбора данных для миграции на Cassandra

##### 1. Корзины (carts)

Почему Cassandra подходит:
* Cassandra оптимизирована для интенсивной записи через LSM-tree структуру
* Автоматическая очистка устаревших корзин без дополнительных процессов
* Естественное распределение нагрузки с помощью партиционирования по session_id
* Временная несогласованность корзины не критична для бизнеса

Структура таблицы в Cassandra:
```cql
CREATE TABLE carts (
    session_id UUID,
    user_id UUID,
    updated_at timestamp,
    product_id UUID,
    quantity int,
    price decimal,
    status text,
    PRIMARY KEY ((session_id), updated_at, product_id)
) WITH CLUSTERING ORDER BY (updated_at DESC)
  AND default_time_to_live = 2592000; -- 30 дней TTL
```

##### 2. Сессии пользователей

Почему Cassandra подходит:
* Высокая нагрузка на запись, т.к. каждое действие пользователя обновляет сессию
* Пользователи из разных регионов, Cassandra поддерживает multi-DC репликацию
* Простая структура данных (ключ-значение) идеально подходит для Cassandra
* Сессии автоматически удаляются после истечения TTL

Структура таблицы в Cassandra:
```cql
CREATE TABLE user_sessions (
    session_id UUID PRIMARY KEY,
    user_id UUID,
    created_at timestamp,
    last_activity timestamp,
    ip_address inet,
    user_agent text,
    geo_zone text,
    session_data map<text, text>
) WITH default_time_to_live = 86400; -- 24 часа TTL
```

##### 3. История заказов (архивные данные)

Почему Cassandra подходит:
* Cassandra отлично работает с временными рядами (time-series)
* История редко изменяется после создания (write-once, read-rarely)
* Легко масштабировать хранилище путём добавления узлы для растущего архива
* Естественное распределение по месяцам/годам с помощью партиционирования по времени

Структура таблицы в Cassandra:
```cql
CREATE TABLE order_history (
    customer_id UUID,
    year int,
    month int,
    order_id UUID,
    created_at timestamp,
    total_amount decimal,
    status text,
    items frozen<list<frozen<map<text, text>>>>,
    PRIMARY KEY ((customer_id, year, month), created_at, order_id)
) WITH CLUSTERING ORDER BY (created_at DESC);
```

#### Данные, остающиеся в MongoDB

##### 1. Заказы (orders)

Обоснование:
* Требуются ACID-транзакции для атомарного создания заказа и списания остатков
* Сложные связи между данными (заказ -> товары -> остатки -> платежи)
* Strong consistency критична для финансовых операций
* Вторичные индексы для поиска по различным критериям

##### 2. Товары (products)

Обоснование:
* Сложные запросы с фильтрацией по множеству атрибутов
* Strong consistency для остатков предотвращает overselling
* Редкие обновления не создают проблем с производительностью записи
* Распределённая структура документа с вложенными атрибутами

##### 3. Остатки товаров

Обоснование:
* Атомарные операции декремента при каждой покупке
* Недопустимость eventual consistency может привести к overselling
* Транзакционность с заказами требует единой БД

## Преимущества гибридного подхода

1. Оптимальное использование сильных сторон каждой БД:
   * Cassandra для высоконагруженных операций записи
   * MongoDB для транзакционных операций

2. Независимое масштабирование:
   * Корзины и сессии масштабируются в Cassandra без влияния на критичные данные
   * Заказы и товары сохраняют консистентность в MongoDB

3. Снижение нагрузки на MongoDB:
   * Перенос больше 50% операций записи в Cassandra
   * MongoDB фокусируется на критически важных транзакциях

4. Улучшенная производительность:
   * Latency корзин < 5ms (Cassandra)
   * Latency сессий < 3ms (Cassandra)
   * Освобождение ресурсов MongoDB для критичных операций

### <a name="_bjrr7veeh80c"></a>**Альтернативы**

1. Перенос всех данных интернет-магазина на Cassandra, включая заказы и товары.

Причина отказа:
   * Отсутствие ACID-транзакций в Cassandra делает невозможным атомарное создание заказа со списанием остатков
   * Сложность реализации JOIN-операций потребует денормализации и дублирования данных
   * Риск overselling при eventual consistency для критичных операций с остатками
   * Переписывание всей бизнес-логики под ограничения Cassandra

2. Оптимизация существующего MongoDB кластера

Причина отказа:
   * Не решает корневую проблему** полного перераспределения данных при добавлении узлов
   * Balancer все равно создает нагрузку при миграции чанков в пиковые моменты
   * Ограничения архитектуры MongoDB с leader-based репликацией создают узкие места
   * Временное решение, которое отсрочит, но не устранит проблему

**Недостатки, ограничения, риски**

| Риск                              | Митигация                                       |
|-----------------------------------|-------------------------------------------------|
| Сложность поддержки двух БД       | Унификация мониторинга, обучение команды        |
| Синхронизация данных между БД     | Event-driven архитектура с Apache Kafka         |
| Отсутствие транзакций в Cassandra | Миграция только данных, не требующих транзакций |
| Сложность миграции                | Поэтапная миграция с параллельной записью       |
