# Задание 8. Выявление и устранение «горячих» шардов

## Управление «горячими» шардами в MongoDB

### 1. Введение

**Проблема**: дисбаланс нагрузки в шардированном кластере (70% запросов к категории «Электроника»), приводящий к перегрузке отдельных шардов.

**Цели**:
* оперативный мониторинг состояния шардов;
* автоматическое перераспределение данных;
* профилактика дисбаланса.

**Источники**: документация MongoDB (sharding, serverStatus, balancer).

### 2. Ключевые метрики мониторинга

**Распределение чанков**:
```javascript
use config
db.chunks.aggregate([
  { $group: { _id: "$shard", count: { $sum: 1 } } },
  { $sort: { count: -1 } }
])
```

**Статус балансировщика**:
```javascript
db.adminCommand({ balancerStatus: 1 })
```

**Основные метрики производительности** (через `db.serverStatus()`):
* `opcounters` — операции ввода‑вывода;
* `network` — сетевая нагрузка;
* `connections` — активные подключения;
* `wiredTiger.cache` — использование кэша;
* `mem` — потребление памяти.

**Медленные запросы**:
```javascript
db.currentOp({ "secs_running": { "$gt": 5 } })
```

### 3. Стратегии выбора ключа шардирования

**Варианты для коллекции `products`**:
1. Составной ключ:
   ```javascript
   sh.shardCollection("catalog.products", { "category": 1, "sku": 1 })
   ```
2. Хэш‑шардирование:
   ```javascript
   sh.shardCollection("catalog.products", { "_id": "hashed" })
   ```
3. Сегментация горячих категорий (отдельная коллекция):
   ```javascript
   sh.shardCollection("catalog.products_electronics", { "brand": 1, "model": 1 })
   ```

### 4. Механизмы перераспределения данных

**Управление балансировщиком**:
```javascript
sh.startBalancer()
sh.stopBalancer()

// Настройка окна балансировки
use config
db.settings.updateOne(
  { _id: "balancer" },
  { $set: { activeWindow: { start: "23:00", stop: "06:00" } } },
  { upsert: true }
)
```

**Ручное перемещение чанков**:
```javascript
db.adminCommand({
  moveChunk: "catalog.products",
  find: { category: "Electronics", sku: "ELEC001" },
  to: "shard2",
  _waitForDelete: true
})
```

**Изменение размера чанка** (по умолчанию 64MB):
```javascript
use config
db.settings.updateOne(
  { _id: "chunksize" },
  { $set: { value: 32 } },
  { upsert: true }
)
```

### 5. Профилактические меры

**Индексы**:
```javascript
// Для горячих запросов
db.products.createIndex({ "category": 1, "price": 1, "rating": -1 })

// Для TTL
db.products.createIndex({ "last_updated": 1 }, { expireAfterSeconds: 2592000 })
```

**Настройки WiredTiger** (для нагруженных шардов):
* `cache_size`: 50% ОЗУ;
* `max_cache_overflow`: 10GB.

**Алерты** на дисбаланс:
* разница в количестве чанков >10;
* загрузка CPU >80% в течение 5мин;
* сетевые байты в секунду >1GB.

### 6. План действий при обнаружении «горячего» шарда

**Немедленно**:
1. Собрать метрики через `db.serverStatus()` и `db.currentOp()`.
2. Запустить балансировщик: `sh.startBalancer()`.
3. Проверить индексы для оптимизации горячих запросов.

**В среднесрочной перспективе**:
1. Проанализировать паттерны доступа через профилировщик.
2. Рассмотреть перешардирование или сегментацию данных.
3. Настроить зонирование (Zone Sharding) для горячих категорий.

**Долгосрочно**:
1. Пересмотреть архитектуру данных и шаблоны запросов.
2. Автоматизировать мониторинг и реагирование.
3. Проводить ежемесячный аудит распределения данных.

### 7. Заключение

Предложенная стратегия включает:
* **реальные метрики** MongoDB для выявления дисбаланса;
* **официальные механизмы** перераспределения (балансировщик, ручное управление);
* **практические рекомендации** по профилактике.

**Ключевые преимущества**:
* минимальное время простоя при перераспределении;
* возможность автоматизации;
* масштабируемость под растущие нагрузки.