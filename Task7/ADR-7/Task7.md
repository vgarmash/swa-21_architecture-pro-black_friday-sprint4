### <a name="_b7urdng99y53"></a>**Название задачи:**
ADR-007: Шардирование коллекций MongoDB для масштабирования базы данных онлайн-магазина "Мобильный мир"
### <a name="_hjk0fkfyohdk"></a>**Автор:**
Архитектурная команда "Мобильный мир"
### <a name="_uanumrh8zrui"></a>**Дата:**
24.09.2025
### <a name="_3bfxc9a45514"></a>**Функциональные требования**
Онлайн-магазин «Мобильный мир» значительно вырос, расширив ассортимент от аксессуаров для смартфонов до электроники, аудио- и бытовой техники. Бэкенд сайта построен на микросервисной архитектуре с использованием MongoDB.
Во время пиковой нагрузки в «чёрную пятницу» система не справилась с потоком пользователей. Микросервис API, работающий с базой данных, не выдержал нагрузки, что привело к отказу всего сайта на несколько часов. Это привело к значительным финансовым и репутационным потерям. Проблема заключается в том, что текущая архитектура с единым инстансом MongoDB не способна горизонтально масштабироваться для обработки пиковых нагрузок, особенно операций записи (создание заказов, обновление остатков).
Здесь описаны верхнеуровневые Use Cases которые создают наибольшую нагрузку на БД и были критичными во время инцидента в "чёрную пятницу". Они оформлены в виде таблицы с пошаговым описанием:

| **№** | **Действующие лица или системы**                  | **Use Case**                | **Описание**                                                                                                                                                                            |
|:-----:|:--------------------------------------------------|:----------------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| UC01  | Покупатель, Микросервис заказов, MongoDB          | Создание заказа             | Покупатель оформляет заказ. Система создает новый документ заказа в БД, одновременно списывая остатки товаров со склада. Требуется атомарность операции и высокая скорость выполнения.  |
| UC02  | Микросервис складского учета, MongoDB             | Обновление остатков товаров | При покупке товара система автоматически уменьшает количество товара на складе в соответствующей геозоне. Операция должна быть атомарной и происходить часто без блокировок.            |
| UC03  | Покупатель, Микросервис личного кабинета, MongoDB | Просмотр истории заказов    | Покупатель запрашивает список своих предыдущих заказов. Система выполняет поиск всех заказов конкретного пользователя и возвращает их с сортировкой по дате.                            |
| UC04  | Покупатель, Микросервис каталога, MongoDB         | Поиск и фильтрация товаров  | Покупатель ищет товары по категории с дополнительной фильтрацией по диапазону цен. Система выполняет запрос к БД и возвращает отфильтрованный список товаров.                           |
| UC05  | Гость/Покупатель, Микросервис корзины, MongoDB    | Управление корзиной         | Пользователь (гость или авторизованный) добавляет/удаляет товары в корзине. Система обновляет состояние корзины в БД, поддерживая как гостевые сессии, так и привязку к учетной записи. |

### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**
Здесь описаны нефункциональные и архитектурно значимые требования.

| **№** | **Требование**                                                                                                                                                                                                    |
|:------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| R1    | Масштабируемость: система должна выдерживать многократное увеличение нагрузки во время распродаж без деградации производительности. Необходимо обеспечить возможность горизонтального масштабирования.            |
| R2    | Доступность и отказоустойчивость: система должна оставаться доступной в режиме 24/7. Отказ одного узла базы данных не должен приводить к отказу всего сервиса.                                                    |
| P1    | Производительность: задержка (latency) ключевых операций (создание заказа, поиск по каталогу) должна оставаться низкой (P95 < 200ms) даже при высокой нагрузке. Необходимо избегать блокировок и узких мест в БД. |
| M1    | Управляемость: решение должно быть управляемым, включать в себя инструменты для мониторинга распределения данных, производительности запросов и состояния кластера.                                               |

### <a name="_qmphm5d6rvi3"></a>**Решение**
Для решения проблем масштабируемости и производительности решено внедрить горизонтальное шардирование MongoDB. Данные будут распределены по нескольким независимым серверам (шардам). Каждый шард будет представлять собой набор реплик (replica set) для обеспечения высокой доступности и отказоустойчивости.

#### [Диаграмма компонентов C4](https://github.com/kotenev/architecture-pro-black_friday/blob/mobileworld/Task7/ADR-007/Mobileworld_Component_Mongodb_Sharded_Cluster.puml)

#### Логика принятия решений и выбор технологий

Это решение позволяет распределить не только данные, но и нагрузку на запись и чтение, что напрямую решает проблему, возникшую в «чёрную пятницу».

Далее описываются выбранные стратегии шардирования и шард-ключи:

1. Коллекция `orders` (заказы)
*  Выбранный шард-ключ: `{customer_id: "hashed"}`
*  Стратегия: хешированное шардирование (hashed sharding).
*  Обоснование:
    *   Равномерное распределение записи: ключевая операция — создание заказов. Хеширование `customer_id` гарантирует, что новые заказы будут равномерно распределяться по всем шардам, избегая "горячих точек" на одном шарде.
    *   Эффективность чтения: основной сценарий чтения — поиск истории заказов конкретного пользователя. Запросы с `customer_id` будут направляться точно на один шард, что делает их максимально быстрыми.
*   Схема:
    ```json
    {
      "_id": "68d2977c3ae881f51d4f8b5c",
      "customer_id": "881f51d4f8b7c68d2977c3ae",
      "created_at": "2025-09-24T10:33:00Z",
      "items": [{"product_id": "d29d3ae881f51d4f8ba56877", "price": 35000, "quantity": 1}],
      "status": "processing",
      "total_amount": 27500,
      "geo_zone": "moscow"
    }
    ```
2. Коллекция `products` (Товары)
*   Выбранный шард-ключ: `{category: 1, _id: 1}`
*   Стратегия: диапазонное шардирование (range sharding) с использованием зон (zone sharding).
*   Обоснование:
    *   Локальность данных: основные операции поиска — по категориям. Этот ключ сгруппирует товары одной категории на одном или нескольких выделенных шардах, что ускорит запросы с фильтрацией по `category`.
    *   Управление "горячими" категориями: анализ показал, что 70% запросов приходится на категорию "Электроника". С помощью зон (Zone Sharding) мы можем привязать данные этой категории к наиболее мощным серверам в кластере.
    *   Избежание "jumbo" чанков: добавление `_id` в ключ обеспечивает высокую кардинальность, предотвращая создание слишком больших чанков.
*   Схема:
    ```json
    {
      "_id": "d29d3ae881f51d4f8ba56877",
      "name": "Смартфон Z",
      "category": "Электроника",
      "price": 35000,
      "stock": { "moscow": 50, "kaliningrad": 10 },
      "attributes": { "color": "красный", "memory": "256GB" }
    }
    ```

3. Коллекция `carts` (Корзины)
*   Выбранный шард-ключ: `{ session_id: "hashed" }`
*   Стратегия: Хешированное шардирование (Hashed Sharding).
*   Обоснование:
    *   Универсальность и распределение: ключ `session_id` уникален для каждой активной сессии (как гостевой, так и авторизованной). Хеширование этого ключа обеспечивает равномерное распределение активных корзин по кластеру, что критически важно при большом количестве одновременных пользователей.
    *   Эффективность операций: все операции с корзиной (добавление, удаление, чтение) выполняются в контексте одной сессии, а значит, запросы будут целевыми (targeted).
*   Схема:
    ```json
    {
      "_id": "5168d2977c3ae881fd4f89ff",
      "user_id": "77d29b3ae881f5168d4f886f",
      "session_id": "sess_xyz678vbn321",
      "items": [{"product_id": "d29d3ae881f51d4f8ba56877", "quantity": 2}],
      "status": "active",
      "expires_at": "2025-10-31T10:00:00Z"
    }
    ```

#### Преимущества выбранного решения

*   Горизонтальная масштабируемость: система теперь может масштабироваться путем добавления новых шардов для обработки растущей нагрузки.
*   Высокая доступность: использование наборов реплик для каждого шарда и для серверов конфигурации устраняет единую точку отказа.
*   Повышенная производительность: распределение нагрузки на запись и чтение по нескольким узлам значительно снижает задержки и предотвращает взаимоблокировки.

### <a name="_bjrr7veeh80c"></a>**Альтернативы**
Здесь описаны наиболее важные альтернативные решения.

1.  Вертикальное масштабирование
    *   Описание: увеличение мощности (CPU, RAM, IOPS) существующего сервера MongoDB.
    *   Причина отказа: этот подход имеет физические и экономические ограничения. Он не решает проблему в долгосрочной перспективе и оставляет систему с единой точкой отказа.

2.  Добавление реплик для чтения (Read Replicas)
    *   Описание: создание нескольких копий базы данных для распределения нагрузки на чтение.
    *   Причина отказа: основная проблема в «чёрную пятницу» была связана с высокой нагрузкой на **запись** (создание заказов, корзин, обновление остатков). Реплики для чтения не решают эту проблему, так как все операции записи по-прежнему идут на один первичный узел (primary).

3.  Шардирование `orders` по дате (`created_at`)
    *   Описание: использование диапазонного шардирования по дате создания заказа.
    *   Причина отказа: этот подход привел бы к созданию "горячего" шарда, так как все новые заказы (пиковая нагрузка на запись) направлялись бы на последний шард в диапазоне, что не решает проблему распределения нагрузки.

**Недостатки, ограничения, риски**

*   Повышенная сложность: архитектура становится сложнее в развертывании, управлении и мониторинге. Требуется экспертиза в администрировании шардированных кластеров.
*   Неэффективные запросы (Scatter-Gather): запросы, не использующие шард-ключ (например, поиск всех заказов со статусом "processing"), будут рассылаться на все шарды, что снижает их производительность. Требуется тщательное проектирование запросов и индексов.
*   Критичность выбора шард-ключа: неправильно выбранный шард-ключ трудно изменить. Он может привести к несбалансированному распределению данных и созданию "горячих" шардов.
*   Ограничения транзакций: транзакции, затрагивающие документы на разных шардах, более сложные и имеют более высокую задержку.
