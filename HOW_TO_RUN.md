# üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–µ–∫—Ç

> –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ MongoDB Sharding  
> üè† [‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ README](README.md)

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Docker –∏ Docker Compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- –ü–æ—Ä—Ç—ã 8080 –∏ 27017 —Å–≤–æ–±–æ–¥–Ω—ã
- –ú–∏–Ω–∏–º—É–º 4GB —Å–≤–æ–±–æ–¥–Ω–æ–π RAM

## –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–¥–µ–ª–∞–Ω–æ)

```bash
cd /Users/nspeganov/IdeaProjects/mongodb-sharding-optimization
```

## –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

```bash
docker compose up -d
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è 7 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- Config Servers (3), Shards (2), Mongos (1), API (1)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
docker compose ps
```

–í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Å—Ç–∞—Ç—É—Å–µ `running`.

**–û–∂–∏–¥–∞–π—Ç–µ 10-15 —Å–µ–∫—É–Ω–¥** –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ MongoDB.

## –®–∞–≥ 3: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
./scripts/init-sharding.sh
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. ‚úÖ Config Server Replica Set –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
2. ‚úÖ Shard 1 Replica Set –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
3. ‚úÖ Shard 2 Replica Set –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
4. ‚úÖ –®–∞—Ä–¥—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ –∫–ª–∞—Å—Ç–µ—Ä
5. ‚úÖ –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –¥–ª—è –ë–î `somedb`
6. ‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è `helloDoc` —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏ —à–∞—Ä–¥–∏—Ä—É–µ—Ç—Å—è
7. ‚úÖ 1000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
8. ‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~1-2 –º–∏–Ω—É—Ç—ã

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
===================================
–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MongoDB Sharding
===================================

–®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Config Server Replica Set
‚úì Config Server Replica Set –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω

–®–∞–≥ 2: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Shard 1 Replica Set
‚úì Shard 1 Replica Set –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω

...

–®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ —à–∞—Ä–¥–∞–º
Shard shard1ReplSet at shard1ReplSet/shard1:27018
  data: ...
  docs: 500
  chunks: 2

Shard shard2ReplSet at shard2ReplSet/shard2:27018
  data: ...
  docs: 500
  chunks: 2

===================================
‚úì –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!
===================================
```

## –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API

### 4.1 –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

```bash
curl http://localhost:8080
```

### 4.2 –° —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω jq)

```bash
curl http://localhost:8080 | jq
```

### 4.3 –ü—Ä–æ–≤–µ—Ä–∫–∞ topology type

```bash
curl -s http://localhost:8080 | jq '.mongo_topology_type'
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** `"Sharded"`

### 4.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ mongos

```bash
curl -s http://localhost:8080 | jq '.mongo_is_mongos'
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** `true`

### 4.5 –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

```bash
curl -s http://localhost:8080 | jq '.collections.helloDoc.documents_count'
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** `1000`

### 4.6 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–∏—Å–∫–∞ —à–∞—Ä–¥–æ–≤

```bash
curl -s http://localhost:8080 | jq '.shards'
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```json
{
  "shard1ReplSet": "shard1ReplSet/shard1:27018",
  "shard2ReplSet": "shard2ReplSet/shard2:27018"
}
```

### 4.7 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ —à–∞—Ä–¥–∞–º

```bash
curl -s http://localhost:8080 | jq '.shard_distribution.helloDoc'
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```json
{
  "shard1ReplSet": {
    "count": 500,
    "size": 45000
  },
  "shard2ReplSet": {
    "count": 500,
    "size": 45000
  }
}
```

## –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ

–û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8080

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å JSON —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–ª–∞—Å—Ç–µ—Ä–µ.

### Swagger UI

–û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8080/docs

–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API.

## –®–∞–≥ 6: –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —à–∞—Ä–¥–æ–≤

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ Shard 1

```bash
docker compose exec -T shard1 mongosh --port 27018 --quiet <<EOF
use somedb
db.helloDoc.countDocuments()
EOF
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** ~500

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ Shard 2

```bash
docker compose exec -T shard2 mongosh --port 27018 --quiet <<EOF
use somedb
db.helloDoc.countDocuments()
EOF
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** ~500

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
docker compose exec -T mongos mongosh --port 27017 --quiet <<EOF
sh.status();
EOF
```

## –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫-–ª–∏—Å—Ç

- [ ] –í—Å–µ 7 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∑–∞–ø—É—â–µ–Ω—ã (`docker compose ps`)
- [ ] `mongo_topology_type` = "Sharded"
- [ ] `mongo_is_mongos` = true
- [ ] –í –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `helloDoc` >= 1000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- [ ] –°–ø–∏—Å–æ–∫ —à–∞—Ä–¥–æ–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç shard1ReplSet –∏ shard2ReplSet
- [ ] `shard_distribution` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- [ ] –°—É–º–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –æ–±–æ–∏—Ö —à–∞—Ä–¥–∞—Ö ‚âà 1000
- [ ] API –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:8080
- [ ] Swagger UI –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:8080/docs

## –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

```bash
docker compose down -v
docker compose up -d
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
```bash
docker compose logs mongos
docker compose logs shard1
docker compose logs configSrv1
```

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:
```bash
docker compose down -v
docker compose up -d
sleep 15
./scripts/init-sharding.sh
```

### –ü—Ä–æ–±–ª–µ–º–∞: API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
```bash
docker compose logs pymongo-api
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
```bash
docker compose restart pymongo-api
```

### –ü—Ä–æ–±–ª–µ–º–∞: –î–∞–Ω–Ω—ã–µ –Ω–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è

–ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é:
```bash
docker compose exec -T mongos mongosh --port 27017 --quiet <<EOF
use somedb
db.helloDoc.drop();
sh.shardCollection("somedb.helloDoc", { _id: "hashed" });
for(var i = 0; i < 1000; i++) {
  db.helloDoc.insertOne({age: i, name: "ly" + i});
}
db.helloDoc.getShardDistribution();
EOF
```

## –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```bash
docker compose down
```

### –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (—É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö)

```bash
docker compose down -v
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—Å—Ç–∞–≤–∫–∏

```bash
time docker compose exec -T mongos mongosh --port 27017 --quiet <<EOF
use somedb
for(var i = 1000; i < 2000; i++) {
  db.helloDoc.insertOne({age: i, name: "user" + i});
}
EOF
```

### –¢–µ—Å—Ç API

```bash
# –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
curl http://localhost:8080/helloDoc/count

# –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
curl http://localhost:8080/helloDoc/users | jq '.users | length'

# –ù–∞–π—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
curl http://localhost:8080/helloDoc/users/ly42

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
curl -X POST http://localhost:8080/helloDoc/users \
  -H "Content-Type: application/json" \
  -d '{"age": 99, "name": "testuser"}'
```

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–î–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å–º.:
- ‚ö° [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](QUICKSTART.md) - 3 –∫–æ–º–∞–Ω–¥—ã
- üß™ [–ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](TESTING.md) - –≤—Å–µ –≤–∏–¥—ã –ø—Ä–æ–≤–µ—Ä–æ–∫
- ‚öôÔ∏è [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è](SHARDING_SETUP.md) - –¥–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- üìã [–°–≤–æ–¥–∫–∞ –ó–∞–¥–∞–Ω–∏—è 2](TASK2_SUMMARY.md) - —á—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ
- üìñ [–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ](PLANNING.md) - –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è
- üè† [–ì–ª–∞–≤–Ω–∞—è](README.md) - –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ó–∞–¥–∞–Ω–∏—è 2 –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫:
- üìñ –ó–∞–¥–∞–Ω–∏–µ 3: –†–µ–ø–ª–∏–∫–∞—Ü–∏—è
- üìñ –ó–∞–¥–∞–Ω–∏–µ 4: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Redis
- üìä [–°—Ö–µ–º—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](diagrams/ARCHITECTURE.md)

