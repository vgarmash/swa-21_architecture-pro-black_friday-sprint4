# –ó–∞–¥–∞–Ω–∏–µ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å Redis

> üìã –î–µ—Ç–∞–ª—å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è  
> üè† [‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ README](../README.md) | üìä [–°–≤–æ–¥–∫–∞ –∑–∞–¥–∞–Ω–∏—è](TASK4_SUMMARY.md) | üé® [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](../diagrams/ARCHITECTURE.md)

---

## üìö –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è](#–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞-–æ–∫—Ä—É–∂–µ–Ω–∏—è)
3. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ compose.yaml](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-composeyaml)
4. [–ó–∞–ø—É—Å–∫ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è](#–∑–∞–ø—É—Å–∫-–∏-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
5. [–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è](#–ø—Ä–æ–≤–µ—Ä–∫–∞-–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è)
6. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
7. [–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º](#—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ-–ø—Ä–æ–±–ª–µ–º)

---

## –û–±–∑–æ—Ä

### –¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è

–î–æ–±–∞–≤–∏—Ç—å Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è:
- –°–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ MongoDB
- –£—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (<100–º—Å)
- –ü–æ–≤—ã—à–µ–Ω–∏—è –æ–±—â–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã

### –ß—Ç–æ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
–î–æ (–ó–∞–¥–∞–Ω–∏–µ 3):
Client ‚Üí API ‚Üí Mongos ‚Üí Shards (—Å —Ä–µ–ø–ª–∏–∫–∞–º–∏)

–ü–æ—Å–ª–µ (–ó–∞–¥–∞–Ω–∏–µ 4):
Client ‚Üí API ‚Üí Redis (Cache) ‚Üí Mongos ‚Üí Shards (—Å —Ä–µ–ø–ª–∏–∫–∞–º–∏)
              ‚Üì cache miss
```

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- **–ë—ã–ª–æ:** 11 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (3 config + 6 shards + 1 mongos + 1 api)
- **–°—Ç–∞–ª–æ:** 12 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (+1 Redis)

---

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Docker –∏ Docker Compose
- –°–≤–æ–±–æ–¥–Ω—ã–µ –ø–æ—Ä—Ç—ã: 27017 (mongos), 8080 (api), 6379 (redis)
- ~4GB RAM –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –†–∞–±–æ—á–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑ –ó–∞–¥–∞–Ω–∏—è 3

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è
docker compose down

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—Ä—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã
lsof -i :27017
lsof -i :8080
lsof -i :6379  # –ù–æ–≤—ã–π –ø–æ—Ä—Ç –¥–ª—è Redis
```

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ compose.yaml

### –®–∞–≥ 1: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø—Ä–æ–µ–∫—Ç–∞

**–ë—ã–ª–æ:**
```yaml
name: mongo-sharding-repl
```

**–°—Ç–∞–ª–æ:**
```yaml
name: sharding-repl-cache
```

**–ó–∞—á–µ–º:**
- –û—Ç–¥–µ–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –ó–∞–¥–∞–Ω–∏—è 4 –æ—Ç –ó–∞–¥–∞–Ω–∏—è 3
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞—Ç—å –æ–±–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–Ω–∞ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ä—Ç–∞—Ö)

### –®–∞–≥ 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Redis —Å–µ—Ä–≤–∏—Å–∞

**–î–æ–±–∞–≤—å—Ç–µ –ø–æ—Å–ª–µ mongos –∏ –¥–æ pymongo-api:**

```yaml
  # Redis Cache
  redis:
    container_name: redis
    image: redis:latest
    ports:
      - "6379:6379"
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥—ã:**
- `--maxmemory 256mb` - –º–∞–∫—Å–∏–º—É–º 256MB –ø–∞–º—è—Ç–∏ –¥–ª—è –∫–µ—à–∞
- `--maxmemory-policy allkeys-lru` - –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ —É–¥–∞–ª—è—Ç—å —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–ª—é—á–∏

**–ü–æ–ª–∏—Ç–∏–∫–∏ –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è Redis:**
- `allkeys-lru` - —É–¥–∞–ª—è–µ—Ç —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–ª—é—á–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- `allkeys-lfu` - —É–¥–∞–ª—è–µ—Ç —Ä–µ–¥–∫–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–µ –∫–ª—é—á–∏
- `volatile-lru` - —É–¥–∞–ª—è–µ—Ç –∫–ª—é—á–∏ —Å TTL
- `noeviction` - –Ω–µ —É–¥–∞–ª—è–µ—Ç –∫–ª—é—á–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É

### –®–∞–≥ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ REDIS_URL –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

**–ë—ã–ª–æ:**
```yaml
  pymongo-api:
    container_name: pymongo-api
    build: 
      context: api_app
      dockerfile: Dockerfile
    depends_on:
      - mongos
    ports:
      - "8080:8080"
    environment:
      MONGODB_URL: "mongodb://mongos:27017"
      MONGODB_DATABASE_NAME: "somedb"
```

**–°—Ç–∞–ª–æ:**
```yaml
  pymongo-api:
    container_name: pymongo-api
    build: 
      context: api_app
      dockerfile: Dockerfile
    depends_on:
      - mongos
      - redis  # –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
    ports:
      - "8080:8080"
    environment:
      MONGODB_URL: "mongodb://mongos:27017"
      MONGODB_DATABASE_NAME: "somedb"
      REDIS_URL: "redis://redis:6379"  # –ù–æ–≤–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
```

**–í–∞–∂–Ω–æ:**
- `redis://redis:6379` - –≥–¥–µ –ø–µ—Ä–≤—ã–π `redis://` —ç—Ç–æ –ø—Ä–æ—Ç–æ–∫–æ–ª, –≤—Ç–æ—Ä–æ–π `redis` - –∏–º—è —Å–µ—Ä–≤–∏—Å–∞
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `depends_on: redis`

### –®–∞–≥ 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ volume –¥–ª—è Redis

**–í —Å–µ–∫—Ü–∏—é volumes –¥–æ–±–∞–≤—å—Ç–µ:**

```yaml
volumes:
  configSrv1_data:
  configSrv2_data:
  configSrv3_data:
  shard1_1_data:
  shard1_2_data:
  shard1_3_data:
  shard2_1_data:
  shard2_2_data:
  shard2_3_data:
  redis_data:  # –ù–æ–≤—ã–π volume
```

### –ü–æ–ª–Ω—ã–π compose.yaml

–ò—Ç–æ–≥–æ–≤—ã–π —Ñ–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞: [`compose.yaml`](../compose.yaml)

---

## –ó–∞–ø—É—Å–∫ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

### –®–∞–≥ 1: –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

```bash
docker compose up -d
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
[+] Running 12/12
 ‚úî Container configSrv1    Started
 ‚úî Container configSrv2    Started
 ‚úî Container configSrv3    Started
 ‚úî Container shard1-1      Started
 ‚úî Container shard1-2      Started
 ‚úî Container shard1-3      Started
 ‚úî Container shard2-1      Started
 ‚úî Container shard2-2      Started
 ‚úî Container shard2-3      Started
 ‚úî Container redis         Started
 ‚úî Container mongos        Started
 ‚úî Container pymongo-api   Started
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

```bash
docker compose ps
```

**–í—Å–µ 12 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Å—Ç–∞—Ç—É—Å–µ `running`:**
- 3 config servers
- 6 shard replicas
- 1 mongos
- 1 redis
- 1 pymongo-api

### –®–∞–≥ 3: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MongoDB

**–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–∫—Ä–∏–ø—Ç –∏–∑ –ó–∞–¥–∞–Ω–∏—è 3:**

```bash
./scripts/init-replication.sh
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç replica set –¥–ª—è config servers
2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç replica set –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞—Ä–¥–∞ (–ø–æ 3 —Ä–µ–ø–ª–∏–∫–∏)
3. –î–æ–±–∞–≤–ª—è–µ—Ç —à–∞—Ä–¥—ã –≤ mongos
4. –í–∫–ª—é—á–∞–µ—Ç —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ë–î `somedb`
5. –®–∞—Ä–¥–∏—Ä—É–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏—é `helloDoc` –ø–æ –∫–ª—é—á—É `_id`
6. –í—Å—Ç–∞–≤–ª—è–µ—Ç 1000 —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
Waiting for MongoDB services to start...
MongoDB services are ready!

Initializing Config Server Replica Set...
...
Config Server Replica Set initialized successfully!

Initializing Shard 1 Replica Set...
...
Shard 1 Replica Set initialized successfully!

Initializing Shard 2 Replica Set...
...
Shard 2 Replica Set initialized successfully!

Adding shards to mongos...
...
Shards added successfully!

Enabling sharding and creating sharded collection...
...
Sharding enabled and collection created!

Inserting 1000 test documents...
...
Successfully inserted 1000 documents!

API Response:
{
  "mongo_topology_type": "Sharded",
  "collections": {
    "helloDoc": {
      "documents_count": 1000
    }
  },
  "shards": {
    "shard1ReplSet": "shard1-1:27018,shard1-2:27018,shard1-3:27018",
    "shard2ReplSet": "shard2-1:27018,shard2-2:27018,shard2-3:27018"
  },
  "shard_distribution": {
    "helloDoc": {
      "shard1ReplSet": { "count": 498, "size": 20000 },
      "shard2ReplSet": { "count": 502, "size": 20100 }
    }
  },
  "cache_enabled": true,
  "status": "OK"
}
```

**–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ:**
- `"cache_enabled": true` ‚úÖ - Redis –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: 1000 ‚úÖ
- –î–æ–∫—É–º–µ–Ω—Ç—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ –¥–≤—É–º —à–∞—Ä–¥–∞–º ‚úÖ

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
docker compose exec redis redis-cli ping
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** `PONG`

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ Redis –ø—É—Å—Ç–æ–π (–µ—â–µ –Ω–µ—Ç –∫–µ—à–∞)
docker compose exec redis redis-cli DBSIZE
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** `(integer) 0`

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

### –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

#### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ

```bash
curl -s http://127.0.0.1:8080 | jq '.cache_enabled'
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** `true` ‚úÖ

#### 2. –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å (–±–µ–∑ –∫–µ—à–∞, –º–µ–¥–ª–µ–Ω–Ω—ã–π)

```bash
time curl -s http://127.0.0.1:8080/helloDoc/users | jq '.users | length'
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è:** ~1.2 —Å–µ–∫—É–Ω–¥—ã (–∏–∑-–∑–∞ `time.sleep(1)` –≤ –∫–æ–¥–µ + –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ –∫ MongoDB)

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- –í `api_app/app.py` —Å—Ç—Ä–æ–∫–∞ 171: `time.sleep(1)` - –∏–º–∏—Ç–∞—Ü–∏—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –î–∞–Ω–Ω—ã–µ —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ MongoDB
- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Redis

#### 3. –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å (–∏–∑ –∫–µ—à–∞, –±—ã—Å—Ç—Ä—ã–π)

```bash
time curl -s http://127.0.0.1:8080/helloDoc/users | jq '.users | length'
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è:** ~0.03-0.05 —Å–µ–∫—É–Ω–¥—ã ‚úÖ

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- –î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ Redis
- `time.sleep(1)` –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è (—Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è)
- MongoDB –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç—Å—è

#### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–∏ –≤ Redis

```bash
docker compose exec redis redis-cli KEYS '*'
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä:
```
1) "api:cache:list_users:helloDoc"
```

**–§–æ—Ä–º–∞—Ç –∫–ª—é—á–∞:**
- `api:cache:` - –ø—Ä–µ—Ñ–∏–∫—Å (–Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ `app.py` —Å—Ç—Ä–æ–∫–∞ 60)
- `list_users` - –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏
- `helloDoc` - –ø–∞—Ä–∞–º–µ—Ç—Ä `collection_name`

#### 5. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–µ—à–∞

```bash
docker compose exec redis redis-cli GET "api:cache:list_users:helloDoc"
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Å–∂–∞—Ç—ã–π)

### –î–µ—Ç–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

```bash
#!/bin/bash

echo "=== –¢–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è /helloDoc/users ==="
echo ""

# –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
docker compose exec -T redis redis-cli FLUSHALL > /dev/null

echo "1. –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å (–±–µ–∑ –∫–µ—à–∞):"
time curl -s http://127.0.0.1:8080/helloDoc/users | jq '.users | length'

echo ""
echo "2. –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å (–∏–∑ –∫–µ—à–∞):"
time curl -s http://127.0.0.1:8080/helloDoc/users | jq '.users | length'

echo ""
echo "3. –¢—Ä–µ—Ç–∏–π –∑–∞–ø—Ä–æ—Å (–∏–∑ –∫–µ—à–∞):"
time curl -s http://127.0.0.1:8080/helloDoc/users | jq '.users | length'

echo ""
echo "4. –ß–µ—Ç–≤–µ—Ä—Ç—ã–π –∑–∞–ø—Ä–æ—Å (–∏–∑ –∫–µ—à–∞):"
time curl -s http://127.0.0.1:8080/helloDoc/users | jq '.users | length'

echo ""
echo "=== –ò—Ç–æ–≥: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ ~20 —Ä–∞–∑! ==="
```

**–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤ `test-cache.sh` –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:**

```bash
chmod +x test-cache.sh
./test-cache.sh
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
=== –¢–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è /helloDoc/users ===

1. –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å (–±–µ–∑ –∫–µ—à–∞):
1000
real    0m1.234s

2. –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å (–∏–∑ –∫–µ—à–∞):
1000
real    0m0.045s

3. –¢—Ä–µ—Ç–∏–π –∑–∞–ø—Ä–æ—Å (–∏–∑ –∫–µ—à–∞):
1000
real    0m0.032s

4. –ß–µ—Ç–≤–µ—Ä—Ç—ã–π –∑–∞–ø—Ä–æ—Å (–∏–∑ –∫–µ—à–∞):
1000
real    0m0.038s

=== –ò—Ç–æ–≥: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ ~20 —Ä–∞–∑! ===
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ TTL (Time To Live)

**–ö–µ—à –∂–∏–≤–µ—Ç 60 —Å–µ–∫—É–Ω–¥** (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ `app.py` —Å—Ç—Ä–æ–∫–∞ 165: `@cache(expire=60 * 1)`)

```bash
# –°–æ–∑–¥–∞—Ç—å –∫–µ—à
curl -s http://127.0.0.1:8080/helloDoc/users > /dev/null

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TTL –∫–ª—é—á–∞
docker compose exec redis redis-cli TTL "api:cache:list_users:helloDoc"
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ß–∏—Å–ª–æ –æ—Ç 0 –¥–æ 60 (—Å–µ–∫—É–Ω–¥—ã –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è)

```bash
# –ü–æ–¥–æ–∂–¥–∞—Ç—å 65 —Å–µ–∫—É–Ω–¥
sleep 65

# –ó–∞–ø—Ä–æ—Å —Å–Ω–æ–≤–∞ –±—É–¥–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–º (–∫–µ—à –∏—Å—Ç–µ–∫)
time curl -s http://127.0.0.1:8080/helloDoc/users > /dev/null
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** ~1.2 —Å–µ–∫—É–Ω–¥—ã (–∫–∞–∫ –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å)

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Redis

#### 1. –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

```bash
docker compose exec redis redis-cli INFO stats
```

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- `keyspace_hits` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫–µ—à
- `keyspace_misses` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–º–∞—Ö–æ–≤ (–∫–µ—à–∞ –Ω–µ –±—ã–ª–æ)
- `total_commands_processed` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥

**Hit Rate (–ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π):**
```
Hit Rate = keyspace_hits / (keyspace_hits + keyspace_misses) * 100%
```

**–•–æ—Ä–æ—à–∏–π Hit Rate:** >80%

#### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

```bash
docker compose exec redis redis-cli INFO memory | grep used_memory_human
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ù–µ—Å–∫–æ–ª—å–∫–æ MB (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∫–µ—à–∞)

```bash
docker compose exec redis redis-cli INFO memory | grep maxmemory_human
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** `256M` (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ compose.yaml)

#### 3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π

```bash
docker compose exec redis redis-cli DBSIZE
```

**–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π.**

#### 4. –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–ª—é—á–µ–π

```bash
docker compose exec redis redis-cli KEYS 'api:cache:*'
```

**–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∫–ª—é—á–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.**

### –î–µ—Ç–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

#### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–º–∞–Ω–¥ Redis
docker compose exec redis redis-cli MONITOR
```

**–ó–∞—Ç–µ–º –≤ –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:**
```bash
curl -s http://127.0.0.1:8080/helloDoc/users > /dev/null
```

**–í –º–æ–Ω–∏—Ç–æ—Ä–µ —É–≤–∏–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã GET/SET.**

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞

```bash
docker compose exec redis redis-cli OBJECT IDLETIME "api:cache:list_users:helloDoc"
```

**–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥ –∫–ª—é—á –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è.**

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å Apache Bench

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Apache Bench (–µ—Å–ª–∏ –Ω–µ—Ç)

```bash
# macOS
brew install httpd

# Linux
sudo apt-get install apache2-utils
```

#### –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç

```bash
# 100 –∑–∞–ø—Ä–æ—Å–æ–≤ —Å 10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
ab -n 100 -c 10 http://127.0.0.1:8080/helloDoc/users
```

**–ë–µ–∑ –∫–µ—à–∞:**
- Requests per second: ~1 req/sec (–º–µ–¥–ª–µ–Ω–Ω–æ)
- Time per request: ~1000ms

**–° –∫–µ—à–µ–º (–ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞):**
- Requests per second: ~100-200 req/sec (–±—ã—Å—Ç—Ä–æ)
- Time per request: ~10-50ms ‚úÖ

---

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞ 1: cache_enabled = false

**–°–∏–º–ø—Ç–æ–º—ã:**
```bash
curl -s http://127.0.0.1:8080 | jq '.cache_enabled'
# false
```

**–ü—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è:**

#### 1. REDIS_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

```bash
docker compose exec pymongo-api env | grep REDIS
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:** `REDIS_URL=redis://redis:6379`

**–ï—Å–ª–∏ –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `compose.yaml`:**
```yaml
environment:
  REDIS_URL: "redis://redis:6379"
```

#### 2. Redis –Ω–µ –∑–∞–ø—É—â–µ–Ω

```bash
docker compose ps redis
```

**–î–æ–ª–∂–µ–Ω –±—ã—Ç—å:** `running`

```bash
docker compose logs redis
```

**–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫.**

#### 3. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Redis

```bash
docker compose logs pymongo-api | grep -i redis
```

**–ò—â–∏—Ç–µ –æ—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.**

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose restart pymongo-api redis
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ó–∞–ø—Ä–æ—Å—ã –≤—Å–µ –µ—â–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å: ~1.2s ‚úì (–æ–∂–∏–¥–∞–µ—Ç—Å—è)
- –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å: ~1.2s ‚úó (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <100ms)

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**

#### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

```bash
# –°–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å
curl -s http://127.0.0.1:8080/helloDoc/users > /dev/null

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–∏
docker compose exec redis redis-cli KEYS '*'
```

**–î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –∫–ª—é—á `api:cache:list_users:helloDoc`.**

**–ï—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç:**
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: `docker compose logs pymongo-api`

#### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TTL

```bash
docker compose exec redis redis-cli TTL "api:cache:list_users:helloDoc"
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:** –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ (—Å–µ–∫—É–Ω–¥—ã –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è)

**–ï—Å–ª–∏ -1:** –∫–ª—é—á —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –±–µ–∑ TTL (—Å—Ç—Ä–∞–Ω–Ω–æ)  
**–ï—Å–ª–∏ -2:** –∫–ª—é—á –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –∏—Å—Ç–µ–∫

#### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä @cache –ø—Ä–∏–º–µ–Ω–µ–Ω

–í `api_app/app.py` —Å—Ç—Ä–æ–∫–∞ 165:
```python
@cache(expire=60 * 1)
async def list_users(collection_name: str):
```

**–î–æ–ª–∂–µ–Ω –±—ã—Ç—å —ç—Ç–æ—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä.**

### –ü—Ä–æ–±–ª–µ–º–∞ 3: Redis –∑–∞–±—ã–≤–∞–µ—Ç –∫–ª—é—á–∏ —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ö–ª—é—á–∏ –∏—Å—á–µ–∑–∞—é—Ç –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è TTL

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª–∏—Ç–∏–∫–∞ –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è `allkeys-lru` —É–¥–∞–ª—è–µ—Ç –∫–ª—é—á–∏ –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –ø–∞–º—è—Ç–∏.

**–†–µ—à–µ–Ω–∏—è:**

#### 1. –£–≤–µ–ª–∏—á–∏—Ç—å maxmemory

–í `compose.yaml`:
```yaml
command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
```

#### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

```bash
docker compose exec redis redis-cli INFO memory | grep used_memory_human
```

**–ï—Å–ª–∏ –±–ª–∏–∑–∫–æ –∫ 256MB, —É–≤–µ–ª–∏—á—å—Ç–µ –ª–∏–º–∏—Ç.**

#### 3. –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è

```yaml
command: redis-server --maxmemory 256mb --maxmemory-policy volatile-lru
```

**`volatile-lru`** - —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –∫–ª—é—á–∏ —Å TTL (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ)

### –ü—Ä–æ–±–ª–µ–º–∞ 4: –ü–æ—Ä—Ç 6379 –∑–∞–Ω—è—Ç

**–°–∏–º–ø—Ç–æ–º—ã:**
```
Error starting userland proxy: listen tcp4 0.0.0.0:6379: bind: address already in use
```

**–†–µ—à–µ–Ω–∏–µ 1:** –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π Redis

```bash
# macOS
brew services stop redis

# Linux
sudo systemctl stop redis
```

**–†–µ—à–µ–Ω–∏–µ 2:** –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—Ç –≤ `compose.yaml`

```yaml
redis:
  ports:
    - "6380:6379"  # –í–Ω–µ—à–Ω–∏–π –ø–æ—Ä—Ç 6380
```

**–ù–µ –∑–∞–±—É–¥—å—Ç–µ:** REDIS_URL –æ—Å—Ç–∞–µ—Ç—Å—è `redis://redis:6379` (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—Ç)

### –ü—Ä–æ–±–ª–µ–º–∞ 5: –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫–µ—à–µ

**–°–∏–º–ø—Ç–æ–º—ã:**
- –î–∞–Ω–Ω—ã–µ –≤ MongoDB –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –Ω–æ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ

**–ü—Ä–∏—á–∏–Ω–∞:** –ö–µ—à –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è (TTL –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫)

**–†–µ—à–µ–Ω–∏—è:**

#### 1. –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫–µ—à

```bash
docker compose exec redis redis-cli FLUSHALL
```

#### 2. –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á

```bash
docker compose exec redis redis-cli DEL "api:cache:list_users:helloDoc"
```

#### 3. –£–º–µ–Ω—å—à–∏—Ç—å TTL

–í `api_app/app.py`:
```python
@cache(expire=30)  # 30 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ 60
```

**–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
```bash
docker compose up -d --build pymongo-api
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö endpoint'–æ–≤

#### –ü—Ä–∏–º–µ—Ä: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ count

–í `api_app/app.py` –¥–æ–±–∞–≤—å—Ç–µ:

```python
@app.get("/{collection_name}/count")
@cache(expire=30)  # –ö–µ—à –Ω–∞ 30 —Å–µ–∫—É–Ω–¥
async def collection_count(collection_name: str):
    collection = db.get_collection(collection_name)
    items_count = await collection.count_documents({})
    return {"status": "OK", "mongo_db": DATABASE_NAME, "items_count": items_count}
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –∫–µ—à–∞

–í `api_app/app.py` —Å—Ç—Ä–æ–∫–∞ 60:

```python
FastAPICache.init(RedisBackend(redis), prefix="api:cache")
```

**–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞:**
```python
FastAPICache.init(RedisBackend(redis), prefix="myapp:v1")
```

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

**–í–∞—Ä–∏–∞–Ω—Ç 1:** –£–¥–∞–ª–∏—Ç—å REDIS_URL –∏–∑ `compose.yaml`

```yaml
environment:
  MONGODB_URL: "mongodb://mongos:27017"
  MONGODB_DATABASE_NAME: "somedb"
  # REDIS_URL: "redis://redis:6379"  # –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ
```

**–í–∞—Ä–∏–∞–Ω—Ç 2:** –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Redis

```bash
docker compose stop redis
```

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∏—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å—Ç—Ä–æ–∫–∏ 42-45 –≤ `app.py`):
```python
if REDIS_URL:
    cache = cache
else:
    cache = nocache  # –î–µ–∫–æ—Ä–∞—Ç–æ—Ä-–∑–∞–≥–ª—É—à–∫–∞
```

---

## –ò—Ç–æ–≥–∏

### –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω Redis —Å–µ—Ä–≤–∏—Å –≤ `compose.yaml`
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `REDIS_URL`
- ‚úÖ –ó–∞–ø—É—â–µ–Ω–æ 12 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–≤–∫–ª—é—á–∞—è Redis)
- ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è `/helloDoc/users`
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã <100–º—Å (–æ–±—ã—á–Ω–æ 30-50–º—Å)
- ‚úÖ API –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `cache_enabled: true`

### –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ä–µ–≤—å—é–µ—Ä–∞

- [ ] `docker compose ps` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 12 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ —Å—Ç–∞—Ç—É—Å–µ `running`
- [ ] `curl http://127.0.0.1:8080 | jq '.cache_enabled'` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`
- [ ] `curl http://127.0.0.1:8080 | jq '.collections.helloDoc.documents_count'` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `1000`
- [ ] `curl http://127.0.0.1:8080 | jq '.shards'` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 2 —à–∞—Ä–¥–∞ —Å —Ä–µ–ø–ª–∏–∫–∞–º–∏
- [ ] –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ `/helloDoc/users` –∑–∞–Ω–∏–º–∞–µ—Ç ~1.2s
- [ ] –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –∫ `/helloDoc/users` –∑–∞–Ω–∏–º–∞–µ—Ç <100–º—Å ‚úÖ
- [ ] `docker compose exec redis redis-cli KEYS '*'` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–ª—é—á–∏ –∫–µ—à–∞
- [ ] `docker compose exec redis redis-cli INFO stats` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç hits/misses

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

**–ó–∞–¥–∞–Ω–∏–µ 4 –∑–∞–≤–µ—Ä—à–µ–Ω–æ!**

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç:
- **–®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ** (2 —à–∞—Ä–¥–∞) - –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–†–µ–ø–ª–∏–∫–∞—Ü–∏—è** (3 —Ä–µ–ø–ª–∏–∫–∏ –Ω–∞ —à–∞—Ä–¥) - –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** (Redis) - –≤—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ "—á–µ—Ä–Ω–æ–π –ø—è—Ç–Ω–∏—Ü—ã"!** üéâ

---

üìö **–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:**
- üìä [TASK4_SUMMARY.md](TASK4_SUMMARY.md) - —Å–≤–æ–¥–∫–∞ –∑–∞–¥–∞–Ω–∏—è
- üìñ [TASK1_PLANNING.md](TASK1_PLANNING.md) - –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–°—Ö–µ–º–∞ 3)
- üèóÔ∏è [TASK3_SUMMARY.md](TASK3_SUMMARY.md) - –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ
- üé® [diagrams/ARCHITECTURE.md](../diagrams/ARCHITECTURE.md) - –≤—Å–µ —Å—Ö–µ–º—ã
- üè† [README.md](../README.md) - –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–µ–∫—Ç–∞

