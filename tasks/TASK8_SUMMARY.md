# –ó–∞–¥–∞–Ω–∏–µ 8: –í—ã—è–≤–ª–µ–Ω–∏–µ –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ "–≥–æ—Ä—è—á–∏—Ö" —à–∞—Ä–¥–æ–≤

> üî• –°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, –≤—ã—è–≤–ª–µ–Ω–∏—è –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ –≤ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∫–ª–∞—Å—Ç–µ—Ä–µ  
> üè† [‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ README](../README.md) | üìê [–ó–∞–¥–∞–Ω–∏–µ 7: –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–π](TASK7_SUMMARY.md)

---

## üìö –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ü—Ä–æ–±–ª–µ–º–∞ "–≥–æ—Ä—è—á–∏—Ö" —à–∞—Ä–¥–æ–≤](#–ø—Ä–æ–±–ª–µ–º–∞-–≥–æ—Ä—è—á–∏—Ö-—à–∞—Ä–¥–æ–≤)
2. [–ú–µ—Ç—Ä–∏–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞](#–º–µ—Ç—Ä–∏–∫–∏-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)
3. [–í—ã—è–≤–ª–µ–Ω–∏–µ "–≥–æ—Ä—è—á–∏—Ö" —à–∞—Ä–¥–æ–≤](#–≤—ã—è–≤–ª–µ–Ω–∏–µ-–≥–æ—Ä—è—á–∏—Ö-—à–∞—Ä–¥–æ–≤)
4. [–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞](#—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏-—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è-–¥–∏—Å–±–∞–ª–∞–Ω—Å–∞)
5. [–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ](#–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ-–ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)
6. [–ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω—ã–µ –º–µ—Ä—ã](#–ø—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω—ã–µ-–º–µ—Ä—ã)
7. [–ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥ MongoDB](#–ø—Ä–∏–º–µ—Ä—ã-–∫–æ–º–∞–Ω–¥-mongodb)
8. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)

---

## –ü—Ä–æ–±–ª–µ–º–∞ "–≥–æ—Ä—è—á–∏—Ö" —à–∞—Ä–¥–æ–≤

### –û–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏

**–ö–æ–Ω—Ç–µ–∫—Å—Ç**: –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω "–ú–æ–±–∏–ª—å–Ω—ã–π –º–∏—Ä" –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ `{ category: 1, product_id: 1 }` –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `products`.

**–ü—Ä–æ–±–ª–µ–º–∞**:
- –ö–∞—Ç–µ–≥–æ—Ä–∏—è **"–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞"** —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç **70% –∑–∞–ø—Ä–æ—Å–æ–≤**
- –í—Å–µ —Ç–æ–≤–∞—Ä—ã —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ **–æ–¥–Ω–æ–º —à–∞—Ä–¥–µ** (–∏–∑-–∑–∞ Range Sharding)
- –≠—Ç–æ—Ç —à–∞—Ä–¥ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è **"–≥–æ—Ä—è—á–∏–º"** (hot shard)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
```
Shard 1 (electronics): üî•
- CPU: 90%
- –û–ø–µ—Ä–∞—Ü–∏–π/—Å–µ–∫: 15,000
- –†–∞–∑–º–µ—Ä: 80GB

Shard 2 (books, audio): ‚úÖ
- CPU: 20%
- –û–ø–µ—Ä–∞—Ü–∏–π/—Å–µ–∫: 2,000
- –†–∞–∑–º–µ—Ä: 15GB

Shard 3 (appliances): ‚úÖ
- CPU: 30%
- –û–ø–µ—Ä–∞—Ü–∏–π/—Å–µ–∫: 3,000
- –†–∞–∑–º–µ—Ä: 25GB
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ**:
- ‚ùå –û–¥–∏–Ω —à–∞—Ä–¥ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω ‚Üí –º–µ–¥–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- ‚ùå –î—Ä—É–≥–∏–µ —à–∞—Ä–¥—ã –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—Ç ‚Üí –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚ùå –†–∏—Å–∫ –ø–∞–¥–µ–Ω–∏—è "–≥–æ—Ä—è—á–µ–≥–æ" —à–∞—Ä–¥–∞
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

---

## –ú–µ—Ç—Ä–∏–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### 1. –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (Performance)

#### 1.1 –û–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Å–µ–∫—É–Ω–¥—É (ops/sec)

**–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π (read/write) –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞—Ä–¥–µ.

**–ö–æ–º–∞–Ω–¥–∞ MongoDB**:
```javascript
// –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–∞–∂–¥–æ–º—É —à–∞—Ä–¥—É –Ω–∞–ø—Ä—è–º—É—é
mongosh --host shard1-1:27018

// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–ø–µ—Ä–∞—Ü–∏–π
db.serverStatus().opcounters

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
  insert: 123456,
  query: 789012,
  update: 345678,
  delete: 12345,
  getmore: 56789,
  command: 234567
}

// –í—ã—á–∏—Å–ª–∏—Ç—å ops/sec (–Ω—É–∂–Ω–æ –∑–∞–º–µ—Ä–∏—Ç—å –¥–≤–∞–∂–¥—ã —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º)
```

**–§–æ—Ä–º—É–ª–∞**:
```
ops/sec = (total_ops_now - total_ops_before) / time_interval

total_ops = insert + query + update + delete + getmore
```

**–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**:
- ‚úÖ –ù–æ—Ä–º–∞: < 5,000 ops/sec
- ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: 5,000 - 10,000 ops/sec
- üî• –ö—Ä–∏—Ç–∏—á–Ω–æ: > 10,000 ops/sec

**MongoDB Atlas –º–µ—Ç—Ä–∏–∫–∞**: `Operations/sec` (–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ UI)

#### 1.2 Latency (–∑–∞–¥–µ—Ä–∂–∫–∞)

**–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º**: –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã.

**–ö–æ–º–∞–Ω–¥–∞**:
```javascript
// –í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
db.setProfilingLevel(1, { slowms: 100 })

// –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
db.system.profile.find({ millis: { $gt: 100 } }).sort({ ts: -1 }).limit(10)

// –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞
db.system.profile.aggregate([
  { $match: { ns: "mobile_world.products" } },
  { $group: { _id: null, avgLatency: { $avg: "$millis" } } }
])
```

**–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**:
- ‚úÖ –ù–æ—Ä–º–∞: < 50ms
- ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: 50-200ms
- üî• –ö—Ä–∏—Ç–∏—á–Ω–æ: > 200ms

#### 1.3 Query Queue (–æ—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤)

**–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏.

**–ö–æ–º–∞–Ω–¥–∞**:
```javascript
db.serverStatus().globalLock.currentQueue

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
  total: 15,      // –û–±—â–∞—è –æ—á–µ—Ä–µ–¥—å
  readers: 10,    // –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ —á—Ç–µ–Ω–∏–µ
  writers: 5      // –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –∑–∞–ø–∏—Å—å
}
```

**–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**:
- ‚úÖ –ù–æ—Ä–º–∞: < 10
- ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: 10-50
- üî• –ö—Ä–∏—Ç–∏—á–Ω–æ: > 50

### 2. –ú–µ—Ç—Ä–∏–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ (Resources)

#### 2.1 CPU —É—Ç–∏–ª–∏–∑–∞—Ü–∏—è

**–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º**: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞.

**–ö–æ–º–∞–Ω–¥–∞ —Å–∏—Å—Ç–µ–º–Ω–∞—è**:
```bash
# –ù–∞ —Ö–æ—Å—Ç–µ —à–∞—Ä–¥–∞
top -bn1 | grep mongod

# –ò–ª–∏ —á–µ—Ä–µ–∑ ps
ps aux | grep mongod | awk '{print $3}'

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
vmstat 1
```

**MongoDB –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**:
```javascript
db.serverStatus().extra_info.page_faults  // Page faults - –∫–æ—Å–≤–µ–Ω–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä CPU
```

**–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**:
- ‚úÖ –ù–æ—Ä–º–∞: < 60%
- ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: 60-80%
- üî• –ö—Ä–∏—Ç–∏—á–Ω–æ: > 80%

#### 2.2 Memory (RAM)

**–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏.

**–ö–æ–º–∞–Ω–¥–∞**:
```javascript
db.serverStatus().mem

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
  bits: 64,
  resident: 4096,    // RAM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å–æ–º (MB)
  virtual: 8192,     // –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å (MB)
  supported: true
}

// WiredTiger cache
db.serverStatus().wiredTiger.cache

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
  "bytes currently in the cache": 3221225472,  // ~3GB
  "maximum bytes configured": 4294967296,      // ~4GB (50% RAM –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  "bytes read into cache": 10737418240,
  "bytes written from cache": 5368709120,
  "pages evicted by application threads": 1024,
  "pages read into cache": 262144,
  "pages written from cache": 131072
}
```

**–§–æ—Ä–º—É–ª–∞**:
```
memory_usage_percent = (resident / total_ram) * 100
cache_usage_percent = (bytes_in_cache / max_cache) * 100
```

**–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**:
- ‚úÖ –ù–æ—Ä–º–∞: < 70% RAM
- ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: 70-85% RAM
- üî• –ö—Ä–∏—Ç–∏—á–Ω–æ: > 85% RAM

#### 2.3 Disk I/O

**–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º**: –°–∫–æ—Ä–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ –Ω–∞ –¥–∏—Å–∫.

**–ö–æ–º–∞–Ω–¥–∞ —Å–∏—Å—Ç–µ–º–Ω–∞—è**:
```bash
# iostat –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ I/O
iostat -x 1

# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
# %util - —É—Ç–∏–ª–∏–∑–∞—Ü–∏—è –¥–∏—Å–∫–∞
# r/s - —á—Ç–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
# w/s - –∑–∞–ø–∏—Å–µ–π –≤ —Å–µ–∫—É–Ω–¥—É
# rkB/s - –∫–∏–ª–æ–±–∞–π—Ç —á–∏—Ç–∞–µ—Ç—Å—è –≤ —Å–µ–∫—É–Ω–¥—É
# wkB/s - –∫–∏–ª–æ–±–∞–π—Ç –ø–∏—à–µ—Ç—Å—è –≤ —Å–µ–∫—É–Ω–¥—É
```

**MongoDB —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**:
```javascript
db.serverStatus().wiredTiger.transaction

{
  "transaction checkpoint max time (msecs)": 500,
  "transaction checkpoint min time (msecs)": 100
}
```

**–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**:
- ‚úÖ –ù–æ—Ä–º–∞: %util < 70%
- ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: %util 70-90%
- üî• –ö—Ä–∏—Ç–∏—á–Ω–æ: %util > 90%

### 3. –ú–µ—Ç—Ä–∏–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (Data Distribution)

#### 3.1 –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —à–∞—Ä–¥–∞—Ö

**–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞—Ä–¥–µ.

**–ö–æ–º–∞–Ω–¥–∞**:
```javascript
// –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ mongos
db.products.getShardDistribution()

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
Shard shard1 at shard1-1:27018,shard1-2:27018,shard1-3:27018
 data : 80GiB docs : 50000000 chunks : 120
 estimated data per chunk : 682MiB
 estimated docs per chunk : 416666

Shard shard2 at shard2-1:27018,shard2-2:27018,shard2-3:27018
 data : 15GiB docs : 10000000 chunks : 30
 estimated data per chunk : 512MiB
 estimated docs per chunk : 333333

Totals
 data : 95GiB docs : 60000000 chunks : 150
 Shard shard1 contains 84.2% data, 83.3% docs in cluster  üî• –ü–†–û–ë–õ–ï–ú–ê!
 Shard shard2 contains 15.8% data, 16.7% docs in cluster
```

**–ò–¥–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –ö–∞–∂–¥—ã–π —à–∞—Ä–¥ ~ 50% (–¥–ª—è 2 —à–∞—Ä–¥–æ–≤)

**–î–æ–ø—É—Å—Ç–∏–º–æ–µ**: ¬±10% –æ—Ç –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ  
**–ü—Ä–æ–±–ª–µ–º–Ω–æ–µ**: ¬±20% –æ—Ç –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ üî•

#### 3.2 –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ (chunks)

**–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞—Ä–¥–µ.

**–ö–æ–º–∞–Ω–¥–∞**:
```javascript
// –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ –ø–æ —à–∞—Ä–¥–∞–º
db.getSiblingDB("config").chunks.aggregate([
  { $match: { ns: "mobile_world.products" } },
  { $group: { _id: "$shard", count: { $sum: 1 } } },
  { $sort: { count: -1 } }
])

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
[
  { _id: "shard1", count: 120 },  // 80% —á–∞–Ω–∫–æ–≤ üî•
  { _id: "shard2", count: 30 }    // 20% —á–∞–Ω–∫–æ–≤
]

// –†–∞–∑–º–µ—Ä –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞
db.getSiblingDB("config").chunks.find({ ns: "mobile_world.products" }).forEach(chunk => {
  print(`Chunk: ${chunk.min.category} - ${chunk.max.category}, Shard: ${chunk.shard}`)
})
```

**–ò–¥–µ–∞–ª—å–Ω–æ–µ**: –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤  
**–ü—Ä–æ–±–ª–µ–º–∞**: –ë–æ–ª—å—à–æ–π –¥–∏—Å–±–∞–ª–∞–Ω—Å (80% vs 20%)

#### 3.3 Jumbo chunks (–æ–≥—Ä–æ–º–Ω—ã–µ —á–∞–Ω–∫–∏)

**–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º**: –ß–∞–Ω–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å split.

**–ö–æ–º–∞–Ω–¥–∞**:
```javascript
// –ù–∞–π—Ç–∏ jumbo chunks
db.getSiblingDB("config").chunks.find({ 
  ns: "mobile_world.products",
  jumbo: true 
})

// –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ jumbo chunks
db.getSiblingDB("config").chunks.count({ 
  ns: "mobile_world.products",
  jumbo: true 
})
```

**–ü—Ä–æ–±–ª–µ–º–∞**: Jumbo chunks –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å ‚Üí –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞

**–†–µ—à–µ–Ω–∏–µ**: Refine shard key (—Å–º. –Ω–∏–∂–µ)

### 4. –ú–µ—Ç—Ä–∏–∫–∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ (Balancing)

#### 4.1 Balancer status

**–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º**: –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫, –∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è.

**–ö–æ–º–∞–Ω–¥–∞**:
```javascript
sh.getBalancerState()  // true/false

sh.isBalancerRunning()  // true/false (–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å)

// –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
db.getSiblingDB("config").mongos.find().pretty()

// –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
db.getSiblingDB("config").actionlog.find({ what: "balancer.round" }).sort({ time: -1 }).limit(1)
```

#### 4.2 Migration failures

**–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º**: –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —á–∞–Ω–∫–æ–≤.

**–ö–æ–º–∞–Ω–¥–∞**:
```javascript
// –õ–æ–≥–∏ –º–∏–≥—Ä–∞—Ü–∏–π
db.getSiblingDB("config").changelog.find({ 
  what: /moveChunk/,
  "details.errmsg": { $exists: true }
}).sort({ time: -1 }).limit(10)
```

### 5. –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Application Level)

#### 5.1 Targeted vs Scatter-Gather queries

**–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º**: –°–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–¥—É—Ç –Ω–∞ –æ–¥–∏–Ω —à–∞—Ä–¥ (targeted) vs –≤—Å–µ —à–∞—Ä–¥—ã (scatter-gather).

**–ö–æ–º–∞–Ω–¥–∞**:
```javascript
// Explain –∑–∞–ø—Ä–æ—Å–∞
db.products.find({ category: "electronics" }).explain("executionStats")

// –ï—Å–ª–∏ "stage": "SINGLE_SHARD" ‚Üí targeted (—Ö–æ—Ä–æ—à–æ) ‚úÖ
// –ï—Å–ª–∏ "stage": "SHARD_MERGE" ‚Üí scatter-gather (–ø–ª–æ—Ö–æ) ‚ùå

// –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞—Ä–¥–æ–≤, –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–º
db.products.find({ category: "electronics" }).explain("executionStats").queryPlanner.winningPlan.shards.length

// 1 shard = targeted ‚úÖ
// 2+ shards = scatter-gather ‚ùå
```

**–¶–µ–ª—å**: –ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å targeted queries (>80%)

#### 5.2 –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

**–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º**: –ö–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è —á–∞—â–µ –≤—Å–µ–≥–æ.

**–ö–æ–º–∞–Ω–¥–∞ (–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)**:
```python
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
import logging
from collections import Counter

query_counter = Counter()

def query_products(category):
    query_counter[category] += 1
    return db.products.find({"category": category})

# –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤—ã–≤–æ–¥–∏—Ç—å —Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π
def print_hot_categories():
    for category, count in query_counter.most_common(10):
        percentage = (count / sum(query_counter.values())) * 100
        print(f"{category}: {count} queries ({percentage:.1f}%)")
        
        if percentage > 30:
            print(f"‚ö†Ô∏è  WARNING: {category} is a hot category!")
```

---

## –í—ã—è–≤–ª–µ–Ω–∏–µ "–≥–æ—Ä—è—á–∏—Ö" —à–∞—Ä–¥–æ–≤

### –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã—è–≤–ª–µ–Ω–∏—è

**–®–∞–≥ 1**: –°—Ä–∞–≤–Ω–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤—Å–µ—Ö —à–∞—Ä–¥–æ–≤

```javascript
// –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —à–∞—Ä–¥–æ–≤
const shards = ["shard1", "shard2", "shard3"]
const metrics = {}

for (const shard of shards) {
  // –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ primary —à–∞—Ä–¥–∞
  const conn = connect(`${shard}-1:27018`)
  
  metrics[shard] = {
    ops: conn.serverStatus().opcounters,
    cpu: conn.serverStatus().extra_info.page_faults,
    memory: conn.serverStatus().mem.resident,
    connections: conn.serverStatus().connections.current,
    queueDepth: conn.serverStatus().globalLock.currentQueue.total
  }
}

// –°—Ä–∞–≤–Ω–∏—Ç—å
printjson(metrics)
```

**–®–∞–≥ 2**: –í—ã—á–∏—Å–ª–∏—Ç—å –¥–∏—Å–±–∞–ª–∞–Ω—Å

```javascript
function calculateImbalance(metrics) {
  const values = Object.values(metrics).map(m => m.ops.query)
  const avg = values.reduce((a, b) => a + b) / values.length
  const max = Math.max(...values)
  const min = Math.min(...values)
  
  const imbalance = ((max - avg) / avg) * 100
  
  print(`–°—Ä–µ–¥–Ω–µ–µ: ${avg} ops/sec`)
  print(`–ú–∞–∫—Å–∏–º—É–º: ${max} ops/sec`)
  print(`–ú–∏–Ω–∏–º—É–º: ${min} ops/sec`)
  print(`–î–∏—Å–±–∞–ª–∞–Ω—Å: ${imbalance.toFixed(1)}%`)
  
  if (imbalance > 50) {
    print("üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –î–ò–°–ë–ê–õ–ê–ù–°!")
  } else if (imbalance > 25) {
    print("‚ö†Ô∏è  –î–∏—Å–±–∞–ª–∞–Ω—Å –æ–±–Ω–∞—Ä—É–∂–µ–Ω")
  } else {
    print("‚úÖ –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –≤ –Ω–æ—Ä–º–µ")
  }
}
```

**–®–∞–≥ 3**: –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å "–≥–æ—Ä—è—á–∏–π" —à–∞—Ä–¥

```javascript
function identifyHotShard() {
  // 1. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  db.products.getShardDistribution()
  
  // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∞–Ω–∫–æ–≤
  const chunksPerShard = {}
  db.getSiblingDB("config").chunks.aggregate([
    { $match: { ns: "mobile_world.products" } },
    { $group: { _id: "$shard", count: { $sum: 1 } } }
  ]).forEach(doc => {
    chunksPerShard[doc._id] = doc.count
  })
  
  // 3. –ù–∞–π—Ç–∏ —à–∞—Ä–¥ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–∞–Ω–Ω—ã—Ö
  print("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤:")
  printjson(chunksPerShard)
  
  // 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å jumbo chunks
  const jumboChunks = db.getSiblingDB("config").chunks.find({
    ns: "mobile_world.products",
    jumbo: true
  }).count()
  
  if (jumboChunks > 0) {
    print(`‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–æ ${jumboChunks} jumbo chunks - –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–∏—á–∏–Ω–æ–π –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞`)
  }
}
```

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏**:

```javascript
// monitor_shards.js

function monitorShards() {
  const timestamp = new Date()
  const report = {
    timestamp: timestamp,
    shards: {}
  }
  
  // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —à–∞—Ä–¥–æ–≤
  const shards = db.getSiblingDB("config").shards.find().toArray()
  
  for (const shard of shards) {
    const shardName = shard._id
    const host = shard.host.split("/")[1].split(",")[0]  // –ü–µ—Ä–≤—ã–π —Ö–æ—Å—Ç
    
    try {
      const conn = connect(host)
      const status = conn.serverStatus()
      
      report.shards[shardName] = {
        host: host,
        opcounters: status.opcounters,
        memory: status.mem,
        connections: status.connections,
        queueDepth: status.globalLock.currentQueue
      }
    } catch (e) {
      report.shards[shardName] = { error: e.message }
    }
  }
  
  // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  report.distribution = {}
  db.getSiblingDB("config").chunks.aggregate([
    { $match: { ns: "mobile_world.products" } },
    { $group: { _id: "$shard", chunks: { $sum: 1 } } }
  ]).forEach(doc => {
    report.distribution[doc._id] = doc.chunks
  })
  
  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  db.getSiblingDB("monitoring").shard_metrics.insertOne(report)
  
  // –ê–Ω–∞–ª–∏–∑
  analyzeReport(report)
}

function analyzeReport(report) {
  // –í—ã—á–∏—Å–ª–∏—Ç—å –¥–∏—Å–±–∞–ª–∞–Ω—Å —á–∞–Ω–∫–æ–≤
  const chunks = Object.values(report.distribution)
  const avgChunks = chunks.reduce((a, b) => a + b) / chunks.length
  const maxChunks = Math.max(...chunks)
  
  const imbalance = ((maxChunks - avgChunks) / avgChunks) * 100
  
  if (imbalance > 30) {
    print(`üî• ALERT: Chunk imbalance detected: ${imbalance.toFixed(1)}%`)
    print(`Recommendation: Run balancer or manual redistribution`)
    
    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç
    sendAlert({
      level: "CRITICAL",
      message: `Shard chunk imbalance: ${imbalance.toFixed(1)}%`,
      timestamp: new Date()
    })
  }
}

function sendAlert(alert) {
  // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞ (PagerDuty, Slack, email)
  db.getSiblingDB("monitoring").alerts.insertOne(alert)
  print(`Alert sent: ${alert.message}`)
}

// –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
while (true) {
  monitorShards()
  sleep(5 * 60 * 1000)  // 5 –º–∏–Ω—É—Ç
}
```

**–ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**:
```bash
mongosh --host mongos:27017 --file monitor_shards.js &
```

---

## –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: Split Chunks (–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –ë–æ–ª—å—à–∏–µ —á–∞–Ω–∫–∏ –Ω—É–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –º–µ–Ω—å—à–∏–µ –¥–ª—è –ª—É—á—à–µ–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç**:
```
–ë—ã–ª–æ:
Chunk 1: { category: "electronics", product_id: MinKey } -> { category: "electronics", product_id: MaxKey }
–†–∞–∑–º–µ—Ä: 80GB –Ω–∞ shard1 üî•

–°—Ç–∞–ª–æ:
Chunk 1a: { category: "electronics", product_id: MinKey } -> { category: "electronics", product_id: "PROD-50000" }
Chunk 1b: { category: "electronics", product_id: "PROD-50000" } -> { category: "electronics", product_id: MaxKey }
–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å Chunk 1b –Ω–∞ shard2
```

**–ö–æ–º–∞–Ω–¥—ã**:

```javascript
// 1. –ù–∞–π—Ç–∏ —Ç–æ—á–∫—É split (—Å—Ä–µ–¥–Ω–∏–π product_id –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
db.products.aggregate([
  { $match: { category: "electronics" } },
  { $sort: { product_id: 1 } },
  { $skip: 25000000 },  // –ü–æ–ª–æ–≤–∏–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  { $limit: 1 },
  { $project: { _id: 0, product_id: 1 } }
])
// –†–µ–∑—É–ª—å—Ç–∞—Ç: { product_id: "PROD-50000" }

// 2. Split chunk –ø–æ —ç—Ç–æ–π —Ç–æ—á–∫–µ
sh.splitAt("mobile_world.products", { 
  category: "electronics", 
  product_id: "PROD-50000" 
})

// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: Auto-split –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
sh.splitFind("mobile_world.products", { 
  category: "electronics", 
  product_id: "PROD-50000" 
})

// 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
db.getSiblingDB("config").chunks.find({ 
  ns: "mobile_world.products",
  "min.category": "electronics"
}).count()
// –ë—ã–ª–æ: 1 chunk
// –°—Ç–∞–ª–æ: 2+ chunks
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π split**:
```javascript
// –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π split –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
db.getSiblingDB("config").settings.updateOne(
  { _id: "chunksize" },
  { $set: { value: 32 } },  // 32MB –≤–º–µ—Å—Ç–æ 64MB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  { upsert: true }
)
```

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: Move Chunks (–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –ü–æ—Å–ª–µ split –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —á–∞–Ω–∫–∏ –Ω–∞ –º–µ–Ω–µ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —à–∞—Ä–¥—ã.

**–ö–æ–º–∞–Ω–¥—ã**:

```javascript
// 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–æ–π —á–∞–Ω–∫ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å
db.getSiblingDB("config").chunks.find({
  ns: "mobile_world.products",
  shard: "shard1",
  "min.category": "electronics"
}).sort({ "min.product_id": 1 }).pretty()

// 2. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å chunk –Ω–∞ shard2
sh.moveChunk(
  "mobile_world.products",
  { category: "electronics", product_id: "PROD-50000" },  // –ì—Ä–∞–Ω–∏—Ü–∞ chunk
  "shard2"  // –¶–µ–ª–µ–≤–æ–π —à–∞—Ä–¥
)

// 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏
db.getSiblingDB("config").changelog.find({ 
  what: "moveChunk.from",
  ns: "mobile_world.products"
}).sort({ time: -1 }).limit(1).pretty()

// 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
db.products.getShardDistribution()
```

**Batch –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ** (–Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞–Ω–∫–æ–≤):

```javascript
// –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å 10 —á–∞–Ω–∫–æ–≤ —Å shard1 –Ω–∞ shard2
const chunksToMove = db.getSiblingDB("config").chunks.find({
  ns: "mobile_world.products",
  shard: "shard1"
}).limit(10).toArray()

for (const chunk of chunksToMove) {
  print(`Moving chunk: ${chunk.min.category} - ${chunk.min.product_id}`)
  
  sh.moveChunk(
    "mobile_world.products",
    chunk.min,
    "shard2"
  )
  
  // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –º–∏–≥—Ä–∞—Ü–∏—è–º–∏, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ç—å
  sleep(10000)  // 10 —Å–µ–∫—É–Ω–¥
}
```

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è 3: Zone Sharding (–ó–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –ù–∞–∑–Ω–∞—á–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞—Ä–¥—ã.

**–°—Ü–µ–Ω–∞—Ä–∏–π**: –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ—â–Ω—ã–µ —à–∞—Ä–¥—ã.

**–ö–æ–º–∞–Ω–¥—ã**:

```javascript
// 1. –°–æ–∑–¥–∞—Ç—å –∑–æ–Ω—ã (tags)
sh.addShardTag("shard1", "hot_categories")   // –ú–æ—â–Ω—ã–π —à–∞—Ä–¥
sh.addShardTag("shard2", "medium_categories")
sh.addShardTag("shard3", "cold_categories")

// 2. –ù–∞–∑–Ω–∞—á–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–∞ –∑–æ–Ω—ã
//    Electronics (70% –∑–∞–ø—Ä–æ—Å–æ–≤) ‚Üí hot_categories (shard1)
sh.addTagRange(
  "mobile_world.products",
  { category: "electronics", product_id: MinKey },
  { category: "electronics", product_id: MaxKey },
  "hot_categories"
)

//    Books, Audio (20% –∑–∞–ø—Ä–æ—Å–æ–≤) ‚Üí medium_categories (shard2)
sh.addTagRange(
  "mobile_world.products",
  { category: "books", product_id: MinKey },
  { category: "books", product_id: MaxKey },
  "medium_categories"
)

sh.addTagRange(
  "mobile_world.products",
  { category: "audio", product_id: MinKey },
  { category: "audio", product_id: MaxKey },
  "medium_categories"
)

//    –û—Å—Ç–∞–ª—å–Ω—ã–µ ‚Üí cold_categories (shard3)
sh.addTagRange(
  "mobile_world.products",
  { category: "appliances", product_id: MinKey },
  { category: "appliances", product_id: MaxKey },
  "cold_categories"
)

// 3. –í–∫–ª—é—á–∏—Ç—å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —á–∞–Ω–∫–æ–≤ –≤ –∑–æ–Ω—ã
sh.startBalancer()

// 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–æ–Ω—ã
sh.status()
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∑–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è**:
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ú–æ–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å –º–æ—â–Ω—ã–π —à–∞—Ä–¥ –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- ‚úÖ –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (US, EU, Asia)

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è 4: Refine Shard Key (–£—Ç–æ—á–Ω–µ–Ω–∏–µ —à–∞—Ä–¥-–∫–ª—é—á–∞)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –¢–µ–∫—É—â–∏–π —à–∞—Ä–¥-–∫–ª—é—á –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≥—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–π (jumbo chunks).

**–ü—Ä–æ–±–ª–µ–º–∞**:
```
Shard key: { category: 1, product_id: 1 }

Jumbo chunk:
{ category: "electronics", product_id: MinKey } -> { category: "electronics", product_id: MaxKey }
–†–∞–∑–º–µ—Ä: 80GB
–ù–µ–ª—å–∑—è split –¥–∞–ª—å—à–µ –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–π –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ category
```

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ —Å –≤—ã—Å–æ–∫–æ–π –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é.

**–ù–æ–≤—ã–π —à–∞—Ä–¥-–∫–ª—é—á**: `{ category: 1, product_id: 1, _id: 1 }`

**–ö–æ–º–∞–Ω–¥–∞ (MongoDB 4.4+)**:
```javascript
db.adminCommand({
  refineCollectionShardKey: "mobile_world.products",
  key: { category: 1, product_id: 1, _id: 1 }
})
```

**–≠—Ñ—Ñ–µ–∫—Ç**:
- Jumbo chunks —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ split –ø–æ `_id`
- –ë–æ–ª–µ–µ –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
- –õ—É—á—à–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞

**–í–∞–∂–Ω–æ**: –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –ø–µ—Ä–µ–¥ refine:
```javascript
db.products.createIndex({ category: 1, product_id: 1, _id: 1 })
```

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è 5: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å –Ω–æ–≤—ã–º —à–∞—Ä–¥-–∫–ª—é—á–æ–º

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: Refine –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç, –Ω—É–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é.

**–ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥**: Hashed Sharding –ø–æ `{ category: "hashed", product_id: "hashed" }`

**–ü–ª–∞–Ω**:
```javascript
// 1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
db.createCollection("products_v2")

// 2. –°–æ–∑–¥–∞—Ç—å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å
db.products_v2.createIndex({ category: "hashed", product_id: "hashed" })

// 3. –®–∞—Ä–¥–∏—Ä–æ–≤–∞—Ç—å —Å hashed –∫–ª—é—á–æ–º
sh.shardCollection("mobile_world.products_v2", { 
  category: "hashed", 
  product_id: "hashed" 
})

// 4. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å)
const cursor = db.products.find().batchSize(1000)
while (cursor.hasNext()) {
  const batch = []
  for (let i = 0; i < 1000 && cursor.hasNext(); i++) {
    batch.push(cursor.next())
  }
  db.products_v2.insertMany(batch, { ordered: false })
  sleep(100)  // –ü–∞—É–∑–∞
}

// 5. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ products_v2
// 6. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
db.products.drop()

// 7. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
db.products_v2.renameCollection("products")
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏**:
- ‚ùå –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å—Ç–∞–Ω–µ—Ç scatter-gather
- ‚ùå Downtime –≤–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏

---

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

### –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π Balancer MongoDB

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç**:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç —á–∞–Ω–∫–∏ –º–µ–∂–¥—É —à–∞—Ä–¥–∞–º–∏
- –†–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ
- –¶–µ–ª—å: —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤

**–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å**:
```javascript
// –í–∫–ª—é—á–∏—Ç—å
sh.startBalancer()

// –í—ã–∫–ª—é—á–∏—Ç—å
sh.stopBalancer()

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sh.getBalancerState()
sh.isBalancerRunning()
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫–Ω–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏** (—á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –ø—Ä–æ–¥–∞–∫—à–Ω—É):
```javascript
// –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–æ—á—å—é (02:00 - 06:00)
db.getSiblingDB("config").settings.updateOne(
  { _id: "balancer" },
  { 
    $set: { 
      activeWindow: {
        start: "02:00",
        stop: "06:00"
      }
    }
  },
  { upsert: true }
)

// –û—Ç–∫–ª—é—á–∏—Ç—å –æ–∫–Ω–æ (–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –≤—Å–µ–≥–¥–∞)
db.getSiblingDB("config").settings.updateOne(
  { _id: "balancer" },
  { $unset: { activeWindow: "" } }
)
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏**:
```javascript
// –ú–∞–∫—Å–∏–º—É–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
db.getSiblingDB("config").settings.updateOne(
  { _id: "balancer" },
  { $set: { "_secondaryThrottle": false } },  // –ë—ã—Å—Ç—Ä–µ–µ, –Ω–æ –±–æ–ª—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞
  { upsert: true }
)

// –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ (–º–µ–Ω—å—à–µ = –±–æ–ª–µ–µ –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞)
db.getSiblingDB("config").settings.updateOne(
  { _id: "chunksize" },
  { $set: { value: 32 } },  // 32MB
  { upsert: true }
)
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏

```javascript
// –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
db.getSiblingDB("config").changelog.find({ 
  what: /balancer/ 
}).sort({ time: -1 }).limit(10).pretty()

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π
db.getSiblingDB("config").changelog.aggregate([
  { $match: { what: "moveChunk.from" } },
  { $group: {
      _id: "$details.from",
      migrations: { $sum: 1 },
      totalTime: { $sum: "$details.step6.millis" }
    }
  }
])
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏

**–ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞** –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫:

```javascript
// auto_balance.js

function autoBalance() {
  // 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∏—Å–±–∞–ª–∞–Ω—Å —á–∞–Ω–∫–æ–≤
  const distribution = {}
  db.getSiblingDB("config").chunks.aggregate([
    { $match: { ns: "mobile_world.products" } },
    { $group: { _id: "$shard", chunks: { $sum: 1 } } }
  ]).forEach(doc => {
    distribution[doc._id] = doc.chunks
  })
  
  const chunks = Object.values(distribution)
  const avgChunks = chunks.reduce((a, b) => a + b) / chunks.length
  const maxChunks = Math.max(...chunks)
  const minChunks = Math.min(...chunks)
  
  const imbalance = ((maxChunks - minChunks) / avgChunks) * 100
  
  print(`Chunk distribution: ${JSON.stringify(distribution)}`)
  print(`Imbalance: ${imbalance.toFixed(1)}%`)
  
  // 2. –ï—Å–ª–∏ –¥–∏—Å–±–∞–ª–∞–Ω—Å > 20%, –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É
  if (imbalance > 20) {
    print("üî• Imbalance detected! Starting balancer...")
    
    // –ù–∞–π—Ç–∏ "–≥–æ—Ä—è—á–∏–π" —à–∞—Ä–¥ (—Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —á–∞–Ω–∫–æ–≤)
    const hotShard = Object.keys(distribution).reduce((a, b) => 
      distribution[a] > distribution[b] ? a : b
    )
    
    // –ù–∞–π—Ç–∏ "—Ö–æ–ª–æ–¥–Ω—ã–π" —à–∞—Ä–¥ (—Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —á–∞–Ω–∫–æ–≤)
    const coldShard = Object.keys(distribution).reduce((a, b) => 
      distribution[a] < distribution[b] ? a : b
    )
    
    print(`Hot shard: ${hotShard} (${distribution[hotShard]} chunks)`)
    print(`Cold shard: ${coldShard} (${distribution[coldShard]} chunks)`)
    
    // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞–Ω–∫–æ–≤ —Å –≥–æ—Ä—è—á–µ–≥–æ –Ω–∞ —Ö–æ–ª–æ–¥–Ω—ã–π
    const chunksToMove = Math.floor((distribution[hotShard] - avgChunks) / 2)
    
    print(`Moving ${chunksToMove} chunks from ${hotShard} to ${coldShard}`)
    
    const chunksToMigrate = db.getSiblingDB("config").chunks.find({
      ns: "mobile_world.products",
      shard: hotShard
    }).limit(chunksToMove).toArray()
    
    for (const chunk of chunksToMigrate) {
      try {
        print(`Migrating chunk: ${JSON.stringify(chunk.min)}`)
        sh.moveChunk("mobile_world.products", chunk.min, coldShard)
        sleep(5000)  // –ü–∞—É–∑–∞ 5 —Å–µ–∫ –º–µ–∂–¥—É –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
      } catch (e) {
        print(`Error migrating chunk: ${e.message}`)
      }
    }
    
    print("‚úÖ Rebalancing completed")
  } else {
    print("‚úÖ Chunks are balanced")
  }
}

// –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
while (true) {
  autoBalance()
  sleep(30 * 60 * 1000)  // 30 –º–∏–Ω—É—Ç
}
```

**–ó–∞–ø—É—Å–∫**:
```bash
mongosh --host mongos:27017 --file auto_balance.js &
```

---

## –ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω—ã–µ –º–µ—Ä—ã

### 1. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä —à–∞—Ä–¥-–∫–ª—é—á–∞

**–ü—Ä–∏–Ω—Ü–∏–ø—ã**:
- ‚úÖ –í—ã—Å–æ–∫–∞—è –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ Targeted queries (–Ω–µ scatter-gather)

**–î–ª—è products**: –í–º–µ—Å—Ç–æ `{ category: 1, product_id: 1 }` —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å:

**–í–∞—Ä–∏–∞–Ω—Ç A**: Composite hashed
```javascript
// –î–æ–±–∞–≤–∏—Ç—å hash prefix
db.products.createIndex({ category_hash: "hashed", category: 1, product_id: 1 })

// category_hash = hash(category) % 10  // 10 bucket'–æ–≤

sh.shardCollection("mobile_world.products", { 
  category_hash: 1,  // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ bucket'–∞–º
  category: 1,       // –õ–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
  product_id: 1 
})
```

**–≠—Ñ—Ñ–µ–∫—Ç**: "Electronics" —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –ø–æ 10 bucket'–∞–º ‚Üí –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞—Ä–¥–æ–≤

**–í–∞—Ä–∏–∞–Ω—Ç B**: Zone-based sharding —Å pre-split

```javascript
// Pre-split –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
for (let i = 0; i < 100; i++) {
  sh.splitAt("mobile_world.products", {
    category: "electronics",
    product_id: `PROD-${i * 1000}`
  })
}

// –ó–∞—Ç–µ–º zone sharding –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
```

### 2. Monitoring & Alerting

**–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã** –Ω–∞:
- CPU > 80% –Ω–∞ –ª—é–±–æ–º —à–∞—Ä–¥–µ
- Chunk imbalance > 30%
- Queue depth > 50
- Latency > 200ms

**–ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Prometheus**:

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'mongodb'
    static_configs:
      - targets:
          - 'shard1-1:9216'
          - 'shard2-1:9216'
          - 'shard3-1:9216'
```

**Grafana dashboard**: –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `MongoDB Overview` dashboard

### 3. Capacity Planning

**–ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å —Ä–æ—Å—Ç** –∏ –¥–æ–±–∞–≤–∏—Ç—å —à–∞—Ä–¥—ã –∑–∞—Ä–∞–Ω–µ–µ:

```javascript
// –¢–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
db.products.stats().size / (1024 ** 3)  // GB

// –ü—Ä–æ–≥–Ω–æ–∑: –µ—Å–ª–∏ —Ä–æ—Å—Ç 20% –≤ –º–µ—Å—è—Ü
const monthlyGrowth = 0.20
const currentSize = 95  // GB
const projectedSize = currentSize * Math.pow(1 + monthlyGrowth, 12)  // –ß–µ—Ä–µ–∑ –≥–æ–¥

print(`Projected size in 1 year: ${projectedSize.toFixed(0)} GB`)

// –ï—Å–ª–∏ projected > threshold, –¥–æ–±–∞–≤–∏—Ç—å —à–∞—Ä–¥—ã
if (projectedSize > 500) {
  print("‚ö†Ô∏è  WARNING: Add more shards within 6 months")
}
```

### 4. Read from Secondaries

**–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É —á—Ç–µ–Ω–∏—è** –Ω–∞ secondary –Ω–æ–¥—ã:

```javascript
// –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (Python/pymongo)
from pymongo import MongoClient, ReadPreference

client = MongoClient(
    'mongodb://mongos:27017/',
    readPreference=ReadPreference.SECONDARY_PREFERRED
)

# –ò–ª–∏
db = client.get_database('mobile_world', read_preference=ReadPreference.SECONDARY)
```

**–≠—Ñ—Ñ–µ–∫—Ç**: Primary —Ä–∞–∑–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–ª—è writes

### 5. Caching –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π

**Redis –¥–ª—è "–≥–æ—Ä—è—á–∏—Ö" –¥–∞–Ω–Ω—ã—Ö**:

```python
import redis

redis_client = redis.Redis(host='redis', port=6379)

def get_products_by_category(category):
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–µ—à
    cache_key = f"products:category:{category}"
    cached = redis_client.get(cache_key)
    
    if cached:
        return json.loads(cached)
    
    # –ï—Å–ª–∏ –Ω–µ—Ç –≤ –∫–µ—à–µ, –∑–∞–ø—Ä–æ—Å–∏—Ç—å MongoDB
    products = list(db.products.find({"category": category}))
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–µ—à (TTL 5 –º–∏–Ω—É—Ç)
    redis_client.setex(cache_key, 300, json.dumps(products))
    
    return products
```

**–≠—Ñ—Ñ–µ–∫—Ç**: 90% –∑–∞–ø—Ä–æ—Å–æ–≤ "electronics" –∏–¥—É—Ç –≤ Redis, –Ω–µ –≤ MongoDB

---

## –ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥ MongoDB

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

```javascript
// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞
db.products.getShardDistribution()

// 2. –°—Ç–∞—Ç—É—Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–∞
sh.getBalancerState()
sh.isBalancerRunning()

// 3. –°–ø–∏—Å–æ–∫ jumbo chunks
db.getSiblingDB("config").chunks.find({
  ns: "mobile_world.products",
  jumbo: true
}).count()

// 4. –ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
db.getSiblingDB("config").changelog.find({
  what: "moveChunk.from"
}).sort({ time: -1 }).limit(10)

// 5. –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–æ–≤
db.getSiblingDB("config").settings.findOne({ _id: "chunksize" })

// 6. –û–∫–Ω–æ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
db.getSiblingDB("config").settings.findOne({ _id: "balancer" })
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

```javascript
// 1. Split –±–æ–ª—å—à–æ–≥–æ —á–∞–Ω–∫–∞
sh.splitAt("mobile_world.products", {
  category: "electronics",
  product_id: "PROD-50000"
})

// 2. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —á–∞–Ω–∫
sh.moveChunk(
  "mobile_world.products",
  { category: "electronics", product_id: "PROD-50000" },
  "shard2"
)

// 3. –í–∫–ª—é—á–∏—Ç—å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫
sh.startBalancer()

// 4. –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞
db.getSiblingDB("config").settings.updateOne(
  { _id: "chunksize" },
  { $set: { value: 32 } },
  { upsert: true }
)

// 5. Refine shard key
db.adminCommand({
  refineCollectionShardKey: "mobile_world.products",
  key: { category: 1, product_id: 1, _id: 1 }
})

// 6. Zone sharding
sh.addShardTag("shard1", "hot")
sh.addTagRange(
  "mobile_world.products",
  { category: "electronics", product_id: MinKey },
  { category: "electronics", product_id: MaxKey },
  "hot"
)
```

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### MongoDB Atlas (Cloud)

**–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
- Performance Advisor
- Real-time metrics
- Auto-scaling
- Automatic balancing

### Self-hosted: Prometheus + Grafana

**1. MongoDB Exporter**:
```bash
# docker-compose.yml
mongodb_exporter:
  image: percona/mongodb_exporter:latest
  command:
    - '--mongodb.uri=mongodb://shard1-1:27018'
  ports:
    - '9216:9216'
```

**2. Prometheus config**:
```yaml
scrape_configs:
  - job_name: 'mongodb_shard1'
    static_configs:
      - targets: ['mongodb_exporter_shard1:9216']
        labels:
          shard: 'shard1'
```

**3. Grafana alerts**:
```yaml
alerts:
  - alert: HighCPUUsage
    expr: mongodb_sys_cpu_usage > 80
    for: 5m
    annotations:
      summary: "High CPU on {{ $labels.shard }}"
      
  - alert: ChunkImbalance
    expr: (max(mongodb_chunks_count) - min(mongodb_chunks_count)) / avg(mongodb_chunks_count) > 0.3
    for: 10m
    annotations:
      summary: "Chunk imbalance detected"
```

### Custom monitoring script

```javascript
// save_metrics.js

function saveMetrics() {
  const metrics = {
    timestamp: new Date(),
    shards: {}
  }
  
  // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ —à–∞—Ä–¥–∞
  const shards = sh.status(true).shards
  for (const shardName in shards) {
    const host = shards[shardName].host
    const conn = connect(host)
    const status = conn.serverStatus()
    
    metrics.shards[shardName] = {
      opcounters: status.opcounters,
      connections: status.connections.current,
      memory: status.mem.resident,
      queueDepth: status.globalLock.currentQueue.total
    }
  }
  
  // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤
  const chunksPerShard = {}
  db.getSiblingDB("config").chunks.aggregate([
    { $match: { ns: "mobile_world.products" } },
    { $group: { _id: "$shard", count: { $sum: 1 } } }
  ]).forEach(doc => {
    chunksPerShard[doc._id] = doc.count
  })
  
  metrics.chunk_distribution = chunksPerShard
  
  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  db.getSiblingDB("monitoring").metrics.insertOne(metrics)
}

// –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
while (true) {
  saveMetrics()
  sleep(5 * 60 * 1000)
}
```

---

## –ò—Ç–æ–≥–∏

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –ù–æ—Ä–º–∞ | –í–Ω–∏–º–∞–Ω–∏–µ | –ö—Ä–∏—Ç–∏—á–Ω–æ |
|---------|-------|----------|----------|
| **Ops/sec** | <5,000 | 5,000-10,000 | >10,000 |
| **CPU** | <60% | 60-80% | >80% |
| **Memory** | <70% | 70-85% | >85% |
| **Latency** | <50ms | 50-200ms | >200ms |
| **Queue depth** | <10 | 10-50 | >50 |
| **Chunk imbalance** | <10% | 10-30% | >30% |

### –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è

| –°—Ç—Ä–∞—Ç–µ–≥–∏—è | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –í—Ä–µ–º—è |
|-----------|-------------------|-----------|-------|
| **Split chunks** | –ë–æ–ª—å—à–∏–µ —á–∞–Ω–∫–∏ | –ù–∏–∑–∫–∞—è | –ú–∏–Ω—É—Ç—ã |
| **Move chunks** | –î–∏—Å–±–∞–ª–∞–Ω—Å —á–∞–Ω–∫–æ–≤ | –ù–∏–∑–∫–∞—è | –ß–∞—Å—ã |
| **Zone sharding** | –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ | –°—Ä–µ–¥–Ω—è—è | –ß–∞—Å—ã |
| **Refine shard key** | Jumbo chunks | –°—Ä–µ–¥–Ω—è—è | –ß–∞—Å—ã |
| **Re-shard** | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á | –í—ã—Å–æ–∫–∞—è | –î–Ω–∏ |

### –ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω—ã–µ –º–µ—Ä—ã

1. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —à–∞—Ä–¥-–∫–ª—é—á —Å –≤—ã—Å–æ–∫–æ–π –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é
2. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ 24/7
3. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã
4. ‚úÖ Capacity planning
5. ‚úÖ Read from secondaries
6. ‚úÖ Redis caching –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
7. ‚úÖ Zone sharding –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

- ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π balancer MongoDB
- ‚úÖ –û–∫–Ω–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ (–Ω–æ—á—å—é)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π split chunks
- ‚úÖ Custom —Å–∫—Ä–∏–ø—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus/Grafana

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- üìê [TASK7_SUMMARY.md](TASK7_SUMMARY.md) - –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–π
- üè† [README.md](../README.md) - –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
- ‚öôÔ∏è [TASK2_SUMMARY.md](TASK2_SUMMARY.md) - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è
- üîß [TASK2_SHARDING_SETUP.md](TASK2_SHARDING_SETUP.md) - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∞—Ä–¥–æ–≤

---

**‚úÖ –ó–∞–¥–∞–Ω–∏–µ 8 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!**

**–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è "–≥–æ—Ä—è—á–∏—Ö" —à–∞—Ä–¥–æ–≤ –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞ "–ú–æ–±–∏–ª—å–Ω—ã–π –º–∏—Ä".**

**üéâ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏!**

