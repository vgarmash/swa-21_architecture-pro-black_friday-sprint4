# –ó–∞–¥–∞–Ω–∏–µ 7: –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏–π –¥–ª—è —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è

> üìê –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å—Ö–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏–π –∏ –≤—ã–±–æ—Ä—É —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è  
> üè† [‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ README](../README.md)

---

## üìö –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏](#–æ–±–∑–æ—Ä-–ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π-–æ–±–ª–∞—Å—Ç–∏)
2. [–ö–æ–ª–ª–µ–∫—Ü–∏—è products](#–∫–æ–ª–ª–µ–∫—Ü–∏—è-products)
3. [–ö–æ–ª–ª–µ–∫—Ü–∏—è orders](#–∫–æ–ª–ª–µ–∫—Ü–∏—è-orders)
4. [–ö–æ–ª–ª–µ–∫—Ü–∏—è carts](#–∫–æ–ª–ª–µ–∫—Ü–∏—è-carts)
5. [–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞](#—Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è-—Ç–∞–±–ª–∏—Ü–∞)
6. [–ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥ MongoDB](#–ø—Ä–∏–º–µ—Ä—ã-–∫–æ–º–∞–Ω–¥-mongodb)
7. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)

---

## –û–±–∑–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏

### –ö–æ–Ω—Ç–µ–∫—Å—Ç

–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω "–ú–æ–±–∏–ª—å–Ω—ã–π –º–∏—Ä" –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—à–∏—Ä–∏–ª—Å—è:
- **–ë—ã–ª–æ**: —Ç–æ–ª—å–∫–æ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω–æ–≤
- **–°—Ç–∞–ª–æ**: —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞, –∞—É–¥–∏–æ, –±—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞, –∫–Ω–∏–≥–∏ –∏ –¥—Ä—É–≥–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–∏—Å—Ç–µ–º–µ

- **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: –†–æ—Å—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤, –∑–∞–∫–∞–∑–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ë—ã—Å—Ç—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤
- **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å**: –†–∞–±–æ—Ç–∞ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≥–µ–æ–∑–æ–Ω–∞—Ö (–ú–æ—Å–∫–≤–∞, –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥ –∏ –¥—Ä.)
- **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏**: –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —à–∞—Ä–¥–∞–º

### –¢—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏

1. **products** - –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏ –ø–æ –≥–µ–æ–∑–æ–Ω–∞–º
2. **orders** - –∑–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. **carts** - —Ç–µ–∫—É—â–∏–µ –∫–æ—Ä–∑–∏–Ω—ã (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏ –≥–æ—Å—Ç–µ–≤—ã–µ)

---

## –ö–æ–ª–ª–µ–∫—Ü–∏—è products

### –û–ø–∏—Å–∞–Ω–∏–µ

–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–∞—Ö –º–∞–≥–∞–∑–∏–Ω–∞ —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –≥–µ–æ–∑–æ–Ω–∞—Ö.

### –°—Ö–µ–º–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏

```javascript
{
  _id: ObjectId("..."),              // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–≤–∞—Ä–∞
  product_id: "PROD-12345",          // –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π ID
  name: "–°–º–∞—Ä—Ç—Ñ–æ–Ω X",                // –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
  category: "electronics",           // –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞
  price: 49999.00,                   // –¶–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö
  stock_by_geo: {                    // –û—Å—Ç–∞—Ç–∫–∏ –ø–æ –≥–µ–æ–∑–æ–Ω–∞–º
    "moscow": 100,
    "ekaterinburg": 50,
    "kaliningrad": 30,
    "novosibirsk": 75
  },
  attributes: {                      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã
    color: "black",
    size: "128GB",
    brand: "Samsung"
  },
  created_at: ISODate("2024-01-15T10:00:00Z"),
  updated_at: ISODate("2024-10-27T15:30:00Z")
}
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

| –û–ø–µ—Ä–∞—Ü–∏—è | –ß–∞—Å—Ç–æ—Ç–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|---------|----------|
| **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤** | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | –ü—Ä–∏ –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–µ: `$inc: { "stock_by_geo.moscow": -1 }` |
| **–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º** | –í—ã—Å–æ–∫–∞—è | –ö–∞—Ç–∞–ª–æ–≥: `{ category: "electronics" }` |
| **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ü–µ–Ω–µ** | –°—Ä–µ–¥–Ω—è—è | `{ price: { $gte: 10000, $lte: 50000 } }` |
| **–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞** | –í—ã—Å–æ–∫–∞—è | –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–∞: `{ product_id: "PROD-12345" }` |

### –ê–Ω–∞–ª–∏–∑ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è —à–∞—Ä–¥-–∫–ª—é—á–∞

#### –í–∞—Ä–∏–∞–Ω—Ç 1: `{ category: 1, product_id: 1 }` ‚≠ê **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è**

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º**: –í—Å–µ —Ç–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ –æ–¥–Ω–æ–º —à–∞—Ä–¥–µ
- ‚úÖ **–•–æ—Ä–æ—à–∞—è –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å**: category (~10-50 –∑–Ω–∞—á–µ–Ω–∏–π) + product_id (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
- ‚úÖ **–õ–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**: –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã —Ä—è–¥–æ–º
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ range-–∑–∞–ø—Ä–æ—Å—ã** –ø–æ —Ü–µ–Ω–µ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–æ–≤–∞—Ä–æ–≤ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞—Ç—å "–≥–æ—Ä—è—á–∏–µ" —à–∞—Ä–¥—ã
- ‚ö†Ô∏è –ù—É–∂–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–∞ —á–∞–Ω–∫–æ–≤ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:**
```
Shard 1: electronics (5000 —Ç–æ–≤–∞—Ä–æ–≤)
Shard 2: books (3000 —Ç–æ–≤–∞—Ä–æ–≤), audio (2000 —Ç–æ–≤–∞—Ä–æ–≤)
Shard 3: appliances (4000 —Ç–æ–≤–∞—Ä–æ–≤)
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2: `{ product_id: "hashed" }`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –•–µ—à –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
- ‚úÖ **–ù–µ—Ç "–≥–æ—Ä—è—á–∏—Ö" —à–∞—Ä–¥–æ–≤**: –í—Å–µ —à–∞—Ä–¥—ã –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Ä–∞–≤–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå **–ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º**: –ù—É–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫–æ –≤—Å–µ–º —à–∞—Ä–¥–∞–º
- ‚ùå **Scatter-gather –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞**: –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–¥–µ—Ç –Ω–∞ –≤—Å–µ —à–∞—Ä–¥—ã
- ‚ùå **–ù–µ–≤–æ–∑–º–æ–∂–Ω—ã range-–∑–∞–ø—Ä–æ—Å—ã**: –•–µ—à –ª–æ–º–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫

#### –í–∞—Ä–∏–∞–Ω—Ç 3: `{ _id: 1 }`

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå **Monotonic key**: ObjectId —Ä–∞—Å—Ç—ë—Ç –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ ‚Üí –≤—Å–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞—Ä–¥
- ‚ùå **–ù–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å**: –û–¥–∏–Ω —à–∞—Ä–¥ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω

### –í—ã–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: **Range Sharding –ø–æ `{ category: 1, product_id: 1 }`**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
1. **–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º** - –æ—Å–Ω–æ–≤–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
   - `db.products.find({ category: "electronics" })` ‚Üí –æ–¥–∏–Ω —à–∞—Ä–¥
   
2. **–•–æ—Ä–æ—à–∞—è –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å**: –°–æ—Å—Ç–∞–≤–Ω–æ–π –∫–ª—é—á –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
   
3. **–õ–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**: –¢–æ–≤–∞—Ä—ã –æ–¥–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ –æ–¥–Ω–æ–º —à–∞—Ä–¥–µ
   - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: `{ category: "electronics", price: { $gte: 10000 } }`
   
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ú–æ–∂–Ω–æ split/move —á–∞–Ω–∫–∏ –ø—Ä–∏ —Ä–æ—Å—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π

**–ö–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–Ω–∏—è —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏:**
```javascript
// –í–∫–ª—é—á–∏—Ç—å —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ë–î
sh.enableSharding("mobile_world")

// –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –¥–ª—è —à–∞—Ä–¥-–∫–ª—é—á–∞
db.products.createIndex({ category: 1, product_id: 1 })

// –®–∞—Ä–¥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é
sh.shardCollection("mobile_world.products", { category: 1, product_id: 1 })
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã

```javascript
// –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ü–µ–Ω–µ
db.products.createIndex({ category: 1, price: 1 })

// –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
db.products.createIndex({ name: "text", "attributes.brand": "text" })

// –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ product_id (—É–∂–µ –µ—Å—Ç—å –≤ —Å–æ—Å—Ç–∞–≤–µ —à–∞—Ä–¥-–∫–ª—é—á–∞)
// db.products.createIndex({ product_id: 1 }) // –Ω–µ –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω–æ
```

---

## –ö–æ–ª–ª–µ–∫—Ü–∏—è orders

### –û–ø–∏—Å–∞–Ω–∏–µ

–•—Ä–∞–Ω–∏—Ç –∑–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –ø–æ–∫—É–ø–æ–∫.

### –°—Ö–µ–º–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏

```javascript
{
  _id: ObjectId("..."),              // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–∞
  order_id: "ORD-2024-10-001234",    // –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π ID
  user_id: "USER-67890",             // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞
  created_at: ISODate("2024-10-27T14:30:00Z"),  // –î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞
  items: [                           // –¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ
    {
      product_id: "PROD-12345",
      name: "–°–º–∞—Ä—Ç—Ñ–æ–Ω X",
      quantity: 1,
      price: 49999.00
    },
    {
      product_id: "PROD-67890",
      name: "–ö–Ω–∏–≥–∞ 'MongoDB in Action'",
      quantity: 2,
      price: 1500.00
    }
  ],
  status: "processing",              // pending | processing | shipped | delivered | cancelled
  total_amount: 52999.00,            // –û–±—â–∞—è —Å—É–º–º–∞
  geo_zone: "moscow",                // –ì–µ–æ–∑–æ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
  shipping_address: {
    city: "–ú–æ—Å–∫–≤–∞",
    street: "–õ–µ–Ω–∏–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç, 15",
    zip: "119991"
  },
  updated_at: ISODate("2024-10-27T15:00:00Z")
}
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

| –û–ø–µ—Ä–∞—Ü–∏—è | –ß–∞—Å—Ç–æ—Ç–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|---------|----------|
| **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞** | –í—ã—Å–æ–∫–∞—è | INSERT —Å `user_id`, `geo_zone`, —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π |
| **–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** | –í—ã—Å–æ–∫–∞—è | `{ user_id: "USER-67890" }` |
| **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞** | –°—Ä–µ–¥–Ω—è—è | `{ order_id: "..." }`, UPDATE status |
| **–ü–æ–∏—Å–∫ –ø–æ –≥–µ–æ–∑–æ–Ω–µ** | –°—Ä–µ–¥–Ω—è—è | –û—Ç—á–µ—Ç—ã: `{ geo_zone: "moscow", created_at: { $gte: ... } }` |
| **–û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞** | –ù–∏–∑–∫–∞—è | `{ order_id: "..." }`, UPDATE status="cancelled" |

### –ê–Ω–∞–ª–∏–∑ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è —à–∞—Ä–¥-–∫–ª—é—á–∞

#### –í–∞—Ä–∏–∞–Ω—Ç 1: `{ user_id: 1, created_at: 1 }` ‚≠ê **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è**

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: `{ user_id: "..." }` ‚Üí –æ–¥–∏–Ω —à–∞—Ä–¥
- ‚úÖ **–•—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫**: created_at –ø–æ–∑–≤–æ–ª—è–µ—Ç range-–∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ **–õ–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: –í—Å–µ –∑–∞–∫–∞–∑—ã —é–∑–µ—Ä–∞ —Ä—è–¥–æ–º
- ‚úÖ **–•–æ—Ä–æ—à–∞—è –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å**: user_id —É–Ω–∏–∫–∞–ª—å–Ω—ã–π + timestamp

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è "–•–æ–ª–æ–¥–Ω—ã–µ" –∏ "–≥–æ—Ä—è—á–∏–µ" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (VIP —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –∑–∞–∫–∞–∑–æ–≤)
- ‚ö†Ô∏è –ù—É–∂–Ω–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:**
```
Shard 1: USER-00001...USER-10000 (10,000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
Shard 2: USER-10001...USER-20000 (10,000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2: `{ geo_zone: 1, user_id: 1 }`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å**: –ó–∞–∫–∞–∑—ã –æ–¥–Ω–æ–π –≥–µ–æ–∑–æ–Ω—ã –Ω–∞ –æ–¥–Ω–æ–º —à–∞—Ä–¥–µ
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º**: `{ geo_zone: "moscow" }` ‚Üí –æ–¥–∏–Ω —à–∞—Ä–¥
- ‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º**: –ú–æ—Å–∫–≤–∞ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå **–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: –ù—É–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —à–∞—Ä–¥–∞–º, –µ—Å–ª–∏ —é–∑–µ—Ä –∑–∞–∫–∞–∑—ã–≤–∞–ª –≤ —Ä–∞–∑–Ω—ã—Ö –≥–µ–æ–∑–æ–Ω–∞—Ö
- ‚ö†Ô∏è –ù–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞: –ú–æ—Å–∫–≤–∞ >> –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥

#### –í–∞—Ä–∏–∞–Ω—Ç 3: `{ user_id: "hashed" }`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –•–µ—à –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå **–ù–µ—Ç range-–∑–∞–ø—Ä–æ—Å–æ–≤**: –ù–µ–ª—å–∑—è –ø–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑—ã –∑–∞ –ø–µ—Ä–∏–æ–¥
- ‚ùå **–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: –í—Å–µ —Ä–∞–≤–Ω–æ –Ω–∞ –æ–¥–Ω–æ–º —à–∞—Ä–¥–µ (–ø–æ —Ö–µ—à—É user_id)

### –í—ã–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: **Range Sharding –ø–æ `{ user_id: 1, created_at: 1 }`**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
1. **–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** - –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å
   - `db.orders.find({ user_id: "USER-67890" }).sort({ created_at: -1 })` ‚Üí –æ–¥–∏–Ω —à–∞—Ä–¥
   
2. **–•—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫**: Range-–∑–∞–ø—Ä–æ—Å—ã –∑–∞ –ø–µ—Ä–∏–æ–¥
   - `{ user_id: "...", created_at: { $gte: startDate } }`
   
3. **–õ–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å**: –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ–¥–Ω–æ–º —à–∞—Ä–¥–µ
   - –ë—ã—Å—Ç—Ä—ã–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ —é–∑–µ—Ä—É
   
4. **–ò–∑–±–µ–≥–∞–µ–º scatter-gather**: –ù–µ –Ω—É–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫–æ –≤—Å–µ–º —à–∞—Ä–¥–∞–º

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –≥–µ–æ–∑–æ–Ω–∞–º:**
–°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é `orders_by_geo` —Å —à–∞—Ä–¥-–∫–ª—é—á–æ–º `{ geo_zone: 1, created_at: 1 }` –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤.

**–ö–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–Ω–∏—è:**
```javascript
sh.enableSharding("mobile_world")

db.orders.createIndex({ user_id: 1, created_at: 1 })

sh.shardCollection("mobile_world.orders", { user_id: 1, created_at: 1 })
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã

```javascript
// –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ order_id
db.orders.createIndex({ order_id: 1 })

// –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É (–¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏)
db.orders.createIndex({ status: 1, created_at: 1 })

// –ò–Ω–¥–µ–∫—Å –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –≥–µ–æ–∑–æ–Ω–µ
db.orders.createIndex({ geo_zone: 1, created_at: 1 })
```

---

## –ö–æ–ª–ª–µ–∫—Ü–∏—è carts

### –û–ø–∏—Å–∞–Ω–∏–µ

–•—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≥–æ—Å—Ç–µ–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–æ–π —Å—Ç–∞—Ä—ã—Ö.

### –°—Ö–µ–º–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏

```javascript
{
  _id: ObjectId("..."),              // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ—Ä–∑–∏–Ω—ã
  user_id: "USER-67890",             // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (null –¥–ª—è –≥–æ—Å—Ç–µ–π)
  session_id: "sess_abc123xyz",     // ID —Å–µ—Å—Å–∏–∏ (–¥–ª—è –≥–æ—Å—Ç–µ–π)
  items: [                           // –¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ
    {
      product_id: "PROD-12345",
      quantity: 1,
      added_at: ISODate("2024-10-27T14:00:00Z")
    },
    {
      product_id: "PROD-67890",
      quantity: 2,
      added_at: ISODate("2024-10-27T14:15:00Z")
    }
  ],
  status: "active",                  // active | ordered | abandoned
  created_at: ISODate("2024-10-27T14:00:00Z"),
  updated_at: ISODate("2024-10-27T14:30:00Z"),
  expires_at: ISODate("2024-11-03T14:00:00Z")  // TTL: 7 –¥–Ω–µ–π
}
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

| –û–ø–µ—Ä–∞—Ü–∏—è | –ß–∞—Å—Ç–æ—Ç–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|---------|----------|
| **–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã** | –í—ã—Å–æ–∫–∞—è | INSERT –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ |
| **–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã** | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | `{ user_id: "...", status: "active" }` –∏–ª–∏ `{ session_id: "...", status: "active" }` |
| **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞** | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | `$push` –∏–ª–∏ `$set` –≤ items |
| **–£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞** | –í—ã—Å–æ–∫–∞—è | `$pull` –∏–∑ items |
| **–°–ª–∏—è–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω** | –°—Ä–µ–¥–Ω—è—è | –ü—Ä–∏ –ª–æ–≥–∏–Ω–µ: –≥–æ—Å—Ç–µ–≤–∞—è ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è |
| **–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞** | –í—ã—Å–æ–∫–∞—è | UPDATE status="ordered" |
| **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞** | –§–æ–Ω–æ–≤–∞—è | TTL index –Ω–∞ expires_at |

### –ê–Ω–∞–ª–∏–∑ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è —à–∞—Ä–¥-–∫–ª—é—á–∞

#### –í–∞—Ä–∏–∞–Ω—Ç 1: `{ user_id: "hashed" }` ‚≠ê **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è**

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –•–µ—à –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –Ω–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: –ö–∞–∂–¥—ã–π —é–∑–µ—Ä –Ω–∞ "—Å–≤–æ–µ–º" —à–∞—Ä–¥–µ (–ø–æ —Ö–µ—à—É)
- ‚úÖ **–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫**: `{ user_id: "...", status: "active" }` ‚Üí –æ–¥–∏–Ω —à–∞—Ä–¥ –ø–æ —Ö–µ—à—É

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è **–ì–æ—Å—Ç–µ–≤—ã–µ –∫–æ—Ä–∑–∏–Ω—ã**: user_id = null ‚Üí –≤—Å–µ –Ω–∞ –æ–¥–Ω–æ–º —à–∞—Ä–¥–µ
  - **–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∫–ª—é—á —Å session_id

**–ö–æ–º–∞–Ω–¥–∞:**
```javascript
sh.shardCollection("mobile_world.carts", { user_id: "hashed" })
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2: `{ session_id: "hashed" }` (–¥–ª—è –≥–æ—Å—Ç–µ–π)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- ‚ùå –ì–æ—Å—Ç–µ–≤—ã–µ –∫–æ—Ä–∑–∏–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç session_id
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç user_id
- ‚ùå –ù—É–∂–Ω—ã –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö –∫–ª—é—á–∞ ‚Üí –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤ –æ–¥–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ - —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∫–ª—é—á:**

#### –í–∞—Ä–∏–∞–Ω—Ç 3: `{ user_session_key: "hashed" }` ‚≠ê **–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ**

**–ü–æ–¥—Ö–æ–¥**: –°–æ–∑–¥–∞—Ç—å –≤—ã—á–∏—Å–ª—è–µ–º–æ–µ –ø–æ–ª–µ `user_session_key`:
```javascript
user_session_key = user_id || session_id  // user_id –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ session_id
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **–ï–¥–∏–Ω—ã–π –∫–ª—é—á** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≥–æ—Å—Ç–µ–π
- ‚úÖ **–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** —á–µ—Ä–µ–∑ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ **–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫**: –û–¥–∏–Ω —à–∞—Ä–¥ –ø–æ —Ö–µ—à—É

**–°—Ö–µ–º–∞ —Å user_session_key:**
```javascript
{
  _id: ObjectId("..."),
  user_id: "USER-67890",             // –∏–ª–∏ null
  session_id: "sess_abc123xyz",      // –∏–ª–∏ null
  user_session_key: "USER-67890",    // user_id || session_id ‚≠ê
  items: [...],
  status: "active",
  ...
}
```

### –í—ã–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: **Hashed Sharding –ø–æ `{ user_session_key: "hashed" }`**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
1. **–í—ã—Å–æ–∫–∞—è —á–∞—Å—Ç–æ—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π**: –ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–æ—Ä–∑–∏–Ω–æ–π ‚Üí –∑–∞–ø—Ä–æ—Å –∫ –ë–î
   - –ù—É–∂–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞
   
2. **–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏**: –•–µ—à –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å
   - –ù–µ—Ç "–≥–æ—Ä—è—á–∏—Ö" —à–∞—Ä–¥–æ–≤
   
3. **–ï–¥–∏–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≥–æ—Å—Ç–µ–π**: user_session_key
   - –£–ø—Ä–æ—â–∞–µ—Ç –ª–æ–≥–∏–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   
4. **–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –ö–∞–∂–¥–∞—è –∫–æ—Ä–∑–∏–Ω–∞ –Ω–∞ "—Å–≤–æ–µ–º" —à–∞—Ä–¥–µ
   - –ú–∏–Ω–∏–º—É–º –∫–æ–ª–ª–∏–∑–∏–π

**–ö–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–Ω–∏—è:**
```javascript
sh.enableSharding("mobile_world")

// –°–æ–∑–¥–∞—Ç—å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å
db.carts.createIndex({ user_session_key: "hashed" })

// –®–∞—Ä–¥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é
sh.shardCollection("mobile_world.carts", { user_session_key: "hashed" })

// TTL –∏–Ω–¥–µ–∫—Å –¥–ª—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏
db.carts.createIndex({ expires_at: 1 }, { expireAfterSeconds: 0 })
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã

```javascript
// –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
db.carts.createIndex({ user_id: 1, status: 1 })

// –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã –≥–æ—Å—Ç—è
db.carts.createIndex({ session_id: 1, status: 1 })

// TTL –∏–Ω–¥–µ–∫—Å (—É–∂–µ —Å–æ–∑–¥–∞–Ω –≤—ã—à–µ)
// db.carts.createIndex({ expires_at: 1 }, { expireAfterSeconds: 0 })
```

### –õ–æ–≥–∏–∫–∞ —Å–ª–∏—è–Ω–∏—è –∫–æ—Ä–∑–∏–Ω

```javascript
// 1. –ù–∞–π—Ç–∏ –≥–æ—Å—Ç–µ–≤—É—é –∫–æ—Ä–∑–∏–Ω—É
const guestCart = await db.carts.findOne({
  session_id: "sess_abc123xyz",
  status: "active"
})

// 2. –ù–∞–π—Ç–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –∫–æ—Ä–∑–∏–Ω—É
let userCart = await db.carts.findOne({
  user_id: "USER-67890",
  status: "active"
})

if (!userCart) {
  userCart = {
    user_id: "USER-67890",
    user_session_key: "USER-67890",
    items: [],
    status: "active",
    created_at: new Date(),
    updated_at: new Date(),
    expires_at: new Date(Date.now() + 7*24*60*60*1000)
  }
  await db.carts.insertOne(userCart)
}

// 3. –°–ª–∏—Ç—å items
for (const item of guestCart.items) {
  const existingItem = userCart.items.find(i => i.product_id === item.product_id)
  if (existingItem) {
    existingItem.quantity += item.quantity  // –°—É–º–º–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
  } else {
    userCart.items.push(item)
  }
}

// 4. –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –∫–æ—Ä–∑–∏–Ω—É
await db.carts.updateOne(
  { _id: userCart._id },
  { 
    $set: { 
      items: userCart.items,
      updated_at: new Date()
    }
  }
)

// 5. –ü–æ–º–µ—Ç–∏—Ç—å –≥–æ—Å—Ç–µ–≤—É—é –∫–∞–∫ abandoned
await db.carts.updateOne(
  { _id: guestCart._id },
  { $set: { status: "abandoned", updated_at: new Date() } }
)
```

---

## –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –ö–æ–ª–ª–µ–∫—Ü–∏—è | –°—Ç—Ä–∞—Ç–µ–≥–∏—è | –®–∞—Ä–¥-–∫–ª—é—á | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|-----------|-----------|-----------|-------------|
| **products** | **Range Sharding** | `{ category: 1, product_id: 1 }` | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤ –æ–¥–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ |
| **orders** | **Range Sharding** | `{ user_id: 1, created_at: 1 }` | –ë—ã—Å—Ç—Ä–∞—è –∏—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ |
| **carts** | **Hashed Sharding** | `{ user_session_key: "hashed" }` | –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –≤—ã—Å–æ–∫–∞—è —á–∞—Å—Ç–æ—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π, –µ–¥–∏–Ω—ã–π –∫–ª—é—á –¥–ª—è —é–∑–µ—Ä–æ–≤ –∏ –≥–æ—Å—Ç–µ–π |

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

| –ö—Ä–∏—Ç–µ—Ä–∏–π | Range Sharding | Hashed Sharding |
|----------|----------------|-----------------|
| **–ö–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å** | –ù—É–∂–Ω–∞ –≤—ã—Å–æ–∫–∞—è | –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ |
| **Range-–∑–∞–ø—Ä–æ—Å—ã** | ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã | ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω—ã |
| **–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—å** | ‚ö†Ô∏è –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–∞–Ω–Ω—ã—Ö | ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ |
| **Scatter-gather** | –ú–æ–∂–Ω–æ –∏–∑–±–µ–∂–∞—Ç—å | –ß–∞—Å—Ç—ã–π |
| **–õ–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö** | ‚úÖ –î–∞ | ‚ùå –ù–µ—Ç |

---

## –ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥ MongoDB

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞

```javascript
// 1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ mongos
mongosh --host mongos --port 27017

// 2. –í–∫–ª—é—á–∏—Ç—å —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ë–î
sh.enableSharding("mobile_world")

// 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sh.status()
```

### –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ products

```javascript
// –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –¥–ª—è —à–∞—Ä–¥-–∫–ª—é—á–∞
db.products.createIndex({ category: 1, product_id: 1 })

// –®–∞—Ä–¥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é
sh.shardCollection("mobile_world.products", { category: 1, product_id: 1 })

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
db.products.getShardDistribution()

// –ü—Ä–∏–º–µ—Ä –≤—Å—Ç–∞–≤–∫–∏ —Ç–æ–≤–∞—Ä–∞
db.products.insertOne({
  product_id: "PROD-12345",
  name: "–°–º–∞—Ä—Ç—Ñ–æ–Ω X",
  category: "electronics",
  price: 49999.00,
  stock_by_geo: {
    "moscow": 100,
    "ekaterinburg": 50
  },
  attributes: {
    color: "black",
    size: "128GB"
  },
  created_at: new Date(),
  updated_at: new Date()
})

// –ó–∞–ø—Ä–æ—Å —Ç–æ–≤–∞—Ä–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (targeted query - –æ–¥–∏–Ω —à–∞—Ä–¥)
db.products.find({ 
  category: "electronics",
  price: { $gte: 10000, $lte: 50000 }
}).sort({ price: 1 })

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞ (–±—É–¥–µ—Ç –Ω–∞ –æ–¥–Ω–æ–º —à–∞—Ä–¥–µ)
db.products.updateOne(
  { category: "electronics", product_id: "PROD-12345" },
  { $inc: { "stock_by_geo.moscow": -1 }, $set: { updated_at: new Date() } }
)
```

### –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ orders

```javascript
// –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å
db.orders.createIndex({ user_id: 1, created_at: 1 })

// –®–∞—Ä–¥–∏—Ä–æ–≤–∞—Ç—å
sh.shardCollection("mobile_world.orders", { user_id: 1, created_at: 1 })

// –°–æ–∑–¥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
db.orders.createIndex({ order_id: 1 })
db.orders.createIndex({ status: 1, created_at: 1 })
db.orders.createIndex({ geo_zone: 1, created_at: 1 })

// –ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
db.orders.insertOne({
  order_id: "ORD-2024-10-001234",
  user_id: "USER-67890",
  created_at: new Date(),
  items: [
    {
      product_id: "PROD-12345",
      name: "–°–º–∞—Ä—Ç—Ñ–æ–Ω X",
      quantity: 1,
      price: 49999.00
    }
  ],
  status: "pending",
  total_amount: 49999.00,
  geo_zone: "moscow",
  shipping_address: {
    city: "–ú–æ—Å–∫–≤–∞",
    street: "–õ–µ–Ω–∏–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç, 15",
    zip: "119991"
  },
  updated_at: new Date()
})

// –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (targeted query - –æ–¥–∏–Ω —à–∞—Ä–¥)
db.orders.find({ 
  user_id: "USER-67890" 
}).sort({ created_at: -1 }).limit(10)

// –ó–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ –ø–µ—Ä–∏–æ–¥ (targeted query - –æ–¥–∏–Ω —à–∞—Ä–¥)
db.orders.find({
  user_id: "USER-67890",
  created_at: { 
    $gte: ISODate("2024-10-01T00:00:00Z"),
    $lte: ISODate("2024-10-31T23:59:59Z")
  }
})

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
db.orders.updateOne(
  { order_id: "ORD-2024-10-001234" },
  { $set: { status: "processing", updated_at: new Date() } }
)
```

### –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ carts

```javascript
// –°–æ–∑–¥–∞—Ç—å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å
db.carts.createIndex({ user_session_key: "hashed" })

// –®–∞—Ä–¥–∏—Ä–æ–≤–∞—Ç—å
sh.shardCollection("mobile_world.carts", { user_session_key: "hashed" })

// TTL –∏–Ω–¥–µ–∫—Å –¥–ª—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏
db.carts.createIndex({ expires_at: 1 }, { expireAfterSeconds: 0 })

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
db.carts.createIndex({ user_id: 1, status: 1 })
db.carts.createIndex({ session_id: 1, status: 1 })

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
db.carts.insertOne({
  user_id: "USER-67890",
  session_id: null,
  user_session_key: "USER-67890",  // user_id || session_id
  items: [
    {
      product_id: "PROD-12345",
      quantity: 1,
      added_at: new Date()
    }
  ],
  status: "active",
  created_at: new Date(),
  updated_at: new Date(),
  expires_at: new Date(Date.now() + 7*24*60*60*1000)  // 7 –¥–Ω–µ–π
})

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è –≥–æ—Å—Ç—è
db.carts.insertOne({
  user_id: null,
  session_id: "sess_abc123xyz",
  user_session_key: "sess_abc123xyz",
  items: [],
  status: "active",
  created_at: new Date(),
  updated_at: new Date(),
  expires_at: new Date(Date.now() + 7*24*60*60*1000)
})

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (hashed query - –æ–¥–∏–Ω —à–∞—Ä–¥)
db.carts.findOne({ 
  user_session_key: "USER-67890",  // –±—É–¥–µ—Ç —Ö–µ—à–∏—Ä–æ–≤–∞–Ω
  status: "active" 
})

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
db.carts.updateOne(
  { user_session_key: "USER-67890", status: "active" },
  { 
    $push: { 
      items: {
        product_id: "PROD-67890",
        quantity: 2,
        added_at: new Date()
      }
    },
    $set: { updated_at: new Date() }
  }
)

// –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
db.carts.updateOne(
  { user_session_key: "USER-67890", status: "active" },
  { 
    $pull: { items: { product_id: "PROD-12345" } },
    $set: { updated_at: new Date() }
  }
)

// –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–∫–æ—Ä–∑–∏–Ω–∞ ‚Üí –∑–∞–∫–∞–∑)
db.carts.updateOne(
  { user_session_key: "USER-67890", status: "active" },
  { $set: { status: "ordered", updated_at: new Date() } }
)
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è

```javascript
// –°—Ç–∞—Ç—É—Å —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞
sh.status()

// –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —à–∞—Ä–¥–∞–º
db.products.getShardDistribution()
db.orders.getShardDistribution()
db.carts.getShardDistribution()

// –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞—Ä–¥–µ
db.printShardingStatus()

// –ü—Ä–æ—Å–º–æ—Ç—Ä —á–∞–Ω–∫–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
db.getSiblingDB("config").chunks.find({ ns: "mobile_world.products" }).count()

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
db.products.stats()
db.orders.stats()
db.carts.stats()

// Explain –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ targeted vs scatter-gather
db.products.find({ category: "electronics" }).explain("executionStats")
```

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ —á–∞–Ω–∫–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞—Ç—å –±–æ–ª—å—à–∏–µ —á–∞–Ω–∫–∏.

**–†–µ—à–µ–Ω–∏–µ**:
```javascript
// –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É
sh.setBalancerState(true)

// –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 64MB)
use config
db.settings.updateOne(
  { _id: "chunksize" },
  { $set: { value: 32 } },  // 32MB chunks
  { upsert: true }
)

// –†—É—á–Ω–æ–π split —á–∞–Ω–∫–∞
sh.splitFind("mobile_world.products", { category: "electronics", product_id: "PROD-50000" })

// –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —á–∞–Ω–∫ –Ω–∞ –¥—Ä—É–≥–æ–π —à–∞—Ä–¥
sh.moveChunk("mobile_world.products", 
  { category: "electronics", product_id: "PROD-50000" }, 
  "shard2"
)
```

### 2. –ó–æ–Ω—ã —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è (Zone Sharding)

**–°—Ü–µ–Ω–∞—Ä–∏–π**: –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.

```javascript
// –°–æ–∑–¥–∞—Ç—å –∑–æ–Ω—ã
sh.addShardTag("shard1", "moscow")
sh.addShardTag("shard2", "regions")

// –ù–∞–∑–Ω–∞—á–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–∞ –∑–æ–Ω—ã
sh.addTagRange(
  "mobile_world.products",
  { category: "electronics", product_id: MinKey },
  { category: "electronics", product_id: MaxKey },
  "moscow"  // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –ú–æ—Å–∫–≤–µ
)

sh.addTagRange(
  "mobile_world.products",
  { category: "books", product_id: MinKey },
  { category: "books", product_id: MaxKey },
  "regions"  // –ú–µ–Ω–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤ —Ä–µ–≥–∏–æ–Ω–∞—Ö
)
```

### 3. –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø–æ–∫—Ä—ã—Ç–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

```javascript
// –ü–æ–∫—Ä—ã–≤–∞—é—â–∏–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞
db.products.createIndex({ 
  category: 1, 
  price: 1, 
  product_id: 1,
  name: 1  // –í–∫–ª—é—á–∏—Ç—å –≤ –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∫—Ä—ã—Ç–∏—è
})

// –ó–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å (covered query)
db.products.find(
  { category: "electronics", price: { $lte: 50000 } },
  { _id: 0, product_id: 1, name: 1, price: 1 }  // –ü—Ä–æ–µ–∫—Ü–∏—è —Ç–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
)
```

### 4. –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Å $merge –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

```javascript
// –°–æ–∑–¥–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –≥–µ–æ–∑–æ–Ω–∞–º
db.orders.aggregate([
  {
    $match: {
      created_at: { $gte: ISODate("2024-10-01") }
    }
  },
  {
    $group: {
      _id: { geo_zone: "$geo_zone", date: { $dateToString: { format: "%Y-%m-%d", date: "$created_at" } } },
      total_orders: { $sum: 1 },
      total_revenue: { $sum: "$total_amount" }
    }
  },
  {
    $merge: {
      into: "orders_analytics",
      on: "_id",
      whenMatched: "replace",
      whenNotMatched: "insert"
    }
  }
])

// –®–∞—Ä–¥–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
sh.shardCollection("mobile_world.orders_analytics", { "_id.geo_zone": 1, "_id.date": 1 })
```

### 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```javascript
// –í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (—É—Ä–æ–≤–µ–Ω—å 1 - –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã >100–º—Å)
db.setProfilingLevel(1, { slowms: 100 })

// –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
db.system.profile.find({ millis: { $gt: 100 } }).sort({ ts: -1 }).limit(10)

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
db.serverStatus().opcounters
db.serverStatus().connections

// –†–∞–∑–º–µ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–π
db.stats()
```

### 6. Backup —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

```javascript
// –î–ª—è —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
// - mongodump —Å —Ñ–ª–∞–≥–æ–º --oplog –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
// - MongoDB Atlas Backup (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π)
// - Percona Backup for MongoDB (–æ–ø–µ–Ω—Å–æ—Ä—Å)

mongodump --host mongos:27017 --db mobile_world --oplog --out /backup/
```

---

## –ò—Ç–æ–≥–∏

### –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

| –ö–æ–ª–ª–µ–∫—Ü–∏—è | –®–∞—Ä–¥-–∫–ª—é—á | –°—Ç—Ä–∞—Ç–µ–≥–∏—è | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|-----------|-----------|-----------|-------------|
| **products** | `{ category: 1, product_id: 1 }` | Range | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥, –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ |
| **orders** | `{ user_id: 1, created_at: 1 }` | Range | –ë—ã—Å—Ç—Ä–∞—è –∏—Å—Ç–æ—Ä–∏—è, —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è, –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö —é–∑–µ—Ä–∞ |
| **carts** | `{ user_session_key: "hashed" }` | Hashed | –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—å, –≤—ã—Å–æ–∫–∞—è —á–∞—Å—Ç–æ—Ç–∞, –µ–¥–∏–Ω—ã–π –∫–ª—é—á |

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. ‚úÖ **–ö–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å**: –®–∞—Ä–¥-–∫–ª—é—á –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –≤—ã—Å–æ–∫—É—é –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å
2. ‚úÖ **–ß–∞—Å—Ç–æ—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤**: –£—á–∏—Ç—ã–≤–∞–µ–º —Å–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
3. ‚úÖ **–õ–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**: –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ–¥–Ω–æ–º —à–∞—Ä–¥–µ
4. ‚úÖ **–ò–∑–±–µ–≥–∞–µ–º scatter-gather**: Targeted queries –Ω–∞ –æ–¥–∏–Ω —à–∞—Ä–¥
5. ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —á–∞–Ω–∫–æ–≤
6. ‚úÖ **–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–ª–∏ —Ä—É—á–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —á–∞–Ω–∫–æ–≤

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- **products**: –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Üí 1 —à–∞—Ä–¥ (–±—ã—Å—Ç—Ä–æ)
- **orders**: –ò—Å—Ç–æ—Ä–∏—è —é–∑–µ—Ä–∞ ‚Üí 1 —à–∞—Ä–¥ (–±—ã—Å—Ç—Ä–æ)
- **carts**: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã ‚Üí 1 —à–∞—Ä–¥ –ø–æ —Ö–µ—à—É (–±—ã—Å—Ç—Ä–æ)

**–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —à–∞—Ä–¥—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- üè† [README.md](../README.md) - –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–µ–∫—Ç–∞
- üìñ [TASK1_PLANNING.md](TASK1_PLANNING.md) - –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- ‚öôÔ∏è [TASK2_SUMMARY.md](TASK2_SUMMARY.md) - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è
- üîß [TASK2_SHARDING_SETUP.md](TASK2_SHARDING_SETUP.md) - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∞—Ä–¥–æ–≤

---

**‚úÖ –ó–∞–¥–∞–Ω–∏–µ 7 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!**

**–°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã —Å—Ö–µ–º—ã –∫–æ–ª–ª–µ–∫—Ü–∏–π —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞ "–ú–æ–±–∏–ª—å–Ω—ã–π –º–∏—Ä".**

**üéâ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ!**

