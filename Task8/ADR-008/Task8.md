### <a name="_b7urdng99y53"></a>**Название задачи:**
ADR-008: Стратегия мониторинга и балансировки нагрузки для устранения «горячих» шардов в кластере MongoDB
### <a name="_hjk0fkfyohdk"></a>**Автор:**
Архитектурная команда "Мобильный мир"
### <a name="_uanumrh8zrui"></a>**Дата:**
25.09.2025
### <a name="_3bfxc9a45514"></a>**Функциональные требования**
Здесь описаны верхнеуровневые Use Cases. Они оформлены в виде таблицы с пошаговым описанием:

| **№** | **Действующие лица или системы**             | **Use Case**                            | **Описание**                                                                                                                                  |
|:-----:|:---------------------------------------------|:----------------------------------------|:----------------------------------------------------------------------------------------------------------------------------------------------|
| UC06  | Система мониторинга, MongoDB, DevOps-инженер | Мониторинг распределения нагрузки       | Система непрерывно собирает метрики с каждого шарда и визуализирует их. При превышении пороговых значений отправляются алерты DevOps-команде. |
| UC07  | Балансировщик MongoDB, Администратор БД      | Автоматическое перераспределение чанков | При обнаружении дисбаланса >20% система автоматически инициирует миграцию чанков между шардами в пределах одной зоны.                         |
| UC08  | DevOps-инженер, MongoDB Cluster              | Масштабирование горячей зоны            | При устойчивой перегрузке зоны "Электроника" администратор добавляет новый шард в эту зону для распределения нагрузки.                        |
| UC09  | Система аналитики, MongoDB                   | Прогнозирование нагрузки                | Система анализирует исторические данные и тренды для предсказания будущих "горячих точек" и превентивной подготовки инфраструктуры.           |
| UC10  | Администратор БД, Config Server              | Управление зонами и балансировкой       | Администратор настраивает окна балансировки, управляет зонами и при необходимости выполняет ручное перемещение чанков.                        |

### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**
Здесь описаны нефункциональные и архитектурно значимые требования.

| **№** | **Требование**                                                                                                                                                                                                                                                   |
|:------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| U1    | Все ключевые метрики шардов должны собираться с интервалом не более 30 секунд и храниться минимум 30 дней для анализа трендов. Система должна предоставлять интуитивные дашборды для визуализации распределения нагрузки и быстрой идентификации проблемных зон. |
| R1    | Система должна предсказывать потенциальные "горячие точки" за 24 часа до критической нагрузки с точностью >75%. Должна обеспечиваться доступность системы мониторинга 99.9% для своевременного обнаружения и предотвращения сбоев.                               |
| P1    | Система должна выявлять "горячий" шард в течение 5 минут после превышения пороговых значений и автоматически инициировать корректирующие действия. Критические алерты должны доставляться в течение 2 минут.                                                     |
| P2    | Операции балансировки не должны увеличивать latency операций более чем на 10% и должны выполняться преимущественно в периоды низкой нагрузки. Миграция чанков должна использовать throttling для минимизации влияния на производительность.                      |
| S1    | Не менее 80% случаев дисбаланса должны устраняться автоматически без участия администратора. Система должна предоставлять детальные логи и runbooks для диагностики и устранения оставшихся 20% инцидентов вручную.                                              |

### <a name="_qmphm5d6rvi3"></a>**Решение**
#### Контекст

После внедрения шардирования с использованием зон для категории "Электроника" обнаружилось, что даже выделенный высокопроизводительный шард (Shard 3) испытывает перегрузку, обрабатывая 70% всех запросов к коллекции `products`. Это создает следующие риски:
* Деградация производительности для самой важной категории товаров
* Неэффективное использование ресурсов других шардов (Shard 1, 2)
* Риск каскадных отказов при пиковых нагрузках типа "чёрной пятницы"
* Увеличение latency для операций с популярными товарами

#### Логика принятия решений и выбор технологий
Внедряется двухуровневая система мониторинга с использованием стека Prometheus + Grafana + AlertManager:

#### 1.1. Метрики уровня MongoDB

| **Метрика**                       | **Источник/Команда**                        | **Пороговые значения**      | **Действие при превышении** |
|:----------------------------------|:--------------------------------------------|:----------------------------|:----------------------------|
| Распределение чанков              | `sh.status()`                               | Отклонение >20% от среднего | Запуск автобалансировки     |
| Очередь операций                  | `db.serverStatus().globalLock.currentQueue` | total >100 за 5 мин         | Алерт + анализ нагрузки     |
| 95-процентильная Latency операций | `db.serverStatus().opLatencies`             | reads/writes >200ms         | Проверка "горячих" запросов |
| Количество операций/сек           | `db.serverStatus().opcounters`              | >10000 ops/s на шард        | Рассмотреть масштабирование |
| Размер данных на шард             | `db.stats()`                                | Разница >30%                | Проверка балансировщика     |
| Активные соединения               | `db.serverStatus().connections`             | >80% от maxConnections      | Масштабирование пула        |

#### 1.2. Метрики уровня инфраструктуры

| **Метрика**        | **Источник**    | **Пороговые значения** | **Действие**                                |
|:-------------------|:----------------|:-----------------------|:--------------------------------------------|
| CPU Usage          | System metrics  | >80% sustained 5 min   | Вертикальное/горизонтальное масштабирование |
| Memory Usage       | System metrics  | >95%                   | Анализ запросов, оптимизация индексов       |
| Disk IOPS          | iostat          | >85% capacity          | Миграция на SSD или распределение I/O       |
| Network Throughput | Network metrics | >80% bandwidth         | Оптимизация топологии кластера              |
| Disk Space         | df              | >80% used              | Очистка или расширение хранилища            |

### 2. Стратегия устранения "горячих" шардов

#### 2.1. Масштабирование зоны "Электроника"

```shell
// Шаг 1: Добавление нового шарда в кластер
sh.addShard("rs4/mongo-rs4-primary:27017,mongo-rs4-secondary1:27017,mongo-rs4-secondary2:27017")

// Шаг 2: Присоединение нового шарда к "горячей" зоне
sh.addShardToZone("rs4", "ElectronicsZone")

// Шаг 3: Проверка конфигурации зон
use config
db.shards.find({ tags: "ElectronicsZone" }).pretty()

// Ожидаемый результат:
// { "_id": "rs3", "tags": ["ElectronicsZone"], ... }
// { "_id": "rs4", "tags": ["ElectronicsZone"], ... }
```

#### 2.2. Оптимизация балансировщика

```shell
// Настройка окна балансировки для минимизации влияния на производительность
use config
db.settings.updateOne(
  {_id: "balancer"},
  { 
    $set: { 
      activeWindow: { 
        start: "01:00", 
        stop: "05:00" 
      },
      _secondaryThrottle: true,
      writeConcern: {w: "majority", wtimeout: 50000}
    }
  },
  {upsert: true}
)

// Уменьшение размера чанков для лучшей гранулярности
db.settings.updateOne(
  {_id: "chunksize"},
  {$set: {value: 32}},  // 32MB вместо 64MB по-умолчанию
  {upsert: true}
)

// Включение агрессивной балансировки для горячей коллекции
sh.enableBalancing("somedb.products")
```

#### 2.3. Автоматизация реагирования

```shell
// Скрипт автоматического разделения горячих чанков
function autoSplitHotChunks() {
  const config = db.getSiblingDB("config");
  const hotChunks = config.chunks.aggregate([
    {$match: {ns: "somedb.products"}},
    { 
      $lookup: {
        from: "mongos",
        localField: "shard",
        foreignField: "_id",
        as: "shardInfo"
      }
    },
    { 
      $match: { 
        "shardInfo.operationsPerSecond": {$gt: 10000}
      }
    }
  ]);
  
  hotChunks.forEach(chunk => {
    // Находим среднюю точку для разделения
    const midPoint = {
      category: chunk.min.category,
      _id: ObjectId.createFromTime(Date.now() / 1000)
    };
    
    print(`Splitting chunk at category: ${chunk.min.category}`);
    sh.splitAt("somedb.products", midPoint);
  });
}

// Запуск через cron каждые 15 минут
// */15 * * * * mongo --quiet mongodb://mongos:27017/admin autoSplitHotChunks.js
```

### 3. Проактивные мероприятия

#### 3.1. Анализ трендов и прогнозирование

```shell
// Анализ роста нагрузки по категориям
function predictHotCategories() {
  const prediction = db.products.aggregate([
    {
      $match: {
        last_updated: {
          $gte: new Date(Date.now() - 7*24*60*60*1000) 
        }
      }
    },
    {
      $group: {
        _id: "$category",
        current_load: {$sum: "$view_count"},
        growth_rate: {
          $avg: {
            $divide: ["$weekly_views_increase", "$view_count"] 
          }
        }
      }
    },
    {
      $project: {
        category: "$_id",
        current_load: 1,
        growth_rate: 1,
        predicted_load_next_week: {
          $multiply: ["$current_load", {$add: [1, "$growth_rate"]}]
        }
      }
    },
    {
      $match: {
        predicted_load_next_week: {$gt: 100000}
      }
    },
    {$sort: {predicted_load_next_week: -1}}
  ]).toArray();
  
  return prediction;
}

// Запуск ежедневно для планирования capacity
```

#### 3.2. Оперативный мониторинг с AlertManager

```yaml
# prometheus-alerts.yml
groups:
  - name: mongodb_sharding
    interval: 30s
    rules:
      - alert: HotShardDetected
        expr: |
          (mongodb_shard_ops_per_second > 10000) 
          AND 
          (mongodb_shard_ops_per_second / avg(mongodb_shard_ops_per_second) > 1.5)
        for: 5m
        labels:
          severity: warning
          component: mongodb
        annotations:
          summary: "Hot shard detected: {{$labels.shard}}"
          description: "Shard {{$labels.shard}} processing {{$value}} ops/sec"
          
      - alert: ChunkImbalance
        expr: |
          (max(mongodb_chunks_per_shard) - min(mongodb_chunks_per_shard)) 
          / min(mongodb_chunks_per_shard) > 0.3
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Chunk distribution imbalance detected"
          
      - alert: ShardLatencyHigh
        expr: mongodb_operation_latency_p95_ms > 200
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "High latency on shard {{$labels.shard}}"
```

#### Преимущества выбранного решения

Предложенный подход обеспечивает:
* Проактивное выявление проблем до их критического проявления.
* Автоматизацию для минимизации рисков при ручном вмешательстве.
* Возможность как автоматического, так и ручного управления.
* Прозрачное проведение изменений без влияния на приложение.
* Масштабируемое добавление новых шардов в горячие зоны.

### <a name="_bjrr7veeh80c"></a>**Альтернативы**
Здесь описаны наиболее важные альтернативные решения:

| **Альтернатива**               | **Описание**                       | **Причина отказа**                                                                  |
|:-------------------------------|:-----------------------------------|:------------------------------------------------------------------------------------|
| Хешированный ключ для products | Изменить на `{category: "hashed"}` | Сделает неэффективными запросы по категориям (UC04), превратив их в scatter-gather. |
| Вертикальное масштабирование   | Увеличение CPU/RAM Shard 3         | Имеет физические пределы, не решает проблему кардинально.                           |
| Кеширование в Redis            | Добавить слой кеширования          | Поможет с чтением, но не с записью. Является дополнением, а не решением.            |
| Миграция на Cassandra          | Полный переход на другую БД        | Слишком радикально, требует полного редизайна системы.                              |

**Недостатки, ограничения, риски**

*   Повышенная сложность: архитектура становится сложнее в развертывании, управлении и мониторинге. Требуется экспертиза в администрировании шардированных кластеров.
*   Неэффективные запросы (Scatter-Gather): запросы, не использующие шард-ключ (например, поиск всех заказов со статусом "processing"), будут рассылаться на все шарды, что снижает их производительность. Требуется тщательное проектирование запросов и индексов.
*   Критичность выбора шард-ключа: неправильно выбранный шард-ключ трудно изменить. Он может привести к несбалансированному распределению данных и созданию "горячих" шардов.
*   Ограничения транзакций: транзакции, затрагивающие документы на разных шардах, более сложные и имеют более высокую задержку.
