# Настройка чтения с реплик и консистентность

## Таблица операций чтения

| Коллекция | Операция чтения | Primary/Secondary | Допустимая задержка | Обоснование |
|-----------|-----------------|-------------------|---------------------|-------------|
| **products** | Проверка остатков при добавлении в корзину | **Primary** | 0 секунд | Критично для предотвращения oversell - продажи недоступного товара |
| **products** | Получение актуальной цены для расчета заказа | **Primary** | 0 секунд | Устаревшая цена приведет к ошибкам в расчете суммы счета |
| **products** | Списание остатков при оформлении заказа | **Primary** | 0 секунд | Финальная проверка перед продажей, должна быть атомарной |
| **products** | Просмотр каталога товаров | **Secondary** | 5-10 секунд | Данные статичны, обновляются редко |
| **products** | Поиск товаров по фильтрам | **Secondary** | 5-10 секунд | Небольшая задержка не влияет на пользовательский опыт |
| **products** | Аналитические отчеты по остаткам | **Secondary** | 30-60 секунд | Для аналитики не требуется real-time данных |
| **orders** | Создание нового заказа | **Primary** | 0 секунд | Операция записи, требует немедленной консистентности |
| **orders** | Отображение статуса текущего заказа | **Primary** | 0-5 секунд | Пользователь должен видеть актуальный статус для доверия к сервису |
| **orders** | Поиск заказа сразу после создания | **Primary** | 0 секунд | Пользователь ожидает увидеть свой заказ немедленно |
| **orders** | Просмотр истории заказов | **Secondary** | 5-10 секунд | Данные статичны после завершения заказа |
| **orders** | Аналитические отчеты по продажам | **Secondary** | 30-60 секунд | Для аналитики допустима задержка |
| **orders** | Поиск заказов администратором | **Secondary** | 10-15 секунд | Административные операции менее критичны |
| **carts** | Получение активной корзины пользователя | **Primary** | 0 секунд | Корзина часто обновляется, нужны актуальные данные |
| **carts** | Добавление/удаление товаров из корзины | **Primary** | 0 секунд | Операции записи, требуют немедленной консистентности |
| **carts** | Просмотр корзины перед оформлением | **Primary** | 0 секунд | Должны быть актуальные цены и наличие товаров |
| **carts** | Поиск заброшенных корзин для маркетинга | **Secondary** | 60-300 секунд | Маркетинговые операции не требуют real-time данных |

## Допустимая задержка репликации

### Уровни консистентности:

**Строгая консистентность (0 секунд):**
- Все операции записи и критичные операции чтения
- Проверка остатков товаров, цены, статусы заказов, активные корзины
- Гарантирует отсутствие финансовых потерь и негативного UX

**Умеренная консистентность (5-15 секунд):**
- История заказов, каталог товаров, административные запросы
- Баланс между производительностью и актуальностью данных

**Слабая консистентность (30+ секунд):**
- Аналитические отчеты, маркетинговые рассылки
- Данные для бизнес-анализа, где real-time не требуется

## Обоснование выбора

### Критичные операции на Primary:

**Products:**
- **Проверка остатков** - предотвращает oversell, что критично для финансовой целостности
- **Получение цен** - устаревшие цены приводят к ошибкам расчета и недовольству клиентов

**Orders:**
- **Статус заказа** - пользователь должен видеть актуальный статус для доверия к сервису
- **Создание заказа** - требует атомарности и немедленной консистентности

**Carts:**
- **Активные корзины** - частые изменения требуют строгой консистентности
- **Операции изменения** - запись всегда на primary для предотвращения конфликтов

### Операции на Secondary:

**Каталог товаров** - данные меняются редко (раз в день/неделю)
**История заказов** - завершенные заказы не изменяются
**Аналитика** - допускает задержку для разгрузки primary

### Риски и их минимизация:

1. **Продажа недоступного товара** - все проверки остатков на primary
2. **Устаревшие цены** - расчеты только с primary реплики
3. **Некорректный статус заказа** - чтение статуса с primary
4. **Рассинхронизация корзины** - все операции с активными корзинами на primary

Данная стратегия обеспечивает баланс между производительностью системы и требованиями бизнес-логики, минимизируя риски финансовых потерь и негативного пользовательского опыта.