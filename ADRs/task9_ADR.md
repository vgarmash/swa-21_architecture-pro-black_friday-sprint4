### <a name="_b7urdng99y53"></a>**Название:** Настройка чтения с реплик и консистентность
### <a name="_b7urdng99y53"></a>**Номер записи:** 3
### <a name="_hjk0fkfyohdk"></a>**Автор:** Дубовик Сергей Андреевич
### <a name="_hjk0fkfyohdk"></a>**Исполнитель:** Старший разрабочтик номер 3
### <a name="_uanumrh8zrui"></a>**Дата:** 02.08.2025
### <a name="_qmphm5d6rvi3"></a>**Контекст**
Из-за возросшей на систему нагрузки необходимо определить, можем ли мы перенаправить часть запросов на чтение в реплики. Необходим список операций для primary и secondary-реплик с обоснованием для последующего перенаправления запросов.

### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**

|**№**|**Требование**| **Описание** |
| :-: | :- | :-: |
|1| Data Consistency | Необходимо соблюсти требования консистености данных при обращении к репликам, определена максимальная задержка eventual consistency в 500 мс|

---
### <a name="_qmphm5d6rvi3"></a>**Решение**

|**№**|**Таблица**|**Операция**| **Тип инстанса** | **Обоснование** |
| :-: | :-: | :- | :-: | :-: |
|1| product | Поиск по фильтрам | Secondary + Cache | Средняя важность консистентности, частое чтение, можно даже закешировать (если хватит ОЗУ). Допустимая задержка ~1-2 секунды. Риск показать товар, которого нет. "Горячие" товары при этом нужно закешировать, чтобы не выводить пользователям ошибок несуществующего товара на последующих шагах. Если закешировать нет возможности, то Primary. |
|2| product | Получение карточки товара | Secondary | Более критично, чем поиск по фильтрам, желательно соблюдать консистентность по SLA, но есть возможность смягчить разницу в данных на последующих шагах (например, при оплате в разделе "подтверждения"), кроме того, атрибуты товара меняются редко. |
|3| product | Проверка наличия товара | Primary | Критично по консистентности, чтобы не продать несуществующий товар и не заниматься возвратом средств или обработкой ошибок по товарам |
|4| order | Получение истории заказов | Secondary | Редкочитаемые данные. Некритично в контексте строгой консистентности, пользователь может подождать появление нового заказа 5-10 секунд (если не оговорено обратного в SLA) |
|5| order | Отображение статуса активного заказа | Primary/Secondary | Средняя частота чтения. Зависит от механизмов идемпотентности в системе и обработки ответов в UI (лодеры и блокировка, где необходимы), чтобы пользователь не совершил повторных изменений в бд. Если все написано правильно и исключены повторные операции с деньгами, то можно переключить на Secondary. |
|6| carts | Получение корзины | Primary/Secondary | Зависит от текущего кода и наличия идемпотентости. Можно оставить на Primary, чтобы не добавить один и тот же товар параллельно. Допустимая задержка соизмерима со временем отлика нажатия на кнопку заказа - т.е. минимальна (50-100мс). |
|7| carts | Просмотр заброшенных корзин (abandoned статус) | Secondary | Данные читаются реже остальных. Неважно в контексе строгой консистентности, допустимая задержка  ~10 секунд. |

Часть решения зависит от текущей кодовой базы и обработки исключительных операций, особенно, если речь идет про заказ. Строгая консистентность рекомендуется на всех операциях, где возможны неверные расчеты стоимости или повторные списания средств. Ситуацию при невозможности достижения строгой консистености может сгладить дополнительный шаг с подтверждением данных заказа (+время на синхронзацию), идемпотентность, UI-locking.